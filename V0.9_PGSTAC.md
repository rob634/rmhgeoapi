# V0.9 pgSTAC Alignment — Epoch 4 → Epoch 5 Patterns

**Created**: 16 FEB 2026
**Updated**: 18 FEB 2026
**Status**: IN PROGRESS — Phase 1 + Phase 3 COMPLETE (see V0.9_PGSTAC_TODO.md)
**Goal**: Rebuild rmhgeoapi (Epoch 4) STAC layer to match rmhdagmaster (Epoch 5) patterns.
Both apps write to the same pgstac schema — items must be structurally compatible.

---

## 1. Executive Summary

Epoch 5 (rmhdagmaster) has completed its STAC enrichment redesign (Phase R3, all 15 tasks DONE).
It produces STAC items using **5 standard extensions + 6 custom properties + 4 B2B passthrough
properties**, eliminating 20+ custom `app:*` and `azure:*` properties that Epoch 4 currently uses.

This document maps every delta and proposes implementation options for Epoch 4 alignment.

### Net Change

| Metric | Epoch 4 (Current) | Epoch 5 (Target) |
|--------|-------------------|-------------------|
| Custom properties | **30+** (`app:*`, `azure:*`, `platform:*`, `geo:*`) | **10** (`geoetl:*` + `ddh:*`) |
| Standard STAC extensions | 1-2 (proj, partial raster) | **5** (proj, raster, file, render, processing) |
| Asset href format | Mixed HTTPS/`/vsiaz/` | **`/vsiaz/` only** |
| Visualization config | 3 custom properties | **STAC Renders Extension** (standard) |
| STAC libraries | pystac + stac-pydantic + rio-stac | **Plain dicts** |

---

## 2. Epoch 5 Authoritative Source Files

All patterns are fully implemented in rmhdagmaster. These are the reference files:

| File | What It Defines |
|------|-----------------|
| `docs/STAC_ENRICHMENT_PLAN.md` | Full spec — property mapping, target JSON, extension strategy |
| `core/models/stac_properties.py` | `geoetl:*` and `ddh:*` namespace models (117 lines) |
| `handlers/raster/stac.py` | Item builder — lines 443-629 show exact STAC item structure |
| `handlers/raster/statistics.py` | Renders builder — `properties.renders`, colormap/rescale logic |
| `infrastructure/pgstac.py` | Repository — collection/item CRUD using plain dicts |
| `infrastructure/pgstac_search.py` | Search registration — TiTiler URL patterns |
| `workflows/raster_ingest.yaml` | Pipeline flow showing data flow between nodes |

### Documentation Gaps in Epoch 5

| Gap | Impact on Epoch 4 | Mitigation |
|-----|-------------------|------------|
| No pgstac schema migration docs | Low — both use pypgstac 0.9.x, Epoch 4 already has `PgStacBootstrap` | Epoch 4 keeps its existing bootstrap |
| No collection lifecycle docs | Medium — handler creates on-demand but pattern not documented | Copy pattern from `stac_ensure_collection` handler |
| No env var docs (DAG_PGSTAC_URL, DAG_TITILER_URL) | Low — Epoch 4 uses config objects not env vars | Map to existing `config.titiler_base_url` etc. |
| No item migration strategy | N/A — all existing pgstac data is dev/test | Rebuild from scratch (see Option A below) |

---

## 3. Property Mapping — What Changes

### 3.1 Namespace Renames

| Epoch 4 Property | Epoch 5 Property | Action |
|-----------------|------------------|--------|
| `platform:dataset_id` | `ddh:dataset_id` | **Rename prefix** |
| `platform:resource_id` | `ddh:resource_id` | **Rename prefix** |
| `platform:version_id` | `ddh:version_id` | **Rename prefix** |
| `platform:access_level` | `ddh:access_level` | **Rename prefix** |
| `platform:request_id` | *(dropped)* | **Delete** — internal, not B2B |
| `platform:client` | *(dropped)* | **Delete** — always "ddh" |

### 3.2 Replaced by Standard Extensions

| Epoch 4 Custom | STAC Standard Replacement | Extension |
|----------------|--------------------------|-----------|
| `app:dtype` | `raster:bands[].data_type` (on asset) | Raster v1.1.0 |
| `app:band_count` | Implicit: `len(raster:bands)` | Raster v1.1.0 |
| `app:nodata` | `raster:bands[].nodata` (on asset) | Raster v1.1.0 |
| `app:rescale` | `renders.default.rescale` (in properties) | Render v2.0.0 |
| `app:colormap` | `renders.default.colormap_name` | Render v2.0.0 |
| `app:rgb_bands` | `renders.default.bidx` | Render v2.0.0 |
| `azure:size_mb` | `file:size` (bytes, on asset) | File v2.1.0 |
| *(missing)* | `file:checksum` (multihash, on asset) | File v2.1.0 |
| `app:job_type` | `processing:lineage` | Processing v1.2.0 |
| `app:created_by` | `processing:software` | Processing v1.2.0 |
| *(partial)* | `proj:bbox`, `proj:shape`, `proj:transform` | Projection v1.0.0 |

### 3.3 Deleted — Redundant with `/vsiaz/` href

| Epoch 4 Custom | Why Redundant |
|----------------|---------------|
| `azure:container` | Parseable from `/vsiaz/{container}/{blob}` href |
| `azure:blob_path` | Parseable from `/vsiaz/{container}/{blob}` href |
| `azure:tier` | Derivable from container name convention |
| `azure:content_type` | Already in `assets.data.type` |
| `azure:etag` | Not needed in STAC item |
| `azure:statistics_extracted` | Replaced by `geoetl:statistics_extracted` |

### 3.4 Surviving as Custom Properties (geoetl:*)

| Property | Purpose | Why No Standard Exists |
|----------|---------|----------------------|
| `geoetl:job_id` | Which processing job created this | No STAC standard for job IDs |
| `geoetl:managed_by` | Which system manages this item | Multi-producer catalog identity |
| `geoetl:epoch` | Processing system version | Internal versioning concept |
| `geoetl:raster_type` | Domain classification (dem, rgb, categorical...) | No STAC standard for domain type |
| `geoetl:processing_seconds` | How long processing took | No standard for timing |
| `geoetl:statistics_extracted` | Whether band stats were computed | Size-gating decision flag |

### 3.5 Open Question: geo:* Properties

| Property | Epoch 4 | Epoch 5 | Decision Needed |
|----------|---------|---------|-----------------|
| `geo:iso3` | Yes (ISO3AttributionService) | Not yet | Keep in Epoch 4? Both apps share pgstac |
| `geo:primary_iso3` | Yes | Not yet | Same question |
| `geo:countries` | Yes | Not yet | Same question |

**Recommendation**: Keep `geo:*` — it adds value, doesn't conflict with any standard, and
Epoch 5 may adopt it later. It's additive, not breaking.

### 3.6 Open Question: postgis:* Properties (Vectors)

Epoch 5 is raster-only. Epoch 4 has vector ETL that produces `postgis:*` properties.
These have no Epoch 5 equivalent and no STAC standard equivalent.

**Recommendation**: Keep `postgis:*` for vectors. They're orthogonal to the raster alignment.

---

## 4. Target STAC Item Structure (Epoch 5 Canonical)

From `rmhdagmaster/handlers/raster/stac.py:_build_stac_item()`:

```json
{
  "type": "Feature",
  "stac_version": "1.0.0",
  "stac_extensions": [
    "https://stac-extensions.github.io/projection/v1.0.0/schema.json",
    "https://stac-extensions.github.io/raster/v1.1.0/schema.json",
    "https://stac-extensions.github.io/file/v2.1.0/schema.json",
    "https://stac-extensions.github.io/processing/v1.2.0/schema.json",
    "https://stac-extensions.github.io/render/v2.0.0/schema.json"
  ],
  "id": "flood_risk_2024_cog",
  "collection": "flood-risk-collection",
  "geometry": { "type": "Polygon", "coordinates": [...] },
  "bbox": [71.6, 40.9, 71.7, 41.0],

  "properties": {
    "datetime": "2026-02-15T12:00:00Z",
    "title": "Flood Risk 2024",
    "tags": ["flood", "hazard"],

    "proj:epsg": 4326,
    "proj:bbox": [71.6, 40.9, 71.7, 41.0],
    "proj:shape": [3601, 3601],
    "proj:geometry": { "type": "Polygon", "coordinates": [...] },
    "proj:transform": [0.000277, 0, 71.6, 0, -0.000277, 41.0],

    "processing:lineage": "raster_ingest pipeline",
    "processing:software": { "geoetl": "0.1.20.0" },

    "renders": {
      "default": {
        "title": "Terrain visualization",
        "assets": ["data"],
        "rescale": [[-100, 9733]],
        "colormap_name": "terrain"
      },
      "grayscale": {
        "title": "Grayscale",
        "assets": ["data"],
        "rescale": [[-100, 9733]]
      }
    },

    "geoetl:job_id": "j-abc123",
    "geoetl:managed_by": "rmhazuregeoapi",
    "geoetl:epoch": 4,
    "geoetl:raster_type": "dem",
    "geoetl:processing_seconds": 45.2,
    "geoetl:statistics_extracted": true,

    "ddh:dataset_id": "d-12345",
    "ddh:resource_id": "r-67890",
    "ddh:version_id": "v-1",
    "ddh:access_level": "ouo",

    "geo:iso3": ["UZB"],
    "geo:primary_iso3": "UZB",
    "geo:countries": ["Uzbekistan"]
  },

  "assets": {
    "data": {
      "href": "/vsiaz/silver-cogs/flood_risk_2024_cog.tif",
      "type": "image/tiff; application=geotiff; profile=cloud-optimized",
      "title": "Cloud-Optimized GeoTIFF",
      "roles": ["data"],
      "file:size": 14018150,
      "file:checksum": "1220a1b2c3d4e5f6...",
      "raster:bands": [
        {
          "data_type": "float32",
          "nodata": -9999.0,
          "statistics": {
            "minimum": -100.5,
            "maximum": 8848.0,
            "mean": 1245.3,
            "stddev": 892.1,
            "valid_percent": 95.2
          }
        }
      ]
    },
    "thumbnail": {
      "href": "https://titiler.../cog/preview.png?url=%2Fvsiaz%2F...&max_size=256",
      "type": "image/png",
      "roles": ["thumbnail"],
      "title": "Thumbnail preview"
    }
  },

  "links": [
    { "rel": "collection", "href": ".../collections/flood-risk-collection" },
    { "rel": "self", "href": ".../collections/flood-risk-collection/items/flood_risk_2024_cog" },
    { "rel": "preview", "href": "https://titiler.../cog/WebMercatorQuad/map.html?url=..." },
    { "rel": "tilejson", "href": "https://titiler.../cog/WebMercatorQuad/tilejson.json?url=..." }
  ]
}
```

**Note**: `geoetl:managed_by` = `"rmhazuregeoapi"` (not `"dagapp"`) when produced by this app.
`geoetl:epoch` = `4` when produced by this app. This distinguishes producers in the shared catalog.

---

## 5. Files That Must Change in rmhgeoapi

### 5.1 Models (Replace)

| Current File | Action | Notes |
|-------------|--------|-------|
| `core/models/stac.py` (664 lines) | **Major rewrite** | Replace `PlatformProperties`, `AppProperties`, `AzureProperties` with `geoetl:*`/`ddh:*` models. Keep `GeoProperties`, `PostGISProperties`, `STACItemCore`. Drop `STACItemProperties` composite. |

**New model structure** (aligned with `rmhdagmaster/core/models/stac_properties.py`):

```python
APP_PREFIX = "geoetl"  # Single point of change

class ProvenanceProperties:   # geoetl:* (6 fields)
class PlatformProperties:     # ddh:* (4 fields, Pydantic aliases)
class GeoProperties:          # geo:* (KEEP — not in Epoch 5 yet)
class PostGISProperties:      # postgis:* (KEEP — vector only)

# Extension URL constants
STAC_EXT_PROJECTION = "https://stac-extensions.github.io/projection/v1.0.0/schema.json"
STAC_EXT_RASTER = "https://stac-extensions.github.io/raster/v1.1.0/schema.json"
STAC_EXT_FILE = "https://stac-extensions.github.io/file/v2.1.0/schema.json"
STAC_EXT_RENDER = "https://stac-extensions.github.io/render/v2.0.0/schema.json"
STAC_EXT_PROCESSING = "https://stac-extensions.github.io/processing/v1.2.0/schema.json"
```

### 5.2 Services (Major Rewrite)

| Current File | Lines | Action | Notes |
|-------------|-------|--------|-------|
| `services/service_stac_metadata.py` | 724 | **Rewrite item builder** | Replace scattered construction with single `_build_stac_item()` function. Drop rio-stac's property inflation, keep its geometry/bbox extraction. Always `/vsiaz/` hrefs. |
| `services/stac_metadata_helper.py` | 1019 | **Rewrite or merge** | `augment_item()` is the right pattern but builds wrong properties. Rewrite to produce Epoch 5 property structure. Consider merging into `service_stac_metadata.py`. |
| `services/pgstac_search_registration.py` | 301 | **Minor update** | Works correctly. Update SHA256→MD5 hash if needed (Epoch 5 uses `ON CONFLICT (hash)` directly). |

### 5.3 Infrastructure (Minor)

| Current File | Action | Notes |
|-------------|--------|-------|
| `infrastructure/pgstac_repository.py` | **Accept plain dicts** | Currently requires `pystac.Item` or `stac_pydantic.Item`. Epoch 5 uses plain dicts. Add dict acceptance path. |
| `infrastructure/pgstac_bootstrap.py` | **Keep as-is** | pgstac schema installation stays — Epoch 5 has no equivalent. |

### 5.4 Renders Builder (New)

Epoch 4 has no equivalent of `rmhdagmaster/handlers/raster/statistics.py:_build_renders()`.
This function builds the `properties.renders` object from band statistics.

**Options**:
- A) Copy Epoch 5's `_build_renders()` into a new `services/stac_renders.py`
- B) Inline it into the rewritten `service_stac_metadata.py`

### 5.5 Triggers / Handlers (Consumers)

Files that call `StacMetadataService` or `STACMetadataHelper` and will need interface updates:

| File | Impact |
|------|--------|
| All raster ETL job handlers | Pass new params, receive new item structure |
| `services/stac_catalog.py` | Uses `StacMetadataService` for bulk extraction |
| `services/service_stac_vector.py` | Vector cataloging — keep `postgis:*` but align base structure |
| `triggers/stac/stac_bp.py` | API responses may expose property names |
| Approval service | Currently reads `app:published` — needs migration |

### 5.6 B2B Query Migration

| Query | Current Filter | New Filter |
|-------|---------------|------------|
| `search_by_platform_ids()` | `"platform:dataset_id"` | `"ddh:dataset_id"` |
| `get_items_by_platform_dataset()` | `content->'properties'->>'platform:dataset_id'` | `content->'properties'->>'ddh:dataset_id'` |

---

## 6. Implementation Options

### Option A: Clean Break (RECOMMENDED)

**All existing pgstac data is dev/test. Rebuild from scratch.**

1. Rewrite `core/models/stac.py` with Epoch 5 namespace models
2. Rewrite `service_stac_metadata.py` item builder to produce Epoch 5 structure
3. Add renders builder (from Epoch 5 `statistics.py`)
4. Update `pgstac_repository.py` to accept plain dicts alongside pystac/stac-pydantic
5. Update `stac_metadata_helper.py` to use new property models
6. Update B2B queries (`platform:*` → `ddh:*`)
7. Update all consumers (handlers, triggers, approval service)
8. Nuke existing pgstac data, re-ingest

**Pros**: Clean, no migration complexity, matches Epoch 5 exactly
**Cons**: Must re-ingest all data (acceptable for dev/test)
**Effort**: ~3-5 days
**Risk**: Low — no production data

### Option B: Incremental Migration

Keep existing item builder, add a translation layer that converts Epoch 4 items to Epoch 5
format on write. Migrate existing items with a SQL script.

**Pros**: No re-ingest required
**Cons**: Two code paths, translation layer adds complexity, violates "no backward compat" rule
**Effort**: ~5-8 days (more complex)
**Risk**: Medium — translation bugs, drift between paths

### Option C: Parallel Producers

Both Epoch 4 and Epoch 5 write to pgstac independently. Add `geoetl:managed_by` to
distinguish producers. Epoch 4 continues with old format, new format only for new items.

**Pros**: Zero disruption to existing items
**Cons**: Two item formats in same catalog, downstream consumers must handle both,
violates the alignment goal
**Effort**: ~1-2 days (minimal changes)
**Risk**: High — format drift, confusion

### Recommendation: Option A

Per CLAUDE.md: *"This is a development environment — never create fallbacks that mask breaking changes."*

All pgstac data is test data. Option A gives the cleanest result with the least ongoing
maintenance. The `action=rebuild&target=pgstac` endpoint already exists for this purpose.

---

## 7. Implementation Plan (Option A)

### Phase 1: Models + Constants (Day 1)

| Step | File | Change |
|------|------|--------|
| 1.1 | `core/models/stac.py` | Add `APP_PREFIX`, `ProvenanceProperties`, extension URL constants |
| 1.2 | `core/models/stac.py` | Rename `PlatformProperties` aliases from `platform:*` to `ddh:*`, drop `request_id`/`client` |
| 1.3 | `core/models/stac.py` | Delete `AppProperties`, `AzureProperties`, `STACItemProperties` composite |
| 1.4 | `core/models/stac.py` | Keep `GeoProperties`, `PostGISProperties`, `STACItemCore`, `AccessLevel` |

### Phase 2: Item Builder (Day 2)

| Step | File | Change |
|------|------|--------|
| 2.1 | `services/service_stac_metadata.py` | Rewrite `extract_item_from_blob()` to produce Epoch 5 item structure |
| 2.2 | `services/service_stac_metadata.py` | Always `/vsiaz/` hrefs (remove HTTPS→vsiaz conversion step) |
| 2.3 | `services/service_stac_metadata.py` | Add full `proj:*` suite (bbox, shape, transform, geometry) |
| 2.4 | `services/service_stac_metadata.py` | Add `processing:lineage/software` |
| 2.5 | `services/service_stac_metadata.py` | Build `raster:bands[]` on asset with statistics |
| 2.6 | New: `services/stac_renders.py` | Port `_build_renders()` from Epoch 5 statistics handler |
| 2.7 | `services/service_stac_metadata.py` | Add `properties.renders` from renders builder |
| 2.8 | `services/service_stac_metadata.py` | Use `ProvenanceProperties.to_prefixed_dict()` for `geoetl:*` |
| 2.9 | `services/service_stac_metadata.py` | Use `PlatformProperties.model_dump(by_alias=True)` for `ddh:*` |

### Phase 3: Infrastructure + Helper (Day 3)

| Step | File | Change |
|------|------|--------|
| 3.1 | `infrastructure/pgstac_repository.py` | Accept plain dicts in `insert_item()` / `insert_collection()` |
| 3.2 | `infrastructure/pgstac_repository.py` | Update B2B queries: `platform:*` → `ddh:*` |
| 3.3 | `services/stac_metadata_helper.py` | Rewrite `augment_item()` to use new models |
| 3.4 | `services/stac_metadata_helper.py` | Delete `AzureProperties`-related methods |
| 3.5 | `services/stac_metadata_helper.py` | TiTiler URL builder reads from `renders.default` instead of custom props |

### Phase 4: Consumers + Testing (Day 4-5)

| Step | File | Change |
|------|------|--------|
| 4.1 | All raster ETL handlers | Update calls to item builder |
| 4.2 | `services/service_stac_vector.py` | Align base structure, keep `postgis:*` |
| 4.3 | Approval service | Migrate `app:published` → alternative mechanism |
| 4.4 | `triggers/stac/stac_bp.py` | Verify API responses use new property names |
| 4.5 | Unit tests | Adapt existing, add Epoch 5 structure validation |
| 4.6 | Deploy + nuke pgstac | `action=rebuild&target=pgstac`, re-ingest test data |

---

## 8. Compatibility Contract

After implementation, both apps produce items matching this contract:

| Field | Required | Source |
|-------|----------|--------|
| `stac_version` | `"1.0.0"` | Constant |
| `stac_extensions` | 5 URLs (proj, raster, file, processing, render) | Constants |
| `assets.data.href` | `/vsiaz/{container}/{blob}` | Always |
| `assets.data.raster:bands` | Array of `{data_type, nodata, statistics}` | Raster extension |
| `assets.data.file:size` | Bytes (integer) | File extension |
| `assets.data.file:checksum` | `1220...` multihash | File extension |
| `properties.proj:*` | epsg, bbox, shape, geometry, transform | Projection extension |
| `properties.processing:*` | lineage, software | Processing extension |
| `properties.renders` | `{default: {assets, rescale, colormap_name, bidx}}` | Render extension |
| `properties.geoetl:*` | 6 custom properties | `ProvenanceProperties` |
| `properties.ddh:*` | 4 B2B passthrough | `PlatformProperties` |
| `properties.geo:*` | ISO3 attribution (Epoch 4 only, for now) | `GeoProperties` |

**Distinguishing producers**:
- `geoetl:managed_by = "rmhazuregeoapi"` (Epoch 4)
- `geoetl:managed_by = "geoetl"` (Epoch 5 / DAG app)
- `geoetl:epoch = 4` vs `geoetl:epoch = 5`

---

## 9. pgstac Schema — No DDL Changes

The pgstac schema itself (`pypgstac 0.9.x`) does **not** need any DDL changes.
pgstac stores items as JSONB — the property structure is application-level, not schema-level.

| Component | Status |
|-----------|--------|
| `pgstac.collections` table | Unchanged |
| `pgstac.items` table | Unchanged (JSONB content) |
| `pgstac.searches` table | Unchanged |
| `pgstac.upsert_collection()` | Unchanged |
| `pgstac.upsert_item()` | Unchanged |
| pypgstac version | Both apps: 0.9.x (compatible) |
| `PgStacBootstrap` | Keep as-is — still needed for schema install |

The changes are entirely in the **application layer** — what JSON structure goes into
the JSONB `content` column. pgstac is schema-agnostic by design.

### app Schema DDL Changes

The `app` schema tables that reference STAC properties may need updates:

| Table | Column/Query | Change |
|-------|-------------|--------|
| `app.geospatial_assets` | `approval_state` logic | Check if `app:published` is referenced |
| B2B lookup queries | `platform:dataset_id` | → `ddh:dataset_id` |
| Any JSONB queries on `content->'properties'` | `platform:*` keys | → `ddh:*` keys |

---

## 10. Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Missing a consumer of old property names | Medium | Low | Grep for `platform:`, `app:`, `azure:` across codebase |
| Approval service breaks (`app:published`) | High | Medium | Design new approval mechanism before migration |
| TiTiler URL generation breaks | Low | High | Renders extension is the standard — TiTiler reads natively |
| B2B lookups break | High | Medium | Update all `platform:*` → `ddh:*` queries atomically |
| Vector items incompatible | Low | Low | Vector items keep `postgis:*`, only base structure changes |

---

## 11. Decisions (LOCKED 16 FEB 2026)

| # | Decision | Answer | Rationale |
|---|----------|--------|-----------|
| 1 | APP_PREFIX | `"geoetl"` — same for both apps | Differentiate via `geoetl:managed_by` and `geoetl:epoch` |
| 2 | `geo:*` properties | **Keep** | B2C relevant — enables spatial discovery by country (ISO3 attribution) |
| 3 | Approval workflow | **Remove from STAC entirely** | Approval is access control, not metadata. Managed in `app` schema. |
| 4 | Version | No bump yet | Still planning |
| 5 | Timing | Still planning | Plan first, implement after |

### Approval Flow (Clarified)

STAC is a **B2C concern only** — only consumer-relevant fields belong in STAC items.

The item lifecycle:

1. **STAC item created** at ingest — needed for TiTiler to render previews during review
2. **Approval managed in `app` schema** — `app.geospatial_assets` or equivalent table
3. **API layer controls visibility** — unapproved items exist in pgstac but are not exposed publicly

Key principle: the STAC item itself is always a complete, standards-compliant record.
Approval state is not a property on the item — it's an **access control gate** at the API layer.
`app:published` is removed entirely, not replaced.

### What Belongs in STAC (B2C Test)

| Namespace | B2C? | Verdict |
|-----------|------|---------|
| `geoetl:*` (provenance) | Yes — lineage transparency | **Keep** |
| `ddh:*` (platform IDs) | Yes — cross-system lookup | **Keep** |
| `geo:*` (country attribution) | Yes — spatial discovery | **Keep** |
| Standard extensions (proj, raster, file, render, processing) | Yes — interoperability | **Keep** |
| `app:*` (job internals) | No — processing state | **Remove** |
| `azure:*` (storage internals) | No — infrastructure | **Remove** |
| `app:published` (approval state) | No — access control | **Remove** |
