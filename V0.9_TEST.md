# V0.9 QA Test Sequence

**Last Updated**: 24 FEB 2026
**Base URL**: `https://rmhazuregeoapi-a3dma3ctfdgngwf6.eastus-01.azurewebsites.net`
**Architecture**: V0.9 Asset/Release two-entity model

---

## What V0.9 Changes

| Aspect | V0.8 (TEST_SEQUENCE.md) | V0.9 (this file) |
|--------|-------------------------|-------------------|
| **Entity model** | Monolithic "asset" | Asset (identity) + Release (versioned artifact) |
| **Approval target** | asset_id | release_id (preferred), with fallback lookups |
| **Multi-version** | Blocked (DraftBlockedError) | Coexisting approved + draft is normal |
| **Revoke-first** | Required before v2 | Not required — submit v2 directly |
| **Ordinal** | Assigned at approval | Reserved at draft creation |
| **COG path** | `…/draft/…` | `…/{ordinal}/…` (e.g., `…/1/…`, `…/2/…`) |
| **Vector table** | `*_draft` | `*_ord1`, `*_ord2` (ordinal-based) |
| **STAC item ID** | `*-draft` | `*-ord1`, `*-ord2` (ordinal-based, finalized at approval) |

---

## Test Runs

| Run | Version | Date | Focus | Tests | All Pass |
|-----|---------|------|-------|-------|----------|
| 1 | 0.8.23.0 | 23 FEB 2026 | Vector ordinal naming, api_requests upsert, full lifecycle | A1-A11, B1-B6, C1-C3, D1-D3, E1-E4, F1-F4, G1-G4 (31 tests) | YES |
| 2 | 0.8.24.0 | 23 FEB 2026 | Status restructuring, auto-detect lookups, `?detail=full` | A1-A12, B1-B6, C1-C3, D1-D3, E1-E4, F1-F4, G1-G4, H1-H5, I1 (37+ tests) | YES |
| 3 | 0.9.2.1 | 24 FEB 2026 | Full regression after STAC bugfixes, blob_path fix, UI updates | A1-A12, B1-B6, C1-C3, D1-D3, E1-E4, F1-F4, G1-G4, H1-H5, I1 (42 tests) | YES |

---

## Pre-Requisites

```bash
BASE_URL="https://rmhazuregeoapi-a3dma3ctfdgngwf6.eastus-01.azurewebsites.net"

# Set your bronze container name (environment-specific)
BRONZE_CONTAINER="<your-bronze-container-name>"

# pgSTAC nuke
curl -X POST "${BASE_URL}/api/stac/nuke?confirm=yes&mode=all"

# Schema rebuild (fresh slate)
curl -X POST "${BASE_URL}/api/dbadmin/maintenance?action=rebuild&confirm=yes"
```

### Notes on Request Fields

- **`container_name`**: The Azure Blob Storage container holding source data. Environment-specific — use `${BRONZE_CONTAINER}` throughout.
- **`data_type`**: NOT a request field. Auto-detected from `file_name` extension (`.tif` -> raster, `.gpkg` -> vector). Do not include in request body.
- **`file_name`**: Path within the container. Can be a bare filename (`dctest.tif`) or include folders (`path/to/cutlines.gpkg`).

---

# SECTION A: Raster Multi-Version Lifecycle

**Goal**: Submit v1 draft -> approve -> submit v2 draft (no revoke!) -> approve v2.
Verify COG paths use ordinals (`/1/`, `/2/`), not `draft`.

---

### TEST A1: Submit Raster Draft (first version)

**Purpose**: Create first release. Verify ordinal=1 reserved at creation, COG path uses `/1/`.

```bash
curl -X POST "${BASE_URL}/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "v09-raster-test",
    "resource_id": "dctest",
    "container_name": "'"${BRONZE_CONTAINER}"'",
    "file_name": "dctest.tif"
  }'
```

**Expected**:
- HTTP 202 with `request_id`, `job_id`, `job_type`
- `monitor_url` returned (e.g., `/api/platform/status/{request_id}`)

**Capture**: `REQUEST_ID_V1`, `JOB_ID_V1`

---

### TEST A2: Poll Job Completion

```bash
curl "${BASE_URL}/api/platform/status/{REQUEST_ID_V1}"
```

**Expected**:
- `job_status`: `completed`

The status response includes a `release` object (when the release is found):
- `release.release_id` — capture as `RELEASE_ID_V1`
- `release.asset_id` — capture as `ASSET_ID`
- `release.version_ordinal`: `1` (reserved at creation, NOT null)
- `release.approval_state`: `pending_review`

---

### TEST A3: Verify COG Path Uses Ordinal

**Purpose**: Confirm COG landed at `…/v09-raster-test/dctest/1/…` not `…/draft/…`

```bash
# Check job result_data for output path
curl "${BASE_URL}/api/dbadmin/jobs/{JOB_ID_V1}" | python3 -c "
import sys, json
job = json.load(sys.stdin)
result = job.get('result_data', {})
print('output_path:', result.get('output_path', result.get('blob_path', 'NOT FOUND')))
"
```

**Expected**:
- Path contains `/1/` (ordinal), NOT `/draft/`
- Example: `silver-cogs/v09-raster-test/dctest/1/v09-raster-test_cog_analysis.tif`

---

### TEST A4: Verify pgSTAC Empty (B2C deferred)

**Purpose**: Confirm no STAC item exists yet — materialization happens at approval.

```bash
curl "${BASE_URL}/api/platform/catalog/item/v09-raster-test/v09-raster-test-dctest-ord1"
```

**Expected**: HTTP 404 — no pgSTAC item before approval

---

### TEST A5: Approve v1

**Purpose**: Approve using `release_id` (V0.9 preferred path). Verify STAC materialized.

```bash
curl -X POST "${BASE_URL}/api/platform/approve" \
  -H "Content-Type: application/json" \
  -d '{
    "release_id": "{RELEASE_ID_V1}",
    "reviewer": "claude-qa@example.com",
    "clearance_level": "ouo",
    "version_id": "v1"
  }'
```

**Expected**:
- `"success": true`
- `"approval_state": "approved"`
- `"clearance_state": "ouo"`
- `"stac_item_id": "v09-raster-test-dctest-v1"` (renamed from ord1 to v1)
- `"stac_updated": true`
- `"release_id"` in response

---

### TEST A6: Verify STAC Item Materialized

```bash
curl "${BASE_URL}/api/platform/catalog/item/v09-raster-test/v09-raster-test-dctest-v1"
```

**Expected**: HTTP 200 — STAC item exists with versioned ID

---

### TEST A7: Submit v2 Draft (NO REVOKE — coexisting versions)

**Purpose**: V0.9 flagship test. Submit new version while v1 is still approved.
Should NOT return 409 DraftBlockedError.

```bash
curl -X POST "${BASE_URL}/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "v09-raster-test",
    "resource_id": "dctest",
    "container_name": "'"${BRONZE_CONTAINER}"'",
    "file_name": "dctest.tif"
  }'
```

**Expected**:
- HTTP 202 (NOT 409!)
- New `job_id` returned (different from v1)

**Capture**: `REQUEST_ID_V2`, `JOB_ID_V2`

---

### TEST A8: Poll v2 Completion + Verify Ordinal

```bash
curl "${BASE_URL}/api/platform/status/{REQUEST_ID_V2}"
```

**Expected**:
- `job_status`: `completed`

From the `release` object in the response:
- `release.release_id` — capture as `RELEASE_ID_V2`
- `release.version_ordinal`: `2` (auto-incremented)
- `release.approval_state`: `pending_review`
- v1 release still `approved` (unchanged)

---

### TEST A9: Verify v2 COG Path Isolation

**Purpose**: v2 COG at `…/2/…`, v1 COG at `…/1/…` — no overwrite.

```bash
# v2 output path
curl "${BASE_URL}/api/dbadmin/jobs/{JOB_ID_V2}" | python3 -c "
import sys, json
job = json.load(sys.stdin)
result = job.get('result_data', {})
print('v2 output_path:', result.get('output_path', result.get('blob_path', 'NOT FOUND')))
"
```

**Expected**:
- v2 path contains `/2/` (ordinal 2)
- v1 path (from A3) contains `/1/` (ordinal 1)
- The two paths are different — v1 COG is preserved

---

### TEST A10: Approve v2

```bash
curl -X POST "${BASE_URL}/api/platform/approve" \
  -H "Content-Type: application/json" \
  -d '{
    "release_id": "{RELEASE_ID_V2}",
    "reviewer": "claude-qa@example.com",
    "clearance_level": "ouo",
    "version_id": "v2"
  }'
```

**Expected**:
- `"approval_state": "approved"`
- `"stac_item_id": "v09-raster-test-dctest-v2"`
- `"stac_updated": true`

---

### TEST A11: Verify Both Versions in Catalog

```bash
# v2 exists (latest)
curl "${BASE_URL}/api/platform/catalog/item/v09-raster-test/v09-raster-test-dctest-v2"
# Expected: HTTP 200

# v1 still exists (not revoked)
curl "${BASE_URL}/api/platform/catalog/item/v09-raster-test/v09-raster-test-dctest-v1"
# Expected: HTTP 200

# No draft items
curl "${BASE_URL}/api/platform/catalog/item/v09-raster-test/v09-raster-test-dctest-draft"
# Expected: HTTP 404

# No ord-named items (finalized to version names at approval)
curl "${BASE_URL}/api/platform/catalog/item/v09-raster-test/v09-raster-test-dctest-ord1"
# Expected: HTTP 404
```

**Expected**: v1 and v2 both live in catalog. No draft/ord orphans.

---

### TEST A12: Version History

**Purpose**: Verify version history shows both releases with correct ordinals.

```bash
curl "${BASE_URL}/api/platform/approvals?status=approved"
```

**Expected** (for this asset):

| Release | version_id | version_ordinal | is_latest | approval_state |
|---------|-----------|-----------------|-----------|----------------|
| RELEASE_ID_V1 | v1 | 1 | false | approved |
| RELEASE_ID_V2 | v2 | 2 | true | approved |

---

# SECTION B: Vector Multi-Version Lifecycle

**Goal**: Same as Section A but for vectors. Verify ordinal-based table naming
(`*_ord1`, `*_ord2`) and ordinal-based STAC IDs.

---

### TEST B1: Submit Vector Draft (first version)

**Purpose**: Verify vector draft gets ordinal-based table name (`*_ord1` not `*_draft`).

```bash
curl -X POST "${BASE_URL}/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "v09-vector-test",
    "resource_id": "cutlines",
    "container_name": "'"${BRONZE_CONTAINER}"'",
    "file_name": "0403c87a-0c6c-4767-a6ad-78a8026258db/Vivid_Standard_30_CO02_24Q2/cutlines.gpkg"
  }'
```

**Expected**: HTTP 202, job created

**Capture**: `VEC_REQUEST_ID_V1`, `VEC_JOB_ID_V1`

---

### TEST B2: Poll + Verify Ordinal Table Name

```bash
curl "${BASE_URL}/api/platform/status/{VEC_REQUEST_ID_V1}"
```

**Expected**:
- `job_status`: `completed`

From the `release` object: capture `VEC_RELEASE_ID_V1`, `VEC_ASSET_ID`.

```bash
# Check table name in job result
curl "${BASE_URL}/api/dbadmin/jobs/{VEC_JOB_ID_V1}" | python3 -c "
import sys, json
job = json.load(sys.stdin)
result = job.get('result_data', {})
print('table_name:', result.get('table_name', 'NOT FOUND'))
"
```

**Expected**:
- `table_name`: `v09_vector_test_cutlines_ord1` (NOT `*_draft`)
- `version_ordinal`: `1`

---

### TEST B3: Approve Vector v1

```bash
curl -X POST "${BASE_URL}/api/platform/approve" \
  -H "Content-Type: application/json" \
  -d '{
    "release_id": "{VEC_RELEASE_ID_V1}",
    "reviewer": "claude-qa@example.com",
    "clearance_level": "ouo",
    "version_id": "v1"
  }'
```

**Expected**:
- `"approval_state": "approved"`
- `"stac_item_id": "v09-vector-test-cutlines-v1"` (renamed from ord1)

---

### TEST B4: Submit Vector v2 (coexisting)

```bash
curl -X POST "${BASE_URL}/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "v09-vector-test",
    "resource_id": "cutlines",
    "container_name": "'"${BRONZE_CONTAINER}"'",
    "file_name": "0403c87a-0c6c-4767-a6ad-78a8026258db/Vivid_Standard_30_CO02_24Q2/cutlines.gpkg"
  }'
```

**Expected**:
- HTTP 202 (NOT 409)
- New release created with `version_ordinal=2`

**Capture**: `VEC_REQUEST_ID_V2`, `VEC_JOB_ID_V2`

---

### TEST B5: Verify v2 Table Name Isolation

```bash
curl "${BASE_URL}/api/dbadmin/jobs/{VEC_JOB_ID_V2}" | python3 -c "
import sys, json
job = json.load(sys.stdin)
result = job.get('result_data', {})
print('table_name:', result.get('table_name', 'NOT FOUND'))
"
```

**Expected**:
- v2 `table_name`: `v09_vector_test_cutlines_ord2`
- v1 table (`v09_vector_test_cutlines_ord1`) still exists — no drop

From status response: capture `VEC_RELEASE_ID_V2`.

---

### TEST B6: Approve Vector v2

```bash
curl -X POST "${BASE_URL}/api/platform/approve" \
  -H "Content-Type: application/json" \
  -d '{
    "release_id": "{VEC_RELEASE_ID_V2}",
    "reviewer": "claude-qa@example.com",
    "clearance_level": "ouo",
    "version_id": "v2"
  }'
```

**Expected**:
- `"approval_state": "approved"`
- `"stac_item_id": "v09-vector-test-cutlines-v2"`

---

# SECTION C: Release Resolution Paths

**Goal**: Verify all 5 resolution methods for `_resolve_release()`.

Uses releases created in Sections A and B.

---

### TEST C1: Resolve by release_id (preferred)

```bash
curl -X GET "${BASE_URL}/api/platform/approvals/{RELEASE_ID_V1}"
```

**Expected**: HTTP 200, release data returned

---

### TEST C2: Resolve by request_id

```bash
curl -X POST "${BASE_URL}/api/platform/approve" \
  -H "Content-Type: application/json" \
  -d '{
    "request_id": "{REQUEST_ID_V1}",
    "reviewer": "test-resolution@example.com",
    "clearance_level": "ouo",
    "version_id": "v1"
  }'
```

**Expected**: HTTP 200 or 400 (already approved) — but NOT 404.
The release was found via `request_id`.

---

### TEST C3: Resolve by dataset_id + resource_id

```bash
curl -X GET "${BASE_URL}/api/platform/approvals?status=approved"
```

**Then verify individual lookup**:

```bash
# Using the GET endpoint with identity lookup
curl "${BASE_URL}/api/platform/status?dataset_id=v09-raster-test&resource_id=dctest"
```

**Expected**: Returns status for the asset's releases

---

# SECTION D: Overwrite (Draft Revision)

**Goal**: Submit draft, overwrite with `overwrite=true`, verify revision increments.

---

### TEST D1: Submit Fresh Raster Draft

```bash
curl -X POST "${BASE_URL}/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "v09-overwrite-test",
    "resource_id": "ow-raster",
    "container_name": "'"${BRONZE_CONTAINER}"'",
    "file_name": "dctest.tif"
  }'
```

**Capture**: `OW_REQUEST_ID`, `OW_JOB_ID`

Wait for completion.

---

### TEST D2: Resubmit Same Identifiers (no overwrite — idempotent)

```bash
curl -X POST "${BASE_URL}/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "v09-overwrite-test",
    "resource_id": "ow-raster",
    "container_name": "'"${BRONZE_CONTAINER}"'",
    "file_name": "dctest.tif"
  }'
```

**Expected**: Idempotent response (existing draft returned, no new job)

---

### TEST D3: Overwrite Draft (overwrite=true)

```bash
curl -X POST "${BASE_URL}/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "v09-overwrite-test",
    "resource_id": "ow-raster",
    "container_name": "'"${BRONZE_CONTAINER}"'",
    "file_name": "dctest.tif",
    "processing_options": {"overwrite": true}
  }'
```

**Expected**:
- New `job_id` (different from D1)
- Same `release_id` (overwrite reuses existing release)
- Revision incremented (now revision=2)
- Same `version_ordinal=1` (ordinal is a reserved slot, not re-computed)

---

# SECTION E: Reject + Resubmit

**Goal**: Submit, reject, resubmit. Verify rejected release gets overwritten.

---

### TEST E1: Submit Draft

```bash
curl -X POST "${BASE_URL}/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "v09-reject-test",
    "resource_id": "rej-raster",
    "container_name": "'"${BRONZE_CONTAINER}"'",
    "file_name": "dctest.tif"
  }'
```

Wait for completion.

**Capture**: `REJ_REQUEST_ID` from submit response, `REJ_RELEASE_ID` from status response `release.release_id`.

---

### TEST E2: Reject Release

```bash
curl -X POST "${BASE_URL}/api/platform/reject" \
  -H "Content-Type: application/json" \
  -d '{
    "release_id": "{REJ_RELEASE_ID}",
    "reviewer": "claude-qa@example.com",
    "reason": "V0.9 QA test rejection"
  }'
```

**Expected**:
- `"approval_state": "rejected"`
- `"release_id"` in response

---

### TEST E3: Resubmit via Platform Resubmit

```bash
curl -X POST "${BASE_URL}/api/platform/resubmit" \
  -H "Content-Type: application/json" \
  -d '{
    "request_id": "{REJ_REQUEST_ID}"
  }'
```

**Expected**:
- `original_job_id` and `new_job_id` different
- `cleanup_summary` shows artifacts cleaned
- New job created and submitted
- `monitor_url` uses `request_id`

---

### TEST E4: Resubmitted Job Completes

```bash
curl "${BASE_URL}/api/platform/status/{REJ_REQUEST_ID}"
```

**Expected**: `job_status`: `completed`

---

# SECTION F: Revoke Approved Release

**Goal**: Approve, then revoke. Verify STAC item deleted, release terminal.

---

### TEST F1: Submit + Approve

```bash
# Submit
curl -X POST "${BASE_URL}/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "v09-revoke-test",
    "resource_id": "rev-raster",
    "container_name": "'"${BRONZE_CONTAINER}"'",
    "file_name": "dctest.tif"
  }'
```

Wait for completion. Capture `REV_RELEASE_ID` from status response `release.release_id`.

```bash
# Approve
curl -X POST "${BASE_URL}/api/platform/approve" \
  -H "Content-Type: application/json" \
  -d '{
    "release_id": "{REV_RELEASE_ID}",
    "reviewer": "claude-qa@example.com",
    "clearance_level": "ouo",
    "version_id": "v1"
  }'
```

**Expected**: `approved`, STAC item created

---

### TEST F2: Revoke

```bash
curl -X POST "${BASE_URL}/api/platform/revoke" \
  -H "Content-Type: application/json" \
  -d '{
    "release_id": "{REV_RELEASE_ID}",
    "revoker": "claude-qa@example.com",
    "reason": "V0.9 QA revoke test"
  }'
```

**Expected**:
- `"approval_state": "revoked"`
- `"stac_updated": true`
- STAC item deleted from pgSTAC

---

### TEST F3: Verify STAC Deleted

```bash
curl "${BASE_URL}/api/platform/catalog/item/v09-revoke-test/v09-revoke-test-rev-raster-v1"
```

**Expected**: HTTP 404

---

### TEST F4: Submit v2 After Revoke

**Purpose**: After revoking v1, submit v2. Verify ordinal=2 (not re-using 1).

```bash
curl -X POST "${BASE_URL}/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "v09-revoke-test",
    "resource_id": "rev-raster",
    "container_name": "'"${BRONZE_CONTAINER}"'",
    "file_name": "dctest.tif"
  }'
```

**Expected**:
- HTTP 202
- New release with `version_ordinal=2` (ordinal 1 was used by revoked v1)
- COG path: `…/2/…`

---

# SECTION G: Edge Cases

---

### TEST G1: Dry Run Validation

```bash
curl -X POST "${BASE_URL}/api/platform/submit?dry_run=true" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "v09-dry-run",
    "resource_id": "edge-case",
    "container_name": "'"${BRONZE_CONTAINER}"'",
    "file_name": "dctest.tif"
  }'
```

**Expected**:
- `"valid": true, "dry_run": true`
- `"asset_id"` present
- No release created (dry_run returns before release creation)

---

### TEST G2: Reject Validation Errors

```bash
# Missing reviewer
curl -X POST "${BASE_URL}/api/platform/reject" \
  -H "Content-Type: application/json" \
  -d '{"release_id": "fake", "reason": "test"}'
```

**Expected**: HTTP 400, `"reviewer is required"`

```bash
# Missing reason
curl -X POST "${BASE_URL}/api/platform/reject" \
  -H "Content-Type: application/json" \
  -d '{"release_id": "fake", "reviewer": "test@test.com"}'
```

**Expected**: HTTP 400, `"reason is required for audit trail"`

---

### TEST G3: Approve Validation Errors

```bash
# Missing clearance_level
curl -X POST "${BASE_URL}/api/platform/approve" \
  -H "Content-Type: application/json" \
  -d '{"release_id": "fake", "reviewer": "test@test.com", "version_id": "v1"}'
```

**Expected**: HTTP 400, `"clearance_level is required"`

```bash
# Missing version_id
curl -X POST "${BASE_URL}/api/platform/approve" \
  -H "Content-Type: application/json" \
  -d '{"release_id": "fake", "reviewer": "test@test.com", "clearance_level": "ouo"}'
```

**Expected**: HTTP 400, `"version_id is required"`

---

### TEST G4: Cannot Overwrite Approved Release

```bash
# Use an approved release from Section A
curl -X POST "${BASE_URL}/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "v09-raster-test",
    "resource_id": "dctest",
    "container_name": "'"${BRONZE_CONTAINER}"'",
    "file_name": "dctest.tif",
    "processing_options": {"overwrite": true}
  }'
```

**Expected**: This should create a new_version release (ordinal 3), NOT overwrite.
If a draft already exists at this point, it returns idempotent.
It must NOT return ReleaseStateError for an approved release — overwrite only applies to drafts.

---

# SECTION H: Auto-Detect ID Lookups (V0.9.1)

**Goal**: Verify `/api/platform/status/{id}` resolves all 4 ID types.
Uses releases created in earlier sections.

---

### TEST H1: Lookup by request_id

```bash
curl "${BASE_URL}/api/platform/status/{REQUEST_ID_V1}"
```

**Expected**: HTTP 200, clean B2B response with `asset`, `release`, `job_status`, `outputs`, `services`, `versions`

---

### TEST H2: Lookup by asset_id

```bash
curl "${BASE_URL}/api/platform/status/{ASSET_ID}"
```

**Expected**: HTTP 200 (was 404 before v0.8.24.0). Response includes latest release for this asset.

---

### TEST H3: Lookup by release_id

```bash
curl "${BASE_URL}/api/platform/status/{RELEASE_ID_V1}"
```

**Expected**: HTTP 200 (was 404 before v0.8.24.0). Response shows the specific release looked up.

---

### TEST H4: Lookup by job_id (current)

```bash
curl "${BASE_URL}/api/platform/status/{JOB_ID_V2}"
```

**Expected**: HTTP 200. Response shows the request associated with this job.

---

### TEST H5: Lookup by job_id (stale — overwritten by later submit)

```bash
curl "${BASE_URL}/api/platform/status/{JOB_ID_V1}"
```

**Expected**: HTTP 404 (expected behavior). The api_requests UPSERT overwrites job_id on resubmit, so v1's job_id no longer appears in api_requests. This is a known limitation — lookup by release_id is the reliable path for historical versions.

---

# SECTION I: `?detail=full` Parameter (V0.9.1)

**Goal**: Verify `?detail=full` appends operational detail to the clean B2B response.

---

### TEST I1: Status with `?detail=full`

```bash
curl "${BASE_URL}/api/platform/status/{REQUEST_ID_V1}?detail=full"
```

**Expected**:
- All standard B2B fields present (`asset`, `release`, `job_status`, `outputs`, `services`, `versions`)
- Additional `detail` block containing:
  - `job_id`: full job ID
  - `job_type`: e.g., `process_raster_docker`
  - `job_stage`: current stage number
  - `job_result`: full raw job output (the old ~80 line blob)
  - `task_summary`: task execution breakdown by stage
  - `urls.job_status`: `/api/jobs/status/{job_id}`
  - `urls.job_tasks`: `/api/dbadmin/tasks/{job_id}`
  - `created_at`: request creation timestamp

---

# Verification Checklist

### V0.9 Architecture Guarantees

| # | Guarantee | Tests |
|---|-----------|-------|
| 1 | COG paths use ordinal (`/1/`, `/2/`), not `draft` | A3, A9 |
| 2 | Vector tables use ordinal (`*_ord1`, `*_ord2`), not `*_draft` | B2, B5 |
| 3 | Coexisting versions: approved v1 + draft v2 | A7, A8, B4 |
| 4 | Ordinal reserved at draft creation (not null) | A2, B2 |
| 5 | STAC materialized at approval (B2C) | A4, A5 |
| 6 | STAC deleted on revoke | F2, F3 |
| 7 | Both approved versions visible in catalog | A11 |
| 8 | is_latest flips atomically on v2 approval | A12 |
| 9 | Release-based approval (release_id preferred) | A5, A10, B3, B6 |
| 10 | Reject + resubmit cycle works | E1-E4 |
| 11 | Revoked ordinal not reused | F4 |
| 12 | Overwrite increments revision, not ordinal | D3 |
| 13 | Dry run does not create release | G1 |
| 14 | Auto-detect: request_id, asset_id, release_id, job_id all resolve | H1-H4 |
| 15 | Stale job_id returns 404 (expected — UPSERT overwrites) | H5 |
| 16 | `?detail=full` appends operational detail block | I1 |
| 17 | Clean B2B response shape (asset/release/outputs/services/approval/versions) | H1-H4 |

### Regressions from V0.8 (must still work)

| # | V0.8 Behavior | Still Works? | Tests |
|---|---------------|-------------|-------|
| 1 | Submit creates job | | A1 |
| 2 | Job completes and updates release | | A2 |
| 3 | Approve sets clearance + version | | A5 |
| 4 | Reject sets approval_state=rejected | | E2 |
| 5 | Revoke sets approval_state=revoked | | F2 |
| 6 | Resubmit cleans up old artifacts | | E3 |
| 7 | Idempotent duplicate submit | | D2 |
| 8 | Status polling via request_id | | A2 |

---

## Run 3 Notes (24 FEB 2026, v0.9.2.1)

**Executor**: Claude Code (automated)
**Pre-requisites**: Health check (v0.9.2.1 healthy), pgSTAC nuke (2 items, 1 collection cleared), schema rebuild (23 tables, 5 functions, 21 enums, pgSTAC 0.9.8).

### Observations (non-blocking)

1. **Vector STAC `stac_updated=false`** — Both B3 and B6 returned `stac_updated=false` on vector approval, while raster approval returns `stac_updated=true`. STAC item IDs were correctly renamed (ord→v), but the pgSTAC write may not be happening for vectors. Likely related to pgSTAC Phase 2 (item builder rewrite) still pending.

2. **Geo schema persistence across rebuilds** — `action=rebuild` only clears `app` and `pgstac` schemas. Vector tables in the `geo` schema survive, causing "Table already exists" on reused dataset_ids. Used fresh `v09-vector-r3` identifier for Section B. Consider adding an optional `target=geo` to the rebuild endpoint, or documenting that vector test runs need unique dataset_ids.

3. **Test ordering dependency (H4)** — Section G's G4 test submits a new version to the same `v09-raster-test/dctest` asset used in Section A. The UPSERT overwrites the `job_id` in `api_requests`, making the v2 `job_id` stale before Section H runs. H4 was confirmed to pass with fresh job_ids from other sections (revoke test, reject resubmit). Not a bug — same documented behavior as H5.

---

## Dead Code Note: VALID_INPUT_CONTAINERS — DONE (23 FEB 2026)

Removed all dead container/access-level validation code:
- `VALID_INPUT_CONTAINERS` and `VALID_ACCESS_LEVELS` from `config/defaults.py`
- `valid_input_containers`, `valid_access_levels`, `is_valid_container()`, `is_valid_access_level()` from `config/platform_config.py`
- `PLATFORM_VALID_CONTAINERS` and `PLATFORM_ACCESS_LEVELS` env var parsing from `from_environment()`
- Related entries from `debug_dict()`

All 133 tests pass after removal.
