# ADO Work Items - Updates & Additions

**Created**: 06 FEB 2026
**Purpose**: New work items to add to ADO (extends V0.8_ADO_WORKITEMS.md)
**Status**: PENDING ADO IMPORT

---

## How to Use This Document

1. New items are drafted here using the same format as V0.8_ADO_WORKITEMS.md
2. Once imported to ADO, move the item to V0.8_ADO_WORKITEMS.md
3. Mark imported items with `[IMPORTED]` and date

---

## Import Conventions

- `[NEW]` = Ready to import as New state
- `[ACTIVE]` = Ready to import as Active state
- `[IMPORTED: DD MMM YYYY]` = Already in ADO, move to main doc

---

# NEW ITEMS TO ADD

---

## FEATURE 7: DDH Platform Integration

### US 7.5: B2B Request Context Tracking `[NEW]`

**Type**: User Story
**Parent**: FEATURE 7: DDH Platform Integration
**Created**: 06 FEB 2026
**Details**: [B2B_REQUEST_CONTEXT.md](/docs_claude/B2B_REQUEST_CONTEXT.md)

**As a** platform administrator (Platform Ops - Tier 1)
**I want** to track which B2B client submitted each request
**So that** I can audit request sources and distinguish DDH from internal UIs

**Acceptance Criteria**:
- [ ] Request context captured from HTTP headers (User-Agent, X-Forwarded-For, correlation ID)
- [ ] Azure AD app identity extracted from JWT token (appid claim)
- [ ] Client name resolved from app ID or User-Agent pattern
- [ ] Internal UIs identified distinctly (rmh_orchestrator_ui, rmh_gateway_ui)
- [ ] Context stored in api_requests table

#### Tasks

| ID | Description | Status |
|----|-------------|--------|
| T7.5.1 | Extend ApiRequest model with client tracking fields | Not started |
| T7.5.2 | Create services/request_context.py extractor | Not started |
| T7.5.3 | Wire extractor to platform/submit endpoint | Not started |
| T7.5.4 | Wire extractor to platform/validate endpoint | Not started |
| T7.5.5 | Update internal UI User-Agent headers | Not started |
| T7.5.6 | Database migration (action=ensure) | Not started |

**Design Decisions**:
- No API keys/tokens - identity-based auth only
- Primary: Azure AD token `appid` claim (zero effort from DDH)
- Fallback: User-Agent header pattern matching
- Storage: Explicit columns on api_requests + JSONB overflow

---

### US 7.6: Platform Submit Pre-flight Validation `[NEW]`

**Type**: User Story
**Parent**: FEATURE 7: DDH Platform Integration
**Created**: 06 FEB 2026
**Details**: [DRY_RUN_IMPLEMENTATION.md](/docs_claude/DRY_RUN_IMPLEMENTATION.md)

**As a** B2B application developer (DDH ITSDA team)
**I want** to validate a submission before committing
**So that** I can catch errors before creating jobs and verify version lineage

**Acceptance Criteria**:
- [ ] `?dry_run=true` parameter on /api/platform/submit
- [ ] Returns validation result without creating job
- [ ] `previous_version_id` parameter validated against lineage
- [ ] Race conditions prevented for concurrent version submissions
- [ ] /api/platform/validate endpoint uses same logic

#### Tasks

| ID | Description | Status |
|----|-------------|--------|
| T7.6.1 | Add previous_version_id to PlatformRequest model | Not started |
| T7.6.2 | Create validate_version_lineage() helper | Not started |
| T7.6.3 | Add ?dry_run=true logic to submit endpoint | Not started |
| T7.6.4 | Consolidate /api/platform/validate to use same logic | Not started |
| T7.6.5 | Add dry_run tests | Not started |

---

## FEATURE 6: Admin & Developer Portal

### US 6.3: Multi-App Deployment Architecture `[NEW]`

**Type**: User Story
**Parent**: FEATURE 6: Admin & Developer Portal
**Created**: 06 FEB 2026
**Details**: [APP_MODE_ENDPOINT_REFACTOR.md](/docs_claude/APP_MODE_ENDPOINT_REFACTOR.md)

**As a** platform administrator (Platform Ops - Tier 1)
**I want** separate Function App deployments for different purposes
**So that** Gateway (B2B-facing) exposes only platform endpoints while Orchestrator (admin) has full access

**Acceptance Criteria**:
- [ ] APP_MODE configuration controls endpoint exposure
- [ ] Gateway mode: only /api/platform/*, /api/interface/*, health probes
- [ ] Orchestrator mode: full admin access
- [ ] Docker worker mode: task processing only
- [ ] Each mode has appropriate health checks

#### Tasks

| ID | Description | Status |
|----|-------------|--------|
| T6.3.1 | Add has_*_endpoints properties to app_mode_config | Done |
| T6.3.2 | Implement three-tier health endpoints | Done |
| T6.3.3 | Docker worker always checked in system-health | Done |
| T6.3.4 | Wrap endpoint registration with mode checks | Not started |
| T6.3.5 | Deploy and test gateway | Not started |
| T6.3.6 | Apply restrictions to other APP_MODEs | Not started |

---

### US 6.4: QA Review Interface with B2B Embedding `[ACTIVE]`

**Type**: User Story
**Parent**: FEATURE 6: Admin & Developer Portal
**Created**: 06 FEB 2026
**Updated**: 07 FEB 2026

**As a** B2B application developer (DDH ITSDA team)
**I want** to embed our QA review interface in an iframe
**So that** DDH can show approval UI in their application without building their own

**Acceptance Criteria**:
- [x] Map-based viewer with data preview (raster + vector)
- [x] Approve/Reject buttons trigger platform/approve workflows
- [x] Iframe embedding via `?embed=true` parameter
- [x] CSP header allows cross-origin embedding (`frame-ancestors *`)
- [ ] Vector approval workflow tested end-to-end
- [ ] Raster approval workflow tested end-to-end
- [ ] Iframe embedding documented for B2B developers

#### Tasks

| ID | Description | Status |
|----|-------------|--------|
| T6.4.1 | QA Review section in raster viewer (Approve/Reject buttons) | Done |
| T6.4.2 | QA Review section in vector viewer (Approve/Reject buttons) | Done |
| T6.4.3 | Embed mode (`?embed=true`) skips navbar | Done |
| T6.4.4 | CSP header `frame-ancestors *` for iframe embedding | Done |
| T6.4.5 | Test vector approval workflow end-to-end | Not started |
| T6.4.6 | Test raster approval workflow end-to-end | Not started |
| T6.4.7 | Document iframe embedding for B2B integration | Not started |
| T6.4.8 | Add `approval_url` to platform/status response for completed jobs | Done |
| T6.4.9 | Remove deprecated Docker worker UI routes (docker_service.py) | Done (archived) |
| T6.4.10 | Move vector viewer to /api/interface/vector-viewer | Done |
| T6.4.11 | Add PLATFORM_URL env var for B2B-facing URLs | Done |
| T6.4.12 | Archive deprecated viewer modules (vector_viewer/, raster_collection_viewer/) | Pending |

**Implementation Details**:

Files implementing this feature:
- `web_interfaces/raster_viewer/interface.py` - Raster viewer with QA buttons
- `web_interfaces/vector/interface.py` - Vector interface (needs viewer route)
- `web_interfaces/__init__.py` - Embed mode handler (lines 178-210)
- `web_interfaces/base.py` - `embed_mode` flag skips navbar

**Architecture Decision** (07 FEB 2026):
- All UI served from Function App (`/api/interface/*`)
- Docker worker = task processing only (no UI)
- Docker worker's `/interface/` routes in `docker_service.py` are DEPRECATED

**B2B Workflow**:
1. B2B calls `POST /api/platform/submit` → gets `request_id`
2. B2B polls `GET /api/platform/status/{request_id}` until `job_status=completed`
3. Response includes `approval_url` with embed link
4. B2B embeds iframe: `<iframe src="{approval_url}"></iframe>`
5. User approves/rejects in iframe → triggers `/api/approvals/{id}/approve`

**Embed URL Pattern** (Function App):
```
/api/interface/raster-viewer?item_id={stac_item_id}&embed=true
/api/interface/vector?collection={table_name}&embed=true
```

**Environment Variable** (07 FEB 2026):
```bash
# Each app sets its own public URL
PLATFORM_URL=https://rmhgeogateway-xxx.azurewebsites.net  # Gateway
PLATFORM_URL=https://rmhazuregeoapi-xxx.azurewebsites.net  # Orchestrator

# Falls back to ETL_APP_URL if not set (backward compatible)
```

The `approval.embed` URL in platform/status responses uses `PLATFORM_URL` so B2B apps
get URLs pointing to the correct (Gateway) app they can access.

---

# PROPOSED ITEMS (Discussion Needed)

Items below need discussion before adding to ADO.

---

## FEATURE 1: ETL Pipeline Orchestration

### US 1.x: Mount-Based Resumable Raster Workflow `[PROPOSED]`

**Type**: User Story
**Parent**: FEATURE 1: ETL Pipeline Orchestration
**Details**: [Plan file](/Users/robertharrison/.claude/plans/async-squishing-reddy.md)

**As a** platform operator (Platform Ops - Tier 1)
**I want** large raster jobs to resume from the last completed tile after failure
**So that** multi-hour jobs don't restart from scratch

**Acceptance Criteria**:
- [ ] Source downloaded to mount once (not re-downloaded on resume)
- [ ] Per-tile checkpointing via blob existence
- [ ] Graceful shutdown support
- [ ] Mount cleanup after completion

**Discussion**: Is this US 1.1 enhancement or separate story?

---

### EN 1.x: AzCopy Integration `[PROPOSED]`

**Type**: Enabler
**Enabler Type**: Infrastructure
**Parent**: FEATURE 1: ETL Pipeline Orchestration
**Details**: [V0.8_COPY.md](/V0.8_COPY.md)

**Purpose**: 5-10x faster blob transfers using AzCopy instead of Python SDK

**Acceptance Criteria**:
- [ ] AzCopy installed in Docker image
- [ ] Managed Identity authentication working
- [ ] Wrapper functions in infrastructure/azcopy.py
- [ ] Integrated with raster_cog.py

**Discussion**: Requires eService for RBAC role. Worth the overhead?

---

# IMPORT LOG

| Date | Item | ADO ID | Notes |
|------|------|--------|-------|
| - | - | - | No imports yet |

---

*End of Updates*
