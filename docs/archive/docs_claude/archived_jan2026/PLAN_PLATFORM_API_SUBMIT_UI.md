# Plan: Platform API Submit UI Migration

**Created**: 29 DEC 2025
**Status**: IMPLEMENTED
**Estimated Effort**: ~22 hours total (both interfaces)
**Risk Level**: Low
**Completed**: 29 DEC 2025

---

## Overview

Convert `submit-vector` and `submit-raster` web interfaces from Direct CoreMachine API to **Platform API** mode. The interfaces will serve as **developer integration tools** that:

1. Generate complete, copy-paste-ready cURL commands for the Platform API
2. Allow direct submission via a convenience button
3. Help integration developers understand the Platform API contract

### User Flow

```
Fill Form → See Live cURL → Copy to Postman OR Click Submit
```

---

## Current State

| Aspect | submit-vector | submit-raster |
|--------|---------------|---------------|
| **Endpoint** | `/api/jobs/submit/process_vector` | `/api/jobs/submit/process_raster_v2` |
| **Required Fields** | `blob_name`, `table_name`, `container_name` | `blob_name`, `container_name` |
| **Naming** | User specifies table_name | Auto-generated |
| **Tracking** | `job_id` only | `job_id` only |
| **cURL Section** | Collapsed, Direct API format | Collapsed, Direct API format |

---

## Target State

| Aspect | submit-vector | submit-raster |
|--------|---------------|---------------|
| **Endpoint** | `/api/platform/submit` | `/api/platform/raster` |
| **Required Fields** | `dataset_id`, `resource_id`, `version_id` | `dataset_id`, `resource_id`, `version_id` |
| **Naming** | Auto-generated from DDH IDs | Auto-generated from DDH IDs |
| **Tracking** | `request_id` + `job_id` | `request_id` + `job_id` |
| **cURL Section** | Prominent, Platform API format | Prominent, Platform API format |

---

## Platform API Parameters Reference

### Required (All Endpoints)

| Parameter | Type | Description | Example |
|-----------|------|-------------|---------|
| `dataset_id` | string | DDH dataset identifier | `"parcels-2024"` |
| `resource_id` | string | DDH resource identifier | `"county-king"` |
| `version_id` | string | DDH version identifier | `"v1.0"` |
| `container_name` | string | Azure Blob container | `"rmhazuregeobronze"` |
| `file_name` | string | Source filename | `"data.geojson"` |

### Optional Metadata

| Parameter | Type | Description |
|-----------|------|-------------|
| `service_name` | string | Human-readable name |
| `access_level` | string | `"OUO"`, `"PUBLIC"`, `"restricted"` |
| `description` | string | Dataset description |
| `tags` | list | Searchability tags |

### Vector Processing Options (`processing_options`)

| Option | Type | Description |
|--------|------|-------------|
| `lon_column` | string | Longitude column (CSV) |
| `lat_column` | string | Latitude column (CSV) |
| `wkt_column` | string | WKT geometry column (CSV) |
| `overwrite` | boolean | Replace existing data |

### Raster Processing Options (`processing_options`)

| Option | Values | Default |
|--------|--------|---------|
| `output_tier` | `analysis`, `visualization`, `archive` | `analysis` |
| `crs` | EPSG code string | `EPSG:4326` |
| `raster_type` | `auto`, `rgb`, `dem`, `categorical` | `auto` |

### Endpoints

| Data Type | Endpoint |
|-----------|----------|
| Vector | `POST /api/platform/submit` (with `data_type: "vector"`) |
| Single Raster | `POST /api/platform/raster` |
| Raster Collection | `POST /api/platform/raster-collection` |

---

## Implementation Todos

### Phase 1: submit-vector Interface ✅ COMPLETED

#### 1.1 UI Field Changes
- [x] Add DDH Identifiers section at top of form:
  - [x] `dataset_id` (text input, required, placeholder: "e.g., parcels-2024")
  - [x] `resource_id` (text input, required, placeholder: "e.g., county-king")
  - [x] `version_id` (text input, required, default: "v1.0")
- [x] Remove or hide `table_name` field (auto-generated by Platform)
- [x] Keep `schema` field hidden (Platform uses default)
- [x] Rename metadata section to match Platform API:
  - [x] Keep `title` → maps to `service_name`
  - [x] Keep `description` → maps to `description`
  - [x] Keep `license` → maps to `access_level` (adjust options)
  - [x] Keep `keywords` → maps to `tags`
- [x] Keep CSV fields (lat_name, lon_name, wkt_column) → map to `processing_options`
- [x] Keep overwrite checkbox → maps to `processing_options.overwrite`

#### 1.2 cURL Section Updates
- [x] Make cURL section **expanded by default** (prominent dark theme section)
- [x] Add "OR submit directly" visual separator
- [x] Update `generateCurl()` function for Platform API format:
  ```javascript
  function generatePlatformCurl() {
      // Build Platform API payload
      const payload = {
          dataset_id: ...,
          resource_id: ...,
          version_id: ...,
          data_type: "vector",
          operation: "CREATE",
          container_name: ...,
          file_name: ...,
          // Optional
          service_name: ...,
          access_level: ...,
          description: ...,
          tags: [...],
          processing_options: {
              overwrite: ...,
              lon_column: ...,  // if CSV
              lat_column: ...,
              wkt_column: ...
          }
      };
      // Generate curl command
      return `curl -X POST "${baseUrl}/api/platform/submit" \\
    -H "Content-Type: application/json" \\
    -d '${JSON.stringify(payload, null, 2)}'`;
  }
  ```

#### 1.3 Form Submission Updates
- [x] Update `_render_submit_fragment()` in `interface.py`:
  - [x] Build Platform API payload from form data
  - [x] POST to `/api/platform/submit` via PlatformTrigger
  - [x] Extract `request_id` and `job_id` from response
- [x] Update `_render_submit_success_platform()`:
  - [x] Show `request_id` and `job_id`
  - [x] Link to Platform status URL: `/api/platform/status/{request_id}`
  - [x] Show DDH identifier path

#### 1.4 Validation Updates
- [x] Require `dataset_id`, `resource_id`, `version_id` before enabling submit
- [x] Remove `table_name` from required validation
- [x] Add pattern validation for DDH IDs (lowercase, hyphens, no spaces)

---

### Phase 2: submit-raster Interface ✅ COMPLETED

#### 2.1 UI Field Changes
- [x] Add DDH Identifiers section (same as vector):
  - [x] `dataset_id`, `resource_id`, `version_id`
- [x] Keep raster-specific fields:
  - [x] `raster_type` → maps to `processing_options.raster_type`
  - [x] `output_tier` → maps to `processing_options.output_tier`
  - [x] `input_crs` → maps to `processing_options.crs`
  - [x] `target_crs` → removed (Platform handles)
- [x] Remove fields not needed for Platform API:
  - [x] `output_folder` (auto-generated)
  - [x] `collection_id` (auto-generated from dataset_id)

#### 2.2 cURL Section Updates
- [x] Make cURL section expanded by default (prominent dark theme section)
- [x] Update `generateCurl()` for Platform raster format:
  ```javascript
  function generatePlatformCurl() {
      const payload = {
          dataset_id: ...,
          resource_id: ...,
          version_id: ...,
          container_name: ...,
          file_name: ...,
          service_name: ...,
          access_level: ...,
          description: ...,
          tags: [...],
          processing_options: {
              output_tier: ...,
              crs: ...,
              raster_type: ...
          }
      };
      return `curl -X POST "${baseUrl}/api/platform/raster" \\
    -H "Content-Type: application/json" \\
    -d '${JSON.stringify(payload, null, 2)}'`;
  }
  ```

#### 2.3 Form Submission Updates
- [x] Update `_render_submit_fragment()`:
  - [x] POST to `/api/platform/raster` via PlatformRasterTrigger
  - [x] Handle response with `request_id`, `job_id`
- [x] Update success display for Platform response format

---

### Phase 3: Testing (TODO - manual verification needed)

#### 3.1 cURL Testing
- [ ] Copy generated cURL to terminal, verify it works
- [ ] Copy to Postman, verify import works
- [ ] Test with all optional fields populated
- [ ] Test with minimal required fields only

#### 3.2 Form Submission Testing
- [ ] Submit vector via form, verify job created
- [ ] Submit raster via form, verify job created
- [ ] Verify `request_id` returned and displayed
- [ ] Verify status link works (`/api/platform/status/{request_id}`)

#### 3.3 Edge Cases
- [ ] CSV file with lat/lon columns
- [ ] Large raster (should auto-fallback to large raster job)
- [ ] Duplicate submission (should return existing request_id)
- [ ] Invalid DDH identifiers (should show validation error)

---

## Files to Modify

| File | Changes |
|------|---------|
| `web_interfaces/submit_vector/interface.py` | UI fields, cURL generation, form submission |
| `web_interfaces/submit_raster/interface.py` | UI fields, cURL generation, form submission |

---

## Reference Documentation

- **Platform API Wiki**: `WIKI_PLATFORM_API.md`
- **Platform Trigger**: `triggers/trigger_platform.py`
- **Platform Config**: `config/platform_config.py`

---

## Example Generated cURL (Vector)

```bash
curl -X POST "https://rmhazuregeoapi-a3dma3ctfdgngwf6.eastus-01.azurewebsites.net/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "parcels-2024",
    "resource_id": "county-king",
    "version_id": "v1.0",
    "data_type": "vector",
    "operation": "CREATE",
    "container_name": "rmhazuregeobronze",
    "file_name": "parcels.geojson",
    "service_name": "King County Parcels",
    "access_level": "OUO",
    "description": "Property parcel boundaries for King County",
    "tags": ["parcels", "boundaries", "king-county"],
    "processing_options": {
      "overwrite": false
    }
  }'
```

## Example Generated cURL (Raster)

```bash
curl -X POST "https://rmhazuregeoapi-a3dma3ctfdgngwf6.eastus-01.azurewebsites.net/api/platform/raster" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "aerial-imagery-2024",
    "resource_id": "site-alpha",
    "version_id": "v1.0",
    "container_name": "rmhazuregeobronze",
    "file_name": "aerial-alpha.tif",
    "service_name": "Aerial Imagery Site Alpha",
    "access_level": "OUO",
    "description": "High-resolution aerial imagery",
    "tags": ["aerial", "rgb", "2024"],
    "processing_options": {
      "output_tier": "analysis",
      "raster_type": "auto"
    }
  }'
```

---

## Success Criteria

1. Developer can fill form, copy cURL, paste to Postman - it works
2. Developer can fill form, click Submit - job created via Platform API
3. Response shows `request_id` and link to Platform status endpoint
4. All Platform API parameters documented in UI (tooltips/help text)
