# V0.8 Approval Consolidation Plan

**Created**: 08 FEB 2026
**Status**: COMPLETE - Phases 1-5 Complete (11 FEB 2026)
**Related**: V0.8_ENTITIES.md, GeospatialAsset-centric data model

---

## Executive Summary

Consolidate approval state into GeospatialAsset as a first-class state dimension. Archive the legacy DatasetApproval system that predates V0.8 entity architecture.

**Current State**: Two parallel approval systems
**Target State**: GeospatialAsset.approval_state is the single source of truth

---

## Problem Statement

### Two Parallel Systems

| Entity | Created | Table | Approval Field |
|--------|---------|-------|----------------|
| **DatasetApproval** | 16 JAN 2026 | `app.dataset_approvals` | `status` (ApprovalStatus) |
| **GeospatialAsset** | 29 JAN 2026 | `app.geospatial_assets` | `approval_state` (ApprovalState) |

### Issues

1. **DatasetApproval was created 13 days BEFORE GeospatialAsset** - legacy architecture
2. **ApprovalService operates on DatasetApproval**, ignores GeospatialAsset.approval_state
3. **Duplicated fields**: reviewer, reviewed_at, rejection_reason, adf_run_id, stac_item_id
4. **Different enums**: ApprovalStatus has REVOKED, ApprovalState does not

### Current ApprovalService Flow (WRONG)

```
Job Completes → Create DatasetApproval record → Reviewer approves → Update DatasetApproval.status
                                                                    (GeospatialAsset.approval_state NEVER updated)
```

### Target Flow (CORRECT)

```
Platform Submit → Create GeospatialAsset (approval_state=PENDING_REVIEW)
                                    ↓
Job Completes → Update GeospatialAsset.processing_status=COMPLETED
                                    ↓
Reviewer approves → Update GeospatialAsset.approval_state=APPROVED
                    Update GeospatialAsset.clearance_state (OUO/PUBLIC)
                    Update STAC properties (app:published=true)
                    Trigger ADF if PUBLIC
```

---

## Implementation Phases

### Phase 1: Enhance GeospatialAsset Approval State

**Files to modify:**
- `core/models/asset.py`

**1.1 Update ApprovalState enum**

Add REVOKED state:
```python
class ApprovalState(str, Enum):
    PENDING_REVIEW = "pending_review"
    APPROVED = "approved"
    REJECTED = "rejected"
    REVOKED = "revoked"  # NEW: For unpublishing approved assets
```

State transitions:
```
PENDING_REVIEW → APPROVED → REVOKED
               ↘ REJECTED → (resubmit via overwrite) → PENDING_REVIEW
```

**1.2 Add missing fields to GeospatialAsset**

```python
# Approval notes (from DatasetApproval.notes)
approval_notes: Optional[str] = Field(
    default=None,
    description="Reviewer notes on approval decision"
)

# Revocation audit trail (from DatasetApproval revocation fields)
# NOTE: revoked_at, revoked_by, revocation_reason may already be needed
# Check if clearance audit fields can serve this purpose or if separate needed
```

**1.3 Verify state transition methods exist**

Already in GeospatialAsset:
- `can_approve()` ✓
- `can_reject()` ✓
- `can_change_clearance()` ✓

May need to add:
- `can_revoke()` - Check if APPROVED and can transition to REVOKED

---

### Phase 2: Create New Asset Approval Service

**Files to create:**
- `services/asset_approval_service.py`

**2.1 AssetApprovalService class**

```python
class AssetApprovalService:
    """
    Approval workflow operating on GeospatialAsset.

    Replaces legacy ApprovalService that used DatasetApproval table.
    """

    def __init__(self):
        self.asset_repo = AssetRepository()
        self.pgstac_repo = PgStacRepository()

    def approve_asset(
        self,
        asset_id: str,
        reviewer: str,
        clearance_state: ClearanceState,
        notes: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        Approve an asset for publication.

        1. Validate asset is PENDING_REVIEW
        2. Update GeospatialAsset:
           - approval_state = APPROVED
           - clearance_state = provided value
           - reviewer, reviewed_at, approval_notes
        3. Update STAC item (app:published=true)
        4. Trigger ADF if clearance_state=PUBLIC
        """
        pass

    def reject_asset(
        self,
        asset_id: str,
        reviewer: str,
        reason: str
    ) -> Dict[str, Any]:
        """
        Reject an asset.

        1. Validate asset is PENDING_REVIEW
        2. Update GeospatialAsset:
           - approval_state = REJECTED
           - reviewer, reviewed_at, rejection_reason
        """
        pass

    def revoke_asset(
        self,
        asset_id: str,
        revoker: str,
        reason: str
    ) -> Dict[str, Any]:
        """
        Revoke a previously approved asset (unpublish).

        1. Validate asset is APPROVED
        2. Update GeospatialAsset:
           - approval_state = REVOKED
           - Record revocation audit trail
        3. Update STAC item (app:revoked=true)
        """
        pass

    def list_pending_review(self, limit: int = 50) -> List[GeospatialAsset]:
        """List assets awaiting approval."""
        pass

    def get_approval_stats(self) -> Dict[str, int]:
        """Count assets by approval_state."""
        pass
```

**2.2 Repository methods** (extend AssetRepository or create dedicated)

```python
# In infrastructure/asset_repository.py or new file

def update_approval_state(
    self,
    asset_id: str,
    new_state: ApprovalState,
    reviewer: str,
    reviewed_at: datetime,
    notes: Optional[str] = None,
    rejection_reason: Optional[str] = None,
    clearance_state: Optional[ClearanceState] = None
) -> bool:
    """Atomic approval state update with audit fields."""
    pass

def list_by_approval_state(
    self,
    state: ApprovalState,
    limit: int = 50
) -> List[GeospatialAsset]:
    """Query assets by approval state."""
    pass

def count_by_approval_state(self) -> Dict[str, int]:
    """Aggregate counts for dashboard."""
    pass
```

---

### Phase 3: Update Triggers/Routes

**Files to modify:**
- Create `triggers/asset_approvals.py` (or update existing admin triggers)

**3.1 New approval endpoints**

```python
# Asset-centric approval endpoints
POST /api/assets/{asset_id}/approve
POST /api/assets/{asset_id}/reject
POST /api/assets/{asset_id}/revoke

# Query endpoints
GET /api/assets/pending-review
GET /api/assets/approval-stats
```

**3.2 Deprecate old endpoints**

Mark for removal (Phase 4):
```
POST /api/approvals/{approval_id}/approve  # OLD
POST /api/approvals/{approval_id}/reject   # OLD
GET /api/approvals/pending                 # OLD
```

**3.3 Job completion integration**

When job completes successfully:
```python
# In job completion handler
asset = asset_repo.get_by_id(job.asset_id)
asset_repo.update_processing_status(
    asset_id=job.asset_id,
    status=ProcessingStatus.COMPLETED,
    completed_at=datetime.now(timezone.utc)
)
# Asset is already approval_state=PENDING_REVIEW (set at creation)
# No DatasetApproval record needed
```

---

### Phase 4: Archive Legacy Code

**4.1 Files to archive**

Move to `docs/archive/v0.7_approval/`:
```
core/models/approval.py           → DatasetApproval, ApprovalStatus enum
services/approval_service.py      → Legacy ApprovalService
infrastructure/approval_repository.py
triggers/trigger_approvals.py
triggers/admin/admin_approvals.py
```

**4.2 Remove from active imports**

Update `core/models/__init__.py`:
```python
# REMOVE these exports:
# from .approval import DatasetApproval, ApprovalStatus
```

Update `infrastructure/__init__.py`:
```python
# REMOVE:
# from .approval_repository import ApprovalRepository
```

Update `services/__init__.py`:
```python
# REMOVE:
# from .approval_service import ApprovalService
```

**4.3 Schema cleanup**

```sql
-- Drop legacy table (after confirming no production data)
DROP TABLE IF EXISTS app.dataset_approvals;
```

Or keep as audit archive if historical data exists.

---

### Phase 5: Schema Update

**5.1 Add any missing columns to geospatial_assets**

```sql
-- If approval_notes not already present
ALTER TABLE app.geospatial_assets
ADD COLUMN IF NOT EXISTS approval_notes TEXT;
```

**5.2 Verify indexes exist**

Already defined in GeospatialAsset model:
- `idx_assets_approval` on `approval_state`
- `idx_assets_pending` partial index for pending_review

**5.3 Update DDL generator if needed**

Ensure `core/schema/sql_generator.py` generates correct schema.

---

## Resulting Architecture

### GeospatialAsset as Aggregate Root (DDD)

GeospatialAsset is the **Aggregate Root** of the Platform domain:
- Controls access to related entities (jobs, requests, revisions)
- Enforces business invariants (state transition rules)
- Single entry point for all modifications
- Unique identity that persists through lifecycle

```
GeospatialAsset (Aggregate Root)
    │
    ├──◄ Job (N) ────────── "processed by" (job.asset_id → asset)
    ├──◄ ApiRequest (N) ─── "triggered by" (request.asset_id → asset)
    └──◄ AssetRevision (N) ─ "history of" (revision.asset_id → asset)
```

### Orthogonal State Machine (4 Dimensions)

The asset has four **orthogonal state dimensions** that change independently:

```
┌─────────────────────────────────────────────────────────────────┐
│                 GeospatialAsset (Aggregate Root)                │
├────────────────┬────────────────┬────────────────┬──────────────┤
│  REVISION      │  APPROVAL      │  CLEARANCE     │  PROCESSING  │
│  ┌──────────┐  │  ┌──────────┐  │  ┌──────────┐  │  ┌────────┐  │
│  │ rev: 1   │  │  │ PENDING  │  │  │ UNCLEARED│  │  │ PENDING│  │
│  │ rev: 2   │  │  │ APPROVED │  │  │ OUO      │  │  │PROCESS │  │
│  │ rev: N   │  │  │ REJECTED │  │  │ PUBLIC   │  │  │COMPLETE│  │
│  └──────────┘  │  │ REVOKED  │  │  └──────────┘  │  │ FAILED │  │
│                │  └──────────┘  │                │  └────────┘  │
└────────────────┴────────────────┴────────────────┴──────────────┘
```

### Field Mapping

```
GeospatialAsset (Aggregate Root)
│
├── REVISION STATE
│   ├── revision: int
│   ├── current_job_id: FK → jobs
│   └── content_hash: str
│
├── APPROVAL STATE  ← CONSOLIDATED HERE
│   ├── approval_state: ApprovalState
│   ├── reviewer, reviewed_at
│   ├── rejection_reason, approval_notes
│   └── revoked_at, revoked_by, revocation_reason
│
├── CLEARANCE STATE
│   ├── clearance_state: ClearanceState
│   ├── adf_run_id (if public)
│   ├── cleared_at, cleared_by
│   └── made_public_at, made_public_by
│
└── PROCESSING STATE
    ├── processing_status: ProcessingStatus
    ├── processing_started_at, processing_completed_at
    └── last_error (if failed)
```

**One Aggregate Root, one source of truth.**

---

## Migration Checklist

### Pre-Migration
- [ ] Confirm no production data in `app.dataset_approvals` (or plan data migration)
- [ ] Review existing approval workflow usage

### Phase 1: GeospatialAsset Enhancement ✅ COMPLETE (08 FEB 2026)
- [x] Add REVOKED to ApprovalState enum
- [x] Add approval_notes field
- [x] Add revocation audit fields (revoked_at, revoked_by, revocation_reason)
- [x] Add can_revoke() and is_revoked() methods
- [x] Update to_dict() with new fields

### Phase 2: New Service ✅ COMPLETE (08 FEB 2026)
- [x] Create AssetApprovalService (`services/asset_approval_service.py`)
  - approve_asset(), reject_asset(), revoke_asset()
  - list_pending_review(), list_by_approval_state(), get_approval_stats()
  - STAC integration (_update_stac_published, _update_stac_revoked)
  - ADF integration (_trigger_adf_pipeline)
- [x] Add repository methods to GeospatialAssetRepository:
  - update_approval_state()
  - update_revocation()
  - update_adf_run_id()
  - count_by_approval_state()
- [ ] Write unit tests (deferred)

### Phase 3: Routes ✅ COMPLETE (08 FEB 2026)
- [x] Create new /api/assets/{id}/approve endpoint
- [x] Create new /api/assets/{id}/reject endpoint
- [x] Create new /api/assets/{id}/revoke endpoint
- [x] Create GET /api/assets/pending-review
- [x] Create GET /api/assets/approval-stats
- [x] Create GET /api/assets/{id}/approval (get approval state)
- [x] Create GET /api/assets/by-approval-state
- [x] Blueprint: `triggers/assets/asset_approvals_bp.py`
- [x] Registered in function_app.py (line 519)
- [ ] Update job completion handler (deferred - separate integration)

### Phase 4: Archive Legacy Code ✅ COMPLETE (08 FEB 2026)
- [x] Updated triggers/trigger_approvals.py to use AssetApprovalService
- [x] Updated triggers/admin/admin_approvals.py to use AssetApprovalService
- [x] Updated services/unpublish_handlers.py to use GeospatialAsset lookups
- [x] Removed DatasetApproval creation from core/machine_factory.py
- [x] Move legacy files to docs/archive/v0.7_approval/ (11 FEB 2026)

### Phase 5: Schema & Code Cleanup ✅ COMPLETE (11 FEB 2026)
- [x] Schema rebuild added new GeospatialAsset columns (approval_notes, revoked_at, revoked_by, revocation_reason)
- [x] Removed dataset_approvals DDL from sql_generator.py (table, PK, indexes, enum)
- [x] Removed dataset_approvals from schema_analyzer.py expected schema
- [x] Removed DatasetApproval/ApprovalStatus exports from core/models/__init__.py
- [x] Removed ApprovalRepository from infrastructure/__init__.py
- [x] Archived legacy files: approval_model.py, approval_repository.py, approval_service.py
- [x] Verified all imports clean (core.models, sql_generator, infrastructure)

### Post-Migration ✅ COMPLETE (11 FEB 2026)
- [x] Update API documentation - OpenAPI spec already covered consolidated model; added missing batch endpoint to docs landing page
- [ ] Update admin UI if applicable (N/A - no changes needed)
- [ ] Bump version (deferred to next deployment)

---

## Dependencies

This plan depends on:
- V0.8.11 FK linkage complete (asset_id on jobs) ✓
- GeospatialAsset entity model stable ✓
- AssetRepository exists and works

---

## Notes

- DatasetApproval was created 16 JAN 2026, GeospatialAsset 29 JAN 2026
- The legacy system was never integrated with GeospatialAsset
- This consolidation aligns with "GeospatialAsset as first-class entity" principle
- REVOKED state needed for unpublish workflow (approved → revoked)

---

## V0.8.11.2 Summary (08 FEB 2026)

**GeospatialAsset is now the single source of truth for approval state.**

All approval workflows now use:
- `AssetApprovalService` (services/asset_approval_service.py)
- `GeospatialAsset.approval_state` field
- Direct lookups via `GeospatialAssetRepository`

Legacy `DatasetApproval` table and `ApprovalService` are no longer used by any active code paths.

Files Updated:
- `triggers/trigger_approvals.py` - Platform B2B endpoints
- `triggers/admin/admin_approvals.py` - Admin UI endpoints
- `services/unpublish_handlers.py` - Unpublish approval checks
- `core/machine_factory.py` - Removed DatasetApproval creation

---

*Last Updated: 11 FEB 2026*
