# V0.9 Docker Migration — Eliminate functionapp-tasks Queue

**Created**: 17 FEB 2026
**Updated**: 18 FEB 2026
**SAFe Type**: Enabler (architectural consolidation)
**Status**: COMPLETE (18 FEB 2026)

> **All tasks implemented in V0.8.19.0.** Curated + ingest_collection deleted.
> Hello_world + unpublish moved to DOCKER_TASKS. FUNCTIONAPP_TASKS = frozenset().
> See commit `05a6bff` (v0.8.19.0).

---

## Problem Statement

The `functionapp-tasks` Service Bus queue has **no consumer**. Since the orchestrator runs `APP_MODE=orchestrator`, nobody listens to this queue. Result: **24+ stuck messages** and any job that routes tasks here silently fails.

| App | APP_MODE | Consumes |
|-----|----------|----------|
| `rmhazuregeoapi` | `orchestrator` | `geospatial-jobs` only |
| `rmhgeogateway` | `platform` | Nothing (API gateway) |
| `rmhheavyapi` | `worker_docker` | `container-tasks` only |

**`functionapp-tasks` → nobody.**

---

## Decisions (18 FEB 2026)

| Category | Tasks | Decision | Reason |
|----------|-------|----------|--------|
| Vector STAC | 2 | **FUTURE Docker** | Not urgent — vector ETL works without separate STAC stage |
| Hello World | 2 | **MOVE to Docker (P0)** | Smoke test must work |
| Unpublish | 5 | **MOVE to Docker (P0)** | Core — completely undoes a job (deletes STAC, blobs, tables) |
| Inventory | 6 | **FUTURE Docker** | Operational tooling — not urgent |
| STAC Repair | 2 | **FUTURE Docker** | Maintenance ops — not urgent |
| STAC Rebuild | 2 | **FUTURE Docker** | Maintenance ops — not urgent |
| Curated Updates | 4 | **DELETE** | Dormant — endpoints disabled 04 FEB, never called, WDPA incomplete |
| Ingest Collection | 5 | **DELETE** | Dormant — no endpoints, no triggers, never invoked since creation |
| Orphan Blobs | 3 | **FUTURE Docker** | Active (F7.11 Self-Healing) but not urgent — build later |
| **Total** | **31** | | |

---

## DELETE: Curated Dataset Update (4 tasks)

**Job**: `curated_dataset_update`
**Status**: DORMANT — registered but all endpoints commented out since 04 FEB 2026

### What to delete

| File | Action |
|------|--------|
| `jobs/curated_update.py` | Delete file |
| `jobs/__init__.py` | Remove `curated_dataset_update` registration |
| `services/__init__.py` | Remove 4 handler registrations (`curated_check_source`, `curated_fetch_data`, `curated_etl_process`, `curated_finalize`) |
| `config/defaults.py` | Remove 4 task types from `FUNCTIONAPP_TASKS` |
| `triggers/curated/` | Delete directory (admin.py, scheduler.py — both disabled) |
| `core/models/curated.py` | Delete file |
| `core/models/__init__.py` | Remove curated model exports |
| `function_app.py` | Remove commented-out curated imports + routes |

### Database tables to drop (future cleanup)
- `app.curated_datasets`
- `app.curated_update_log`

---

## DELETE: Ingest Collection (5 tasks)

**Job**: `ingest_collection`
**Status**: DORMANT — registered since 29 DEC 2025, zero call sites, never invoked

### What to delete

| File | Action |
|------|--------|
| `jobs/ingest_collection.py` | Delete file |
| `jobs/__init__.py` | Remove `ingest_collection` registration |
| `services/ingest/` | Delete directory (handler_inventory.py, handler_copy.py, handler_register.py, __init__.py) |
| `services/__init__.py` | Remove 5 handler registrations (`ingest_inventory`, `ingest_copy_batch`, `ingest_register_collection`, `ingest_register_items`, `ingest_finalize`) |
| `config/defaults.py` | Remove 5 task types from `FUNCTIONAPP_TASKS` |

---

## MOVE TO DOCKER (P0): Unpublish (5 tasks)

**Priority**: Highest — core functionality, completely undoes a job.

**Jobs**: `unpublish_raster`, `unpublish_vector`

Unpublish is NOT overwrite. Overwrite reprocesses in-place. Unpublish **deletes everything**: STAC items, COG blobs, PostGIS tables, with a full audit trail. This is the only way to cleanly remove published data.

| Task Type | What It Does | New Queue |
|-----------|-------------|-----------|
| `unpublish_inventory_raster` | Finds all blobs to delete (COG, MosaicJSON, tiles) | container-tasks |
| `unpublish_inventory_vector` | Finds table + STAC linkage to remove | container-tasks |
| `unpublish_delete_blob` | Deletes single blob from Azure Storage | container-tasks |
| `unpublish_drop_table` | Drops PostGIS table + metadata row | container-tasks |
| `unpublish_delete_stac` | Deletes STAC item, cleans empty collection, creates audit record | container-tasks |

**Dependencies**: psycopg, Azure Blob SDK, pgSTAC repository — all in Docker image.
**Risk**: Low. No new libraries needed.

---

## MOVE TO DOCKER (P0): Hello World (2 tasks)

Smoke test — must work to validate the pipeline end-to-end.

| Task Type | Current Queue | New Queue |
|-----------|--------------|-----------|
| `hello_world_greeting` | functionapp-tasks | container-tasks |
| `hello_world_reply` | functionapp-tasks | container-tasks |

**Dependencies**: None.
**Risk**: None.

---

## FUTURE: Remaining 15 Tasks (Not Urgent)

Move to Docker when needed. All dependencies already in Docker image.

| Category | Tasks | Jobs | Notes |
|----------|-------|------|-------|
| Vector STAC | 2 | `stac_catalog_vectors` | Stage 2 of vector ETL |
| Inventory | 6 | `summarize_container`, `inventory_container_contents` | Blob scanning, on-demand via `/api/jobs/submit/` |
| STAC Repair | 2 | `repair_stac_items` | Finds + fixes broken STAC items |
| STAC Rebuild | 2 | `rebuild_stac` | Regenerates STAC from source data |
| Orphan Blobs | 3 | `detect_orphan_blobs`, `register_silver_blobs` | F7.11 Self-Healing, on-demand |

**When ready**: Move task types from `FUNCTIONAPP_TASKS` to `DOCKER_TASKS` in `config/defaults.py`.

---

## Implementation Order

1. **Delete** curated + ingest (9 tasks, ~10 files)
2. **Move** unpublish to `DOCKER_TASKS` (5 tasks — P0, core functionality)
3. **Move** hello_world to `DOCKER_TASKS` (2 tasks — P0, smoke test)
4. **Drain** stuck messages from `functionapp-tasks` queue
5. **Deploy** and verify hello_world + unpublish work end-to-end
6. **Future**: Move remaining 15 tasks (vector STAC, inventory, STAC repair/rebuild, orphan blobs) when needed
