# V0.8 Testing Plan - Docker Worker Consolidation

**Created**: 25 JAN 2026
**Last Updated**: 29 JAN 2026
**Version**: 0.8.0.2
**Status**: IN PROGRESS
**Approver**: Robert Harrison
**Tester**: Claude + Robert

---

## Executive Summary

This document tracks comprehensive testing of the V0.8 Docker Worker Consolidation release. All test scenarios must pass before V0.8.0 is approved for deployment.

### V0.8 Doctrine (What We're Testing)

1. **Docker Worker is PRIMARY** for all heavy operations
2. **Vector ETL**: Always routes to Docker (`vector_docker_etl`)
3. **Raster ETL**: Single unified handler with automatic tiling decision
   - File â‰¤ 2GB â†’ Single COG output
   - File > 2GB â†’ Tiled output (multiple COGs with individual STAC items)
4. **Mount Behavior**:
   - Mount present â†’ Any file size, streaming I/O
   - Mount missing â†’ Degraded state (warning, not failure), reject >1GB
5. **Entity Architecture (V0.8.0.1)**:
   - `GeospatialAsset` is first-class entity tracking asset lifecycle
   - `clearance_level` mandatory for `/api/platform/approve` (V0.8 breaking change)
   - Dual-write: Updates both `DatasetApproval` (legacy) and `GeospatialAsset` (new)

---

## ðŸ› Bugs Found During Testing

| ID | Severity | Component | Description | Status | Found |
|----|----------|-----------|-------------|--------|-------|
| BUG-001 | MEDIUM | CoreMachine | `job_events` table fails to record events - `null value in column "event_id"` constraint violation. Events not being logged but jobs complete successfully. | **FIXED** | 26 JAN |
| BUG-002 | ~~MEDIUM~~ | Vector ETL | ~~KML parsing returns empty output~~ **NOT REPRODUCIBLE** - Retested 28 JAN with roads.kml: 483 rows imported successfully. Original issue may have been malformed test file or deployment state. | **CLOSED** | 26 JAN |
| BUG-006 | ~~HIGH~~ | Platform API | ~~Approval API returns 404~~ **NOT A BUG** - Endpoint works fine. Tested 28 JAN: `/api/platform/approvals` returns 3 pending approvals. QA report was from before deployment or wrong URL. | **CLOSED** | 27 JAN |
| BUG-003 | **HIGH** | Raster ETL | Disk-based COG processing skips CRS reprojection to EPSG:4326. COGs output in source CRS (e.g., EPSG:32750) instead of doctrine-required EPSG:4326. | **FIXED** | 27 JAN |
| BUG-004 | MEDIUM | Raster ETL | Dead code: MosaicJSON references remain in tiled raster workflow causing errors. MosaicJSON is deprecated and should be removed entirely. | **FIXED** | 27 JAN |
| BUG-005 | **HIGH** | Raster ETL | STAC collection result always empty for tiled jobs - contract mismatch between handler and service. Handler expects `{"success": True, "result": {...}}` but service returned data at top level. | **FIXED** | 27 JAN |
| BUG-007 | MEDIUM | Raster ETL | COGCreationData validation error in mount-based workflow - `source_blob` and `source_container` are None when using `_local_source_path`. | **FIXED** | 27 JAN |
| BUG-008 | **HIGH** | Raster ETL | Tiled workflow STAC fails - blob name mismatch. Handler passes `tile_0000.tif` but actual blob is `tile_0000_analysis.tif` (tier suffix added by raster_cog.py). STAC can't find tiles, returns "Could not read spatial extent from any tiles". | **FIXED** | 28 JAN |
| BUG-009 | **HIGH** | Vector ETL | `overwrite=true` does NOT truncate existing table. Resubmit with overwrite results in duplicate data (old + new rows). Table `acled_full_v8_testing_v10` has 5.1M rows (2x expected 2.57M) from two ETL batches. | **FIXED** âœ… | 27 JAN |
| BUG-010 | **HIGH** | UI/Raster | UI "Map" button and "View Collection Mosaic" do not open collection mosaic URL. They should load TiTiler pgstac search viewer, not individual TIF URLs. | **FIXED** (by BUG-011) | 28 JAN |
| BUG-011 | **HIGH** | STAC/TiTiler | Preview URLs for 3+ band imagery fail without `bidx=` parameters. TiTiler assumes 3 bands, sees more, returns HTTP 500. Single-band COGs work fine. | **FIXED** | 28 JAN |
| BUG-012 | **HIGH** | Platform/ETL | Overwrite race condition: async unpublish job deletes STAC item AFTER new ETL job creates it. Tables were "disappearing" after overwrite. | **FIXED** | 29 JAN |

### Bug Details

#### BUG-001: job_events event_id null constraint âœ… FIXED
**Error**:
```
null value in column "event_id" of relation "job_events" violates not-null constraint
DETAIL: Failing row contains (null, 4950fb4031cd..., STAGE_COMPLETED, ...)
```
**Impact**: Job events (STAGE_COMPLETED, JOB_COMPLETED) not recorded. Jobs complete successfully but event history is lost.
**Root Cause**: `PydanticToSQL` generator only detected SERIAL type for fields named exactly `id`. The `event_id` field was generated as `INTEGER PRIMARY KEY` instead of `SERIAL PRIMARY KEY`, so INSERT without explicit ID value resulted in NULL.
**Fix Applied** (v0.7.33.5 - pending deployment):
1. **Schema Generator** (`core/schema/sql_generator.py`): Added `__sql_serial_columns` metadata support with Python name-mangling awareness
2. **Model Metadata** (`core/models/job_event.py`): Added `__sql_serial_columns = ["event_id"]`
3. **Orthodox Compliance**: Added `IJobEventRepository` interface, `JobEventData` base contract, `ParamNames` event constants
**Post-Deploy Step**: Rebuild schema (first principles - no migrations in dev):
```bash
curl -X POST "https://rmhazuregeoapi-a3dma3ctfdgngwf6.eastus-01.azurewebsites.net/api/dbadmin/maintenance?action=rebuild&confirm=yes"
```
**Note**: JobEvent is already registered in `sql_generator.py` (lines 1567-1613). Rebuild will recreate the table with correct `SERIAL` type.
**Discovered**: During RAS-02 DTM raster test monitoring via Application Insights.

#### BUG-002: KML silent empty output âœ… CLOSED (Not Reproducible)
**Original Report**: Job shows `completed` status but output table has 0 rows.
**Retested**: 28 JAN 2026 - Job `0b5d84dc...` with roads.kml
**Result**: **483 rows imported successfully** âœ…
- Geometry type: MULTILINESTRING
- Table: `geo.roads_kml_v8_testing_v10`
- Vector tiles generated and working
**Conclusion**: Original issue was likely a malformed test file or transient deployment state. KML parsing works correctly.
**Status**: CLOSED - Not reproducible.

#### BUG-003: Disk-based COG skips CRS reprojection âœ… FIXED
**Error**: COG output in EPSG:32750 (UTM) instead of EPSG:4326 (WGS84).
**Impact**: COGs not in standard WGS84 projection, causing issues with TiTiler point queries and violating doctrine that all COGs should be EPSG:4326.
**Root Cause**: The disk-based processing path in `_process_cog_disk_based()` passed `dst_crs` in the `config` dict to `cog_translate()`, but this only works when input is a rasterio dataset object, not a file path string. Per [rio-cogeo documentation](https://github.com/cogeotiff/rio-cogeo/discussions/284), reprojection requires using `WarpedVRT` wrapper.
**Fix Applied** (v0.7.33.4):
- Use `WarpedVRT` to wrap input file when reprojection needed
- Read output metadata after reprojection to correctly report CRS
- Commit: `bb29794` - "Fix disk-based COG reprojection using WarpedVRT"
**Verification**: Tested with 3 rasters:
- EPSG:32750 (UTM 50S) â†’ EPSG:4326 âœ…
- EPSG:32648 (UTM 48N) â†’ EPSG:4326 âœ…
- EPSG:4326 (no reprojection) â†’ EPSG:4326 âœ…
**Discovered**: 26 JAN - During RAS-01 testing, job `7715b1f2...` output showed `proj:epsg: 32750` instead of 4326.

#### BUG-004: MosaicJSON dead code in tiled workflow âœ… FIXED
**Error**:
```
"cannot access local variable 'mosaicjson_url' where it is not associated with a value"
```
**Impact**: Tiled raster jobs complete but STAC integration shows `degraded: true` due to MosaicJSON reference errors.
**Root Cause**: In `stac_collection.py`, `mosaicjson_url` was only defined inside `if mosaicjson_blob:` block (line 359), but was referenced unconditionally in the return dict (line 628). V0.8 tiled workflow passes `mosaicjson_blob=None`, causing UnboundLocalError.
**Fix Applied** (v0.7.33.5 - pending deployment):
1. **stac_collection.py**: Initialize `mosaicjson_url = None` before conditional block
2. **stac_collection.py**: Removed `mosaicjson_url` from return dict (deprecated)
3. **Header updated**: REVIEW_STATUS reflects V0.8 MosaicJSON removal
**MosaicJSON Status After Fix**:
- âœ… V0.8 handlers (`handler_process_raster_complete.py`) - No MosaicJSON
- âš ï¸ Deprecated handlers (`handler_process_large_raster_complete.py`) - Still has MosaicJSON phase but handler is deprecated (remove in V0.9)
- âš ï¸ Legacy Function App jobs (`process_large_raster_v2.py`, `process_raster_collection_v2.py`) - Still have MosaicJSON stages (remove in V0.9)
**V0.8 Doctrine**: pgSTAC search provides mosaic access. search_id is the canonical way to access mosaics via TiTiler-PgSTAC.
**Discovered**: 27 JAN - During RAS-07 testing, job `a604a350...` (10.8 GB tiled) showed STAC error.

#### BUG-005: STAC collection result always empty for tiled jobs âœ… FIXED
**Symptom**: Job result shows `"stac": {}` empty dict despite STAC phase reporting success.
**Impact**: Tiled raster jobs complete successfully but STAC collection/items NOT created. No viewer_url, search_id, or collection metadata returned.
**Root Cause**: Contract mismatch between handler and service.
- Handler (`handler_process_raster_complete.py:439`): `stac_result = stac_response.get('result', {})`
- Service (`stac_collection.py`): Returns `{"success": True, "collection_id": ..., ...}` (data at TOP level)
- Result: Handler looks for `result` key, finds nothing, returns `{}`

**Wrong Pattern** (stac_collection.py):
```python
return {
    "success": True,
    "collection_id": collection_id,  # Data at top level - WRONG!
    ...
}
```

**Fixed Pattern** (v0.7.33.8):
```python
return {
    "success": True,
    "result": {  # Wrapped in "result" key - CORRECT!
        "collection_id": collection_id,
        ...
    }
}
```
**Discovered**: 27 JAN - Investigating job `596b035a...` (19.27 GB tiled) which showed `"stac": {}` despite 99 COGs created successfully.

#### BUG-006: Approval API returns 404 âœ… CLOSED (Not a Bug)
**Original Report**: QA team reports `/api/platform/approve` and `/api/platform/approvals` return 404.
**Retested**: 28 JAN 2026
**Result**: **Endpoint works correctly** âœ…
```bash
curl https://rmhazuregeoapi.../api/platform/approvals
# Returns: {"success": true, "approvals": [...], "count": 3}
```
- 3 pending approvals returned successfully
- All approval endpoints functional
**Conclusion**: QA report was from before deployment, testing wrong URL, or transient issue. Endpoints have been working correctly.
**Status**: CLOSED - Not a bug. Approval tests (APR-01 through APR-12) are UNBLOCKED.

#### BUG-007: COGCreationData validation error in mount-based workflow âœ… FIXED
**Error**:
```
2 validation errors for COGCreationData
source_blob Input should be a valid string, got None
source_container Input should be a valid string, got None
```
**Impact**: Mount-based tiled workflow fails at COG creation phase.
**Root Cause**: Handler passes `container_name: None, blob_name: None` when using `_local_source_path`. The Pydantic model `COGCreationData` requires non-null strings.
**Fix Applied** (v0.7.33.10): Added code in `raster_cog.py` to derive source info from `local_source_path` when blob info is None:
```python
if local_source_path and not blob_name:
    source_blob_name = PathLib(local_source_path).name
    source_container_name = "local-mount"  # Marker for local source mode
```
**Discovered**: 27 JAN - Job `7430fb81...` (4.4 GB tiled test).

#### BUG-008: Tiled workflow STAC fails - blob name mismatch âœ… FIXED
**Error**:
```
Could not read extent from 8c12e747/tile_0000.tif: '/vsiaz/silver-cogs/8c12e747/tile_0000.tif' does not exist
```
**Impact**: Tiled raster jobs create all COGs successfully but STAC phase fails because it can't find the tiles.
**Root Cause**: `raster_cog.py` adds tier suffix to blob name (e.g., `tile_0000.tif` â†’ `tile_0000_analysis.tif`), but `handler_process_raster_complete.py` was returning the original name without suffix to the STAC phase.
**Fix Applied** (v0.7.33.12):
1. Line 949 (resume path): Use tier-suffixed blob name
2. Line 1002 (normal path): Use `cog_result.get('cog_blob')` instead of original name
```python
# BUG-008 FIX: Use actual blob name from COG result (includes tier suffix)
actual_cog_blob = cog_result.get('cog_blob') or cog_blob_name
cog_blobs.append(actual_cog_blob)
```
**Discovered**: 28 JAN - Job `8c12e747...` (19.3 GB drone imagery), 99 tiles uploaded but STAC couldn't find them.

#### BUG-009: Vector ETL overwrite=true does NOT truncate table âœ… FIXED
**Error**: No error - job completes successfully but data is duplicated.
**Impact**: Resubmitting a vector job with `overwrite=true` results in duplicate data. Table contains old data + new data.
**Evidence**:
- Table `geo.acled_full_v8_testing_v10` has 5,141,688 rows (2x expected 2,570,844)
- Two ETL batches present: `15de18a7-chunk-*` (new job) and `70387be1-chunk-*` (old job)
- Both batches have 129 chunks each
**Root Cause**: The `overwrite=true` flag was NOT being used to truncate/drop the existing table before loading new data.
**Fix Applied** (v0.7.35.4 - 29 JAN 2026):
- `postgis_handler.py:1498-1509`: When `overwrite=true` AND table exists, DROP TABLE before CREATE
- Handler already had the logic, just wasn't being triggered correctly
**Verification**: Tested 29 JAN 2026
- Job `e810bc0d...` created table `geo.new_hexagons_v8_testing_v10` (3,301 rows)
- Job `79c3e3eb...` with `overwrite=true` â†’ table dropped and recreated (3,301 rows, NOT 6,602)
- Logs confirmed: `ðŸ—‘ï¸ Dropping existing table geo.new_hexagons_v8_testing_v10 (overwrite=true)`
**Discovered**: 27 JAN - Resubmit of acled_export.csv with overwrite=true.

#### BUG-012: Overwrite race condition - async unpublish deletes STAC after ETL creates it âœ… FIXED
**Error**: STAC item disappears after successful vector overwrite.
**Impact**: Vector overwrite completes successfully, but STAC item is deleted shortly after by async unpublish job.
**Root Cause**: Race condition in overwrite flow:
1. Platform layer submitted async `unpublish_vector` job to delete old table/STAC
2. Platform layer submitted new `vector_docker_etl` job
3. ETL job completed first â†’ table dropped, recreated, data loaded, STAC item created
4. Unpublish job ran AFTER ETL â†’ deleted the STAC item that was just created
**Fix Applied** (v0.7.35.4 - 29 JAN 2026):
- `triggers/platform/submit.py:67-115`: Remove async unpublish job for vector AND raster overwrite
- Vector: Handler drops table directly when `overwrite=true` (no race)
- Raster: Handler compares source checksums to decide action (no race)
- Platform layer now only deletes the platform request record, handler manages cleanup

**Verification - Vector**: Tested 29 JAN 2026
- Logs confirmed: `Overwrite vector: handler will drop table new_hexagons_v8_testing_v10 directly`
- No "submitted unpublish_vector job" message
- STAC item preserved: `â­ï¸ STEP 2: Item postgis-geo-new_hexagons_v8_testing_v10 already exists in PgSTAC - skipping insertion (idempotent)`

**Verification - Raster Checksum**: Tested 29 JAN 2026
- **Initial job**: `0c81cd89...` (tiny-raster2, 150MB, overwrite=true) â†’ full_reprocess (no prior checksum)
- **Overwrite job**: Same params with overwrite=true â†’ `action: "no_change"` in 4.1 seconds
- Handler detected identical source checksum (SHA-256 Multihash)
- Result: `"note": "Source data and metadata unchanged - no processing needed"`
- COG unchanged, artifact_id preserved (`c129f878-a58f-4404-9864-24fb2ef39471`)
- Execution: 4.1s (vs ~80s for full processing) - **95% faster for unchanged data**

**Three-way overwrite decision logic verified**:
| Source Checksum | Metadata Changed | Action | Time |
|-----------------|------------------|--------|------|
| Same | No | `no_change` - instant return | ~4s |
| Same | Yes (title/tags) | `metadata_only` - STAC update only | ~5s |
| Different | N/A | `full_reprocess` - new COG, delete old | ~80s |

**Discovered**: 29 JAN - During overwrite testing when tables were disappearing.

#### BUG-010: UI "Map" button doesn't open collection mosaic âœ… FIXED (by BUG-011)
**Symptom**: In the Function App UI Collections Browser:
- "Map" button on collection cards opens TiTiler but fails to render
- "View Collection Mosaic" in collection detail modal also shows error
- Both use correct pgstac `/searches/{search_id}/` URL but TiTiler fails for multi-band

**Root Cause**: Same as BUG-011. UI buttons work correctly - they open the `viewerUrl` from STAC collection's `rel="preview"` link. The URLs were just missing `bidx=` parameters for multi-band imagery.

**Fix**: BUG-011 fix adds `bidx=` params to preview URLs, which fixes this issue.

**Discovered**: 28 JAN - Testing RAS-05 collection viewer access from UI.

#### BUG-011: Preview URLs fail for 3+ band imagery without bidx= âœ… FIXED
**Symptom**: TiTiler returns HTTP 500 for multi-band COGs when `bidx=` not specified.

**Impact**: All multi-band satellite imagery (WorldView, etc.) fails to render in TiTiler viewers unless URL includes explicit band selection.

**Evidence**:
| Collection | Bands | Without bidx | With bidx=1&bidx=2&bidx=3 |
|------------|-------|--------------|---------------------------|
| giant-dsm-v8-testing-v10 | 1 (float32) | âœ… HTTP 200 | âœ… HTTP 200 |
| ras-05-v8-testing-v10 | 8 (uint16) | âŒ HTTP 500 | âœ… HTTP 200 |

**Root Cause**: TiTiler defaults to rendering bands 1,2,3 as RGB. When COG has more than 3 bands and no `bidx=` specified, rendering fails.

**Fix Applied** (28 JAN 2026):
1. **pgstac_search_registration.py**: Added `band_indexes` parameter to `get_search_urls()`
   - Generates URLs with `&bidx=1&bidx=2&bidx=3` for multi-band imagery
2. **stac_collection.py**: Pass `band_indexes` from `raster_meta.rgb_bands` when generating URLs
   - Uses existing `RasterVisualizationMetadata` which has band count and recommended RGB bands
   - Falls back to `[1,2,3]` for >3 band imagery without explicit rgb_bands

**Generated URL format**:
```
# Before (broken for 8-band):
.../searches/{search_id}/WebMercatorQuad/map.html?assets=data

# After (working):
.../searches/{search_id}/WebMercatorQuad/map.html?assets=data&bidx=1&bidx=2&bidx=3
```

**Note**: Fix applies to NEW collections created after deployment. Existing collections retain their original URLs without bidx params.

**Discovered**: 28 JAN - Testing RAS-05 (17apr2024wv2.tif, 8-band WorldView imagery).

---

## Test Environment

| Component | Value |
|-----------|-------|
| **Function App** | `rmhazuregeoapi` |
| **Docker Worker** | `rmhheavyapi` |
| **Base URL** | `https://rmhazuregeoapi-a3dma3ctfdgngwf6.eastus-01.azurewebsites.net` |
| **Docker URL** | `https://rmhheavyapi-ebdffqhkcsevg7f3.eastus-01.azurewebsites.net` |
| **Test Storage** | `rmhazuregeobronze` container |

### Pre-Test Setup

```bash
# Set base URLs for testing
export FA_URL="https://rmhazuregeoapi-a3dma3ctfdgngwf6.eastus-01.azurewebsites.net"
export DW_URL="https://rmhheavyapi-ebdffqhkcsevg7f3.eastus-01.azurewebsites.net"
```

---

## Test Categories

### Testing Priority Order

Tests are organized by **priority** - execute in order from Part A to Part B.

---

### PART A: Platform API (DDH Integration) - **EXECUTE FIRST**

These tests validate the external API that DDH calls in production. Based on `qa_test.md`.

| Category | Tests | Priority | Description |
|----------|-------|----------|-------------|
| [A.1 QA Critical Path](#a1-qa-critical-path-tests) | 28 | **P0 CRITICAL** | Submit â†’ Status â†’ Approve â†’ Unpublish â†’ Revoke workflow |
| [A.2 Platform Diagnostics](#a2-platform-diagnostics-tests) | 4 | P1 HIGH | Health, failures, lineage, validate |
| [A.3 Platform Catalog](#a3-platform-catalog-tests) | 4 | P1 HIGH | STAC catalog B2B access (âš ï¸ lookup signature under review) |
| [A.4 Platform Approval Admin](#a4-platform-approval-admin-tests) | 12 | P1 HIGH | List, filter, batch status, revoke approvals |

**Part A Total**: 48 tests

---

### PART B: Internal APIs - **EXECUTE SECOND**

These tests validate internal infrastructure, ETL processing, and debugging endpoints.

| Category | Tests | Priority | Description |
|----------|-------|----------|-------------|
| [B.1 Infrastructure](#b1-infrastructure-tests) | 8 | P1 HIGH | Health checks, queue verification |
| [B.2 Vector Docker ETL](#b2-vector-docker-etl-tests) | 12 | P1 HIGH | Vector format processing |
| [B.3 Raster Docker ETL](#b3-raster-docker-etl-tests) | 14 | P1 HIGH | Raster COG processing |
| [B.4 Database Verification](#b4-database-verification-tests) | 23 | P2 MEDIUM | Direct DB integrity checks |
| [B.5 Task-Level Tests](#b5-task-level-tests) | 10 | P2 MEDIUM | Task lifecycle monitoring |
| [B.6 Job Events](#b6-job-events-tests) | 10 | P2 MEDIUM | Event recording verification |
| [B.7 Mount Behavior](#b7-mount-behavior-tests) | 6 | P2 MEDIUM | ETL mount state handling |
| [B.8 Checkpoint/Resume](#b8-checkpointresume-tests) | 6 | P2 MEDIUM | Job recovery testing |
| [B.9 Routing Verification](#b9-routing-verification-tests) | 8 | P3 LOW | Queue routing validation |
| [B.10 Error Handling](#b10-error-handling-tests) | 8 | P3 LOW | Error response validation |
| [B.11 Regression](#b11-regression-tests) | 6 | P3 LOW | Backward compatibility |

**Part B Total**: 111 tests

---

**Grand Total**: 159 tests

---

### V0.8 Breaking Changes (Must Test)

| Change | Endpoint | Old Behavior | New Behavior |
|--------|----------|--------------|--------------|
| `clearance_level` mandatory | POST /api/platform/approve | Optional | **Required** - returns 400 if missing |
| `GeospatialAsset` entity | POST /api/platform/approve | Only DatasetApproval updated | Both DatasetApproval and GeospatialAsset updated |
| Overwrite race fix | POST /api/platform/submit (overwrite=true) | Created async unpublish job | Handler drops table directly (no race) |
| Catalog lookup | GET /api/platform/catalog/lookup | Current signature | âš ï¸ **Under review** - may change |

---

# PART A: Platform API (DDH Integration)

These tests follow the DDH workflow defined in `qa_test.md`. Execute these **first**.

---

## A.1 QA Critical Path Tests

The core DDH workflow: Submit â†’ Poll Status â†’ Approve â†’ Unpublish

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DDH â†’ GEOSPATIAL PLATFORM                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   User clicks              User clicks           User clicks            â”‚
â”‚   "Generate Services"      "Activate"            "Withdraw"             â”‚
â”‚         â”‚                      â”‚                      â”‚                 â”‚
â”‚         â–¼                      â–¼                      â–¼                 â”‚
â”‚   POST /submit            POST /approve         POST /unpublish         â”‚
â”‚         â”‚                      â”‚                      â”‚                 â”‚
â”‚         â–¼                      â”‚                      â”‚                 â”‚
â”‚   GET /status/{id}             â”‚                      â”‚                 â”‚
â”‚   (poll until complete)        â”‚                      â”‚                 â”‚
â”‚         â”‚                      â”‚                      â”‚                 â”‚
â”‚         â–¼                      â–¼                      â–¼                 â”‚
â”‚   Preview available       Services live         Services deleted        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### A.1.1 Submit Endpoint

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| QA-01 | Submit vector (GeoJSON) | POST /api/platform/submit | Returns request_id, job_id, job_type=vector_docker_etl | [ ] |
| QA-02 | Submit vector (CSV with lat/lon) | POST /api/platform/submit | Returns request_id, converter_params populated | [ ] |
| QA-03 | Submit raster (small) | POST /api/platform/submit | Returns request_id, job_type=process_raster_docker | [ ] |
| QA-04 | Submit with overwrite=true | POST /api/platform/submit | Handler drops/replaces data directly, new job created | [x] âœ… 29 JAN - BUG-012 fixed race condition |
| QA-05 | Idempotent resubmit | POST /api/platform/submit (same IDs) | Returns existing request (no new job) | [ ] |
| QA-06 | Invalid file extension | POST /api/platform/submit (.doc) | Returns 400 with format error | [ ] |
| QA-07 | Missing required field | POST /api/platform/submit (no dataset_id) | Returns 400 with validation error | [ ] |
| QA-08 | File not found | POST /api/platform/submit (non-existent blob) | Returns 400 with blob not found error | [ ] |

### A.1.2 Status Endpoint

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| QA-09 | Poll status (processing) | GET /api/platform/status/{request_id} | Returns job_status=processing, job_stage | [ ] |
| QA-10 | Poll status (completed) | GET /api/platform/status/{request_id} | Returns job_status=completed, job_result with URLs | [ ] |
| QA-11 | Status by job_id | GET /api/platform/status/{job_id} | Auto-detects job_id format, returns status | [ ] |
| QA-12 | Non-existent ID | GET /api/platform/status/invalid-id | Returns 404 or helpful error | [ ] |

### A.1.3 Approve Endpoint

**V0.8 Breaking Change**: `clearance_level` is now **mandatory** for approve endpoint.

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| QA-13 | Approve by request_id (OUO) | POST /api/platform/approve | Returns success, status=approved, clearance_level=ouo | [ ] |
| QA-14 | Approve by job_id (PUBLIC) | POST /api/platform/approve | Returns success, adf_run_id populated | [ ] |
| QA-15 | Approve missing clearance_level | POST /api/platform/approve (no clearance) | Returns 400: "clearance_level is required" | [ ] |
| QA-16 | Approve invalid clearance_level | POST /api/platform/approve (clearance="invalid") | Returns 400: "Must be 'ouo' or 'public'" | [ ] |
| QA-17 | Approve already approved | POST /api/platform/approve (same) | Idempotent success or appropriate message | [ ] |
| QA-18 | Approve invalid ID | POST /api/platform/approve (bad ID) | Returns error with helpful message | [ ] |
| QA-19 | Approve updates GeospatialAsset | POST /api/platform/approve | Response includes asset_id, asset_updated=true | [ ] |

### A.1.4 Unpublish Endpoint

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| QA-20 | Unpublish by request_id | POST /api/platform/unpublish | Returns success, monitor_url | [ ] |
| QA-21 | Unpublish by job_id | POST /api/platform/unpublish | Returns success, monitor_url | [ ] |
| QA-22 | Unpublish by DDH IDs | POST /api/platform/unpublish (dataset/resource/version) | Auto-detects, unpublishes | [ ] |
| QA-23 | Unpublish dry_run | POST /api/platform/unpublish (dry_run: true) | Returns what would be deleted, no action | [ ] |
| QA-24 | Unpublish non-existent | POST /api/platform/unpublish (invalid) | Returns appropriate error | [ ] |

### A.1.5 End-to-End Workflow

| ID | Test | Scenario | Expected | Status |
|----|------|----------|----------|--------|
| QA-25 | Vector E2E | Submit â†’ Poll â†’ Approve (clearance_level) â†’ Verify STAC | Full workflow completes | [ ] |
| QA-26 | Raster E2E | Submit â†’ Poll â†’ Approve (clearance_level) â†’ Verify STAC | Full workflow completes | [ ] |
| QA-27 | Overwrite E2E | Submit â†’ Complete â†’ Submit (overwrite) â†’ Complete | Data replaced, URLs stable | [x] âœ… 29 JAN - Vector: new_hexagons table dropped & recreated, STAC preserved. Raster: tiny-raster2 checksum match â†’ `no_change` in 4.1s, artifact preserved |
| QA-28 | Revoke E2E | Submit â†’ Approve â†’ Revoke â†’ Verify status=revoked | Approval reversed, data preserved | [ ] |

### QA Critical Path Test Commands

```bash
# QA-01: Submit vector
REQUEST=$(curl -s -X POST "$FA_URL/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "qa-test-vector",
    "resource_id": "roads-test",
    "version_id": "v1",
    "container_name": "rmhazuregeobronze",
    "file_name": "roads.gpkg",
    "title": "QA Test Roads",
    "access_level": "ouo"
  }')
echo "$REQUEST" | jq .
REQUEST_ID=$(echo "$REQUEST" | jq -r '.request_id')
JOB_ID=$(echo "$REQUEST" | jq -r '.job_id')

# QA-09/10: Poll status until complete
while true; do
  STATUS=$(curl -s "$FA_URL/api/platform/status/$REQUEST_ID")
  JOB_STATUS=$(echo "$STATUS" | jq -r '.job_status')
  echo "Status: $JOB_STATUS"
  if [ "$JOB_STATUS" = "completed" ] || [ "$JOB_STATUS" = "failed" ]; then
    echo "$STATUS" | jq .
    break
  fi
  sleep 30
done

# QA-13: Approve (V0.8: clearance_level is MANDATORY)
curl -s -X POST "$FA_URL/api/platform/approve" \
  -H "Content-Type: application/json" \
  -d "{\"request_id\": \"$REQUEST_ID\", \"reviewer\": \"qa@test.com\", \"clearance_level\": \"ouo\"}" | jq .

# QA-15: Approve missing clearance_level (should fail)
curl -s -X POST "$FA_URL/api/platform/approve" \
  -H "Content-Type: application/json" \
  -d "{\"request_id\": \"$REQUEST_ID\", \"reviewer\": \"qa@test.com\"}" | jq .
# Expected: 400 - "clearance_level is required (V0.8)"

# QA-20: Unpublish (when done testing)
curl -s -X POST "$FA_URL/api/platform/unpublish" \
  -H "Content-Type: application/json" \
  -d "{\"request_id\": \"$REQUEST_ID\"}" | jq .
```

---

## A.2 Platform Diagnostics Tests

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| PLT-01 | Platform health | GET /api/platform/health | Returns ready_for_jobs, simplified status | [ ] |
| PLT-02 | Platform failures | GET /api/platform/failures?hours=24 | Returns sanitized failure summaries | [ ] |
| PLT-03 | Platform lineage | GET /api/platform/lineage/{request_id} | Returns sourceâ†’processingâ†’output trace | [ ] |
| PLT-04 | Pre-flight validate | POST /api/platform/validate | Returns file exists, size, recommended job_type | [ ] |

### Platform Diagnostics Test Commands

```bash
# PLT-01: Platform health
curl -s "$FA_URL/api/platform/health" | jq .

# PLT-02: Platform failures
curl -s "$FA_URL/api/platform/failures?hours=24&limit=10" | jq .

# PLT-03: Platform lineage (use request_id from submit)
curl -s "$FA_URL/api/platform/lineage/$REQUEST_ID" | jq .

# PLT-04: Pre-flight validation
curl -s -X POST "$FA_URL/api/platform/validate" \
  -H "Content-Type: application/json" \
  -d '{
    "data_type": "raster",
    "container_name": "rmhazuregeobronze",
    "blob_name": "2021_Luang_Prabang_DTM.tif"
  }' | jq .
```

---

## A.3 Platform Catalog Tests

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| PLT-05 | Catalog lookup | GET /api/platform/catalog/lookup?dataset_id=X&resource_id=Y&version_id=Z | Returns STAC item if exists | [ ] |
| PLT-06 | Catalog item | GET /api/platform/catalog/item/{collection}/{item_id} | Returns full STAC item GeoJSON | [ ] |
| PLT-07 | Catalog assets | GET /api/platform/catalog/assets/{collection}/{item_id} | Returns asset URLs with TiTiler URLs | [ ] |
| PLT-08 | Catalog dataset | GET /api/platform/catalog/dataset/{dataset_id} | Returns all items for dataset | [ ] |

### Platform Catalog Test Commands

```bash
# PLT-05: Catalog lookup
curl -s "$FA_URL/api/platform/catalog/lookup?dataset_id=qa-test-vector&resource_id=roads-test&version_id=v1" | jq .

# PLT-06: Catalog item
curl -s "$FA_URL/api/platform/catalog/item/qa-test-vector/qa-test-vector-roads-test-v1" | jq .

# PLT-07: Catalog assets
curl -s "$FA_URL/api/platform/catalog/assets/qa-test-vector/qa-test-vector-roads-test-v1" | jq .

# PLT-08: Catalog dataset
curl -s "$FA_URL/api/platform/catalog/dataset/qa-test-vector" | jq .
```

---

## A.4 Approval Admin Tests

Testing the approval lifecycle including revoke workflow.

### A.4.1 List and Filter Approvals

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| APR-01 | List all approvals | GET /api/platform/approvals | Returns approvals array, status_counts | [ ] |
| APR-02 | Filter by status=pending | GET /api/platform/approvals?status=pending | Only pending approvals returned | [ ] |
| APR-03 | Filter by status=approved | GET /api/platform/approvals?status=approved | Only approved approvals returned | [ ] |
| APR-04 | Get approval by ID | GET /api/platform/approvals/{approval_id} | Returns full approval details | [ ] |

### A.4.2 Batch Status Lookup

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| APR-05 | Batch status by STAC items | GET /api/platform/approvals/status?stac_item_ids=a,b,c | Returns status map | [ ] |
| APR-06 | Batch status by table names | GET /api/platform/approvals/status?table_names=tbl1,tbl2 | Returns status map with stac_item_id | [ ] |

### A.4.3 Revoke Workflow

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| APR-07 | Revoke by approval_id | POST /api/platform/revoke | Returns success, status=revoked | [ ] |
| APR-08 | Revoke by job_id | POST /api/platform/revoke | Returns success, status=revoked | [ ] |
| APR-09 | Revoke missing reason | POST /api/platform/revoke (no reason) | Returns 400: "reason is required" | [ ] |
| APR-10 | Revoke missing revoker | POST /api/platform/revoke (no revoker) | Returns 400: "revoker is required" | [ ] |
| APR-11 | Revoke non-approved | POST /api/platform/revoke (pending item) | Returns error: "status is 'pending', expected 'approved'" | [ ] |
| APR-12 | Re-approve after revoke | POST /api/platform/approve (revoked item) | Returns success, status=approved | [ ] |

### Approval Admin Test Commands

```bash
# APR-01: List all approvals
curl -s "$FA_URL/api/platform/approvals" | jq .

# APR-02: Filter pending
curl -s "$FA_URL/api/platform/approvals?status=pending" | jq .

# APR-04: Get approval by ID
curl -s "$FA_URL/api/platform/approvals/apr-abc123" | jq .

# APR-05: Batch status lookup
curl -s "$FA_URL/api/platform/approvals/status?stac_item_ids=item1,item2,item3" | jq .

# APR-07: Revoke approval (V0.8: reason is MANDATORY)
curl -s -X POST "$FA_URL/api/platform/revoke" \
  -H "Content-Type: application/json" \
  -d '{
    "approval_id": "apr-abc123",
    "revoker": "admin@test.com",
    "reason": "Data quality issue found"
  }' | jq .

# APR-09: Revoke missing reason (should fail)
curl -s -X POST "$FA_URL/api/platform/revoke" \
  -H "Content-Type: application/json" \
  -d '{
    "approval_id": "apr-abc123",
    "revoker": "admin@test.com"
  }' | jq .
# Expected: 400 - "reason is required for audit trail"

# APR-12: Re-approve after revoke
curl -s -X POST "$FA_URL/api/platform/approve" \
  -H "Content-Type: application/json" \
  -d '{
    "approval_id": "apr-abc123",
    "reviewer": "admin@test.com",
    "clearance_level": "ouo"
  }' | jq .
```

---

# PART B: Internal APIs

These tests validate internal infrastructure, ETL processing, and debugging endpoints.

---

## B.1 Infrastructure Tests

### B.1.1 Health Checks

| ID | Test | Command | Expected | Status |
|----|------|---------|----------|--------|
| INF-01 | Function App health | `curl $FA_URL/api/health` | `{"status": "healthy"}` | [x] âœ… 26 JAN |
| INF-02 | Docker Worker health | `curl $DW_URL/health` | `{"status": "healthy"}` | [x] âœ… 26 JAN |
| INF-03 | Docker Worker readiness | `curl $DW_URL/readyz` | `{"ready": true}` | [x] âœ… 26 JAN |
| INF-04 | Database connectivity | Health endpoint database component | PostgreSQL connected | [x] âœ… 26 JAN |

### B.1.2 Queue Infrastructure

| ID | Test | Command | Expected | Status |
|----|------|---------|----------|--------|
| INF-05 | container-tasks queue exists | Azure Portal or `az servicebus queue show` | Queue exists | [x] âœ… 26 JAN |
| INF-06 | functionapp-tasks queue exists | Azure Portal or `az servicebus queue show` | Queue exists | [x] âœ… 26 JAN |
| INF-07 | Docker listens to container-tasks | Check Docker health endpoint | `queue_name: container-tasks` | [x] âœ… 26 JAN |
| INF-08 | FA listens to functionapp-tasks | Check FA health endpoint | `queues_listening.functionapp_tasks: true` | [x] âœ… 26 JAN |

### B.1 Infrastructure Test Commands

```bash
# INF-01: Function App health
curl -s "$FA_URL/api/health" | jq .

# INF-02: Docker Worker health
curl -s "$DW_URL/health" | jq .

# INF-03: Docker Worker readiness
curl -s "$DW_URL/readyz" | jq .

# INF-04: Database stats
curl -s "$FA_URL/api/dbadmin/stats" | jq .

# INF-05/06: Check queues (requires az cli)
az servicebus queue show --name container-tasks --namespace-name rmhaborservicebus --query "name" -o tsv
az servicebus queue show --name functionapp-tasks --namespace-name rmhaborservicebus --query "name" -o tsv
```

---

## B.2 Vector Docker ETL Tests

### Test Data Requirements (VERIFIED 25 JAN 2026)

| File | Size | Format | Location | Test Use |
|------|------|--------|----------|----------|
| `roads.kml` | 0.35 MB | KML | rmhazuregeobronze/ | Small vector |
| `roads.zip` | 0.05 MB | Shapefile | rmhazuregeobronze/ | Small vector |
| `roads.gpkg` | 0.22 MB | GeoPackage | rmhazuregeobronze/ | Small vector |
| `acled_test.csv` | 2.83 MB | CSV | rmhazuregeobronze/ | Small CSV |
| `World_Bank_Global_Administrative_Divisions.geojson` | 136.81 MB | GeoJSON | rmhazuregeobronze/ | Large vector |
| `acled_export.csv` | 1,333.60 MB | CSV | rmhazuregeobronze/ | XLarge CSV |

### B.2.1 Basic Functionality

| ID | Test | Input | Expected | Status |
|----|------|-------|----------|--------|
| VEC-01 | Small KML ETL | roads.kml (0.35 MB) | Table created, STAC item | [x] âœ… 28 JAN - 483 rows imported, MULTILINESTRING geometry. Job `0b5d84dc...` |
| VEC-02 | Small Shapefile ETL | roads.zip (0.05 MB) | Table created, STAC item | [x] âœ… 26 JAN - 483 rows, MULTILINESTRING, Docker execution confirmed |
| VEC-03 | Small GeoPackage ETL | roads.gpkg (0.22 MB) | Table created, STAC item | [x] âœ… 26 JAN - 483 rows, MULTILINESTRING, Docker execution confirmed |
| VEC-04 | Large GeoJSON ETL | World_Bank_Global_Administrative_Divisions.geojson (137 MB) | Completes, checkpoints logged | [ ] |
| VEC-05 | CSV with lat/lon | acled_test.csv (2.83 MB) | Point geometry created | [ ] |
| VEC-06 | XLarge CSV ETL | acled_export.csv (1.3 GB) | Completes without timeout | [x] âœ… 27 JAN - 2,570,844 rows, 129 chunks, MULTIPOINT, ~16 min. **BUG-009 FIXED** (v0.7.35.4) |

### B.2.2 Geometry Handling

| ID | Test | Input | Expected | Status |
|----|------|-------|----------|--------|
| VEC-07 | Polygon geometry | World_Bank (polygons) | geometry_type = POLYGON/MULTIPOLYGON | [ ] |
| VEC-08 | LineString geometry | roads.kml (lines) | geometry_type = LINESTRING | [x] âœ… 26 JAN - MULTILINESTRING (promoted from LineString by geopandas) |
| VEC-09 | Point geometry | acled_test.csv (points) | geometry_type = POINT | [ ] |
| VEC-10 | CRS auto-detection | Any source | Correctly reprojects to EPSG:4326 | [ ] |

### B.2.3 STAC Integration

| ID | Test | Validation | Expected | Status |
|----|------|------------|----------|--------|
| VEC-11 | STAC item created | Query pgstac | Item exists with correct bbox | [ ] |
| VEC-12 | Collection assignment | Check item.collection | Matches collection_id param | [ ] |

### B.2 Vector Test Commands

```bash
# VEC-01: Small KML
curl -X POST "$FA_URL/api/jobs/submit/vector_docker_etl" \
  -H "Content-Type: application/json" \
  -d '{
    "source_url": "https://rmhazuregeo.blob.core.windows.net/rmhazuregeobronze/roads.kml",
    "table_name": "test_vec_01_kml",
    "collection_id": "v08-vector-tests",
    "overwrite": true
  }'

# VEC-02: Small Shapefile (zip)
curl -X POST "$FA_URL/api/jobs/submit/vector_docker_etl" \
  -H "Content-Type: application/json" \
  -d '{
    "source_url": "https://rmhazuregeo.blob.core.windows.net/rmhazuregeobronze/roads.zip",
    "table_name": "test_vec_02_shp",
    "collection_id": "v08-vector-tests",
    "overwrite": true
  }'

# VEC-03: Small GeoPackage
curl -X POST "$FA_URL/api/jobs/submit/vector_docker_etl" \
  -H "Content-Type: application/json" \
  -d '{
    "source_url": "https://rmhazuregeo.blob.core.windows.net/rmhazuregeobronze/roads.gpkg",
    "table_name": "test_vec_03_gpkg",
    "collection_id": "v08-vector-tests",
    "overwrite": true
  }'

# VEC-04: Large GeoJSON (World Bank Admin Divisions - 137MB)
curl -X POST "$FA_URL/api/jobs/submit/vector_docker_etl" \
  -H "Content-Type: application/json" \
  -d '{
    "source_url": "https://rmhazuregeo.blob.core.windows.net/rmhazuregeobronze/World_Bank_Global_Administrative_Divisions.geojson",
    "table_name": "test_vec_04_worldbank",
    "collection_id": "v08-vector-tests",
    "overwrite": true
  }'

# VEC-05: CSV with lat/lon (ACLED test - 2.8MB)
curl -X POST "$FA_URL/api/jobs/submit/vector_docker_etl" \
  -H "Content-Type: application/json" \
  -d '{
    "source_url": "https://rmhazuregeo.blob.core.windows.net/rmhazuregeobronze/acled_test.csv",
    "table_name": "test_vec_05_acled_small",
    "collection_id": "v08-vector-tests",
    "lat_column": "latitude",
    "lon_column": "longitude",
    "overwrite": true
  }'

# VEC-06: XLarge CSV (ACLED export - 1.3GB)
curl -X POST "$FA_URL/api/jobs/submit/vector_docker_etl" \
  -H "Content-Type: application/json" \
  -d '{
    "source_url": "https://rmhazuregeo.blob.core.windows.net/rmhazuregeobronze/acled_export.csv",
    "table_name": "test_vec_06_acled_full",
    "collection_id": "v08-vector-tests",
    "lat_column": "latitude",
    "lon_column": "longitude",
    "overwrite": true
  }'

# Check job status (replace JOB_ID)
curl -s "$FA_URL/api/jobs/status/{JOB_ID}" | jq .

# Verify table row count
curl -s "$FA_URL/api/features/collections/test_vec_01_kml" | jq '.numberMatched'

# Verify STAC item
curl -s "$FA_URL/api/stac/collections/v08-vector-tests/items" | jq '.features | length'
```

---

## B.3 Raster Docker ETL Tests

### Test Data Requirements (VERIFIED 25 JAN 2026)

| File | Size | Category | Location | Test Use |
|------|------|----------|----------|----------|
| `25FEB02023857-S2AS-200007488011_01_P001.TIF` | 359.73 MB | Small | rmhazuregeobronze/ | Single COG |
| `2021_Luang_Prabang_DTM.tif` | 985.99 MB | Medium | rmhazuregeobronze/ | Single COG |
| `22FEB01105201-S2AS_R1C1-200007559860_01_P001.TIF` | 1,318.56 MB | Large | rmhazuregeobronze/ | Single COG (disk) |
| `17apr2024wv2.tif` | 4,449.54 MB | XLarge | rmhazuregeobronze/ | Tiled output |
| `2024APR17WV2.tif` | 8,044.86 MB | XLarge | rmhazuregeobronze/ | Tiled output |
| `2022DEC21WV2.tif` | 10,792.99 MB | XXLarge | rmhazuregeobronze/ | Tiled output |
| `antigua.tif` | 11,161.39 MB | XXLarge | rmhazuregeobronze/ | Tiled output |

**Note**: 2GB tiling threshold means files >2GB will auto-tile.

### B.3.1 Single COG Output (â‰¤2GB threshold)

| ID | Test | Input | Expected | Status |
|----|------|-------|----------|--------|
| RAS-01 | Small raster COG | 25FEB02023857...P001.TIF (360 MB) | Single COG, `output_mode: "single_cog"` | [x] âœ… 27 JAN - Job `7715b1f2...`, 459 MB output, 68s processing |
| RAS-02 | Medium raster COG | 2021_Luang_Prabang_DTM.tif (986 MB) | Single COG, valid Cloud-Optimized | [x] âœ… 27 JAN - Job `4950fb40...`, 973 MB output, 243s, DEM auto-detected |
| RAS-03 | Large raster COG | 22FEB01105201...P001.TIF (1.3 GB) | Single COG (disk-based processing) | [x] âœ… 27 JAN - Job `c76b664e...`, 1698 MB output, 473s, disk-based processing, 8 bands |
| RAS-04 | STAC item created | Any output | Item in pgstac with correct metadata | [x] âœ… 27 JAN - Job `7715b1f2...`, `inserted_to_pgstac: true`, item_id: `small-raster-test-v8-v8-testing-v10` |

### B.3.2 Tiled Output (>2GB threshold)

| ID | Test | Input | Expected | Status |
|----|------|-------|----------|--------|
| RAS-05 | 4GB raster tiling | 17apr2024wv2.tif (4.4 GB) | `output_mode: "tiled"`, N tiles | [ ] |
| RAS-06 | 8GB raster tiling | 2024APR17WV2.tif (8 GB) | Tiled output, larger N | [ ] |
| RAS-07 | 10GB raster tiling | 2022DEC21WV2.tif (10.8 GB) | Tiled output, many tiles | [x] âœ… 27 JAN - Job `a604a350...`, 12 tiles (3Ã—4 grid), 16.1 min, multi-instance parallelism confirmed |
| RAS-08 | STAC items for tiles | Tiled output | Individual STAC items for each tile COG | [ ] BLOCKED by BUG-004 (MosaicJSON removal needed) |

**Note**: RAS-09 (TiTiler mosaic viewer) REMOVED - MosaicJSON is deprecated and being removed from the app (see BUG-004).

### B.3.3 Metadata & Validation

| ID | Test | Validation | Expected | Status |
|----|------|------------|----------|--------|
| RAS-10 | Bands preserved | Compare input/output | Same band count | [x] âœ… 27 JAN - Job `7715b1f2...`, 8 bands in â†’ 8 bands out |
| RAS-11 | CRS reprojection to 4326 | Check output CRS | **Always EPSG:4326** (doctrine) | [x] âœ… 27 JAN - BUG-003 fixed, verified with 3 test jobs |
| RAS-12 | NoData handled | Check output nodata | Preserved from input | [ ] |
| RAS-13 | TiTiler COG viewer | Single COG | `/cog/viewer?url=...` works | [~] âš ï¸ PARTIAL - TiTiler URLs work. BUG-010/011 FIXED (pending deploy) - will add bidx for multi-band |
| RAS-14 | COG validation | `rio cogeo validate` | Valid Cloud-Optimized GeoTIFF | [ ] |
| RAS-15 | cog_metadata populated | Query `app.cog_metadata` | Row exists with width, height, band_count, crs | [ ] |

### B.3 Raster Test Commands

```bash
# RAS-01: Small raster (360MB)
curl -X POST "$FA_URL/api/jobs/submit/process_raster_docker" \
  -H "Content-Type: application/json" \
  -d '{
    "container_name": "rmhazuregeobronze",
    "blob_name": "6672805950159176487/200007488011_01/200007488011_01_P001_PSH/25FEB02023857-S2AS-200007488011_01_P001.TIF",
    "collection_id": "v08-raster-tests"
  }'

# RAS-02: Medium raster (986MB DTM)
curl -X POST "$FA_URL/api/jobs/submit/process_raster_docker" \
  -H "Content-Type: application/json" \
  -d '{
    "container_name": "rmhazuregeobronze",
    "blob_name": "2021_Luang_Prabang_DTM.tif",
    "collection_id": "v08-raster-tests"
  }'

# RAS-03: Large raster (1.3GB - disk-based processing)
curl -X POST "$FA_URL/api/jobs/submit/process_raster_docker" \
  -H "Content-Type: application/json" \
  -d '{
    "container_name": "rmhazuregeobronze",
    "blob_name": "6679514889821629394/200007559860_01/200007559860_01_P001_PSH/22FEB01105201-S2AS_R1C1-200007559860_01_P001.TIF",
    "collection_id": "v08-raster-tests"
  }'

# RAS-05: 4.4GB raster (triggers tiling)
curl -X POST "$FA_URL/api/jobs/submit/process_raster_docker" \
  -H "Content-Type: application/json" \
  -d '{
    "container_name": "rmhazuregeobronze",
    "blob_name": "17apr2024wv2.tif",
    "collection_id": "v08-raster-tiled-tests"
  }'

# RAS-06: 8GB raster (large tiled output)
curl -X POST "$FA_URL/api/jobs/submit/process_raster_docker" \
  -H "Content-Type: application/json" \
  -d '{
    "container_name": "rmhazuregeobronze",
    "blob_name": "2024APR17WV2.tif",
    "collection_id": "v08-raster-tiled-tests"
  }'

# RAS-07: 10.8GB raster (XXL tiled output)
curl -X POST "$FA_URL/api/jobs/submit/process_raster_docker" \
  -H "Content-Type: application/json" \
  -d '{
    "container_name": "rmhazuregeobronze",
    "blob_name": "2022DEC21WV2.tif",
    "collection_id": "v08-raster-tiled-tests"
  }'

# Check job status (replace JOB_ID)
curl -s "$FA_URL/api/jobs/status/{JOB_ID}" | jq .

# Check STAC items (single COG tests)
curl -s "$FA_URL/api/stac/collections/v08-raster-tests/items" | jq '.features | length'

# Check STAC collections (tiled tests create collections)
curl -s "$FA_URL/api/stac/collections/v08-raster-tiled-tests/items" | jq '.features | length'

# RAS-15: Verify cog_metadata populated (F7.9 RasterMetadata integration)
# Run after any RAS-01 through RAS-04 completes
curl -s "$FA_URL/api/dbadmin/diagnostics/all" | jq '.cog_metadata_count'
# Or query directly:
# SELECT item_id, width, height, band_count, crs, collection_id
# FROM app.cog_metadata WHERE collection_id = 'v08-raster-tests'
```

---

## B.7 Mount Behavior Tests

### B.7.1 Mount Present (Normal State)

| ID | Test | Condition | Expected | Status |
|----|------|-----------|----------|--------|
| MNT-01 | Health shows mount status | Mount enabled | `mount_status: "healthy"` | [ ] |
| MNT-02 | Large file processes | 1.3GB raster | Completes via disk streaming | [ ] |
| MNT-03 | Temp files cleaned | After processing | `/mounts/etl-temp` empty | [ ] |

### B.7.2 Mount Missing (Degraded State)

| ID | Test | Condition | Expected | Status |
|----|------|-----------|----------|--------|
| MNT-04 | Health shows degraded | Mount disabled | `mount_status: "degraded"` (not unhealthy) | [ ] |
| MNT-05 | Small file processes | 500MB raster | Completes (in-memory fallback) | [ ] |
| MNT-06 | Large file rejected | >1GB raster | Rejected with clear error message | [ ] |

### B.7 Mount Test Commands

```bash
# MNT-01: Check mount status in health
curl -s "$DW_URL/health" | jq '.mount_status'

# MNT-04: Verify degraded warning in logs (when mount disabled)
# Check Application Insights for:
# "Mount not present - operating in degraded mode"

# MNT-06: Test rejection >1GB without mount
# (Requires temporarily disabling mount - coordinate with Robert)
```

---

## B.8 Checkpoint/Resume Tests

### B.8.1 Vector Checkpoint Tests

| ID | Test | Scenario | Expected | Status |
|----|------|----------|----------|--------|
| CHK-01 | Checkpoint logging | Submit 100K vector | Checkpoints visible in logs | [ ] |
| CHK-02 | Progress tracking | Submit 100K vector | `progress_pct` updates at 25/50/75/100 | [ ] |
| CHK-03 | Resume after failure | Kill Docker mid-job | Resumes from last chunk on restart | [ ] |

### B.8.2 Raster Checkpoint Tests

| ID | Test | Scenario | Expected | Status |
|----|------|----------|----------|--------|
| CHK-04 | Checkpoint logging | Submit large raster | Phase checkpoints in logs | [ ] |
| CHK-05 | Resume validation phase | Kill after validation | Skips validation on resume | [ ] |
| CHK-06 | Resume COG phase | Kill during COG creation | Restarts COG (idempotent) | [ ] |

### B.8 Checkpoint Test Commands

```bash
# CHK-01/02: Submit large vector and watch logs
curl -X POST "$FA_URL/api/jobs/submit/vector_docker_etl" \
  -H "Content-Type: application/json" \
  -d '{
    "source_url": "https://rmhazuregeobronze.blob.core.windows.net/bronze/test-data/test_large.gpkg",
    "table_name": "test_chk_01",
    "collection_id": "v08-checkpoint-tests",
    "overwrite": true
  }'

# Then monitor Docker worker logs for:
# - "Checkpoint: validated"
# - "Checkpoint: table_created"
# - "Checkpoint: chunk_0"
# - "Progress: 25%"
# etc.

# CHK-03: Resume test
# 1. Submit large job
# 2. Note job_id
# 3. Restart Docker worker mid-processing:
#    az webapp restart --name rmhheavyapi --resource-group rmhazure_rg
# 4. Check if job resumes from last checkpoint
```

---

## B.9 Routing Verification Tests

### B.9.1 Task Queue Routing

| ID | Test | Job Type | Expected Queue | Status |
|----|------|----------|----------------|--------|
| RTE-01 | hello_world routing | hello_world | functionapp-tasks | [ ] |
| RTE-02 | vector_docker_etl routing | vector_docker_etl | container-tasks | [ ] |
| RTE-03 | process_raster_docker routing | process_raster_docker | container-tasks | [ ] |
| RTE-04 | inventory routing | container_inventory | functionapp-tasks | [ ] |

### B.9.2 Platform Endpoint Routing

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| RTE-05 | Platform vector submit | POST /platform/submit (vector) | Routes to vector_docker_etl | [ ] |
| RTE-06 | Platform raster submit | POST /platform/submit (raster) | Routes to process_raster_docker | [ ] |
| RTE-07 | Force functionapp override | ?force_functionapp=true | Routes to functionapp-tasks | [ ] |
| RTE-08 | Override only on admin | /platform/* with override | Override ignored (security) | [ ] |

### B.9 Routing Test Commands

```bash
# RTE-01: hello_world (should go to functionapp-tasks)
curl -X POST "$FA_URL/api/jobs/submit/hello_world" \
  -H "Content-Type: application/json" \
  -d '{"message": "routing test"}'
# Check Service Bus: message should appear in functionapp-tasks

# RTE-02: vector_docker_etl (should go to container-tasks)
curl -X POST "$FA_URL/api/jobs/submit/vector_docker_etl" \
  -H "Content-Type: application/json" \
  -d '{
    "source_url": "https://example.com/test.geojson",
    "table_name": "routing_test",
    "collection_id": "test"
  }'
# Check Service Bus: message should appear in container-tasks

# RTE-07: Force functionapp override (admin only)
curl -X POST "$FA_URL/api/admin/jobs/submit/process_raster_docker?force_functionapp=true" \
  -H "Content-Type: application/json" \
  -d '{...}'
# Check logs for: "Admin override: routing to functionapp-tasks"
```

---

## B.10 Error Handling Tests

### B.10.1 Input Validation Errors

| ID | Test | Invalid Input | Expected Error | Status |
|----|------|---------------|----------------|--------|
| ERR-01 | Missing required param | No table_name | 400 with clear message | [ ] |
| ERR-02 | Invalid source URL | Non-existent blob | Task fails with BlobNotFound | [ ] |
| ERR-03 | Invalid geometry | Corrupt GeoJSON | Task fails with geometry error | [ ] |
| ERR-04 | Unsupported format | .doc file | Task fails with format error | [ ] |

### B.10.2 Processing Errors

| ID | Test | Scenario | Expected | Status |
|----|------|----------|----------|--------|
| ERR-05 | Database connection loss | Simulate DB down | Task retries, then fails gracefully | [ ] |
| ERR-06 | Storage timeout | Simulate slow blob | Task times out with clear error | [ ] |
| ERR-07 | OOM protection | Process very large file | Memory watchdog triggers, graceful fail | [ ] |
| ERR-08 | Lock expiry | Process >2hr job | Lock renewed, or graceful timeout | [ ] |

### B.10 Error Test Commands

```bash
# ERR-01: Missing required param
curl -X POST "$FA_URL/api/jobs/submit/vector_docker_etl" \
  -H "Content-Type: application/json" \
  -d '{"source_url": "https://example.com/test.geojson"}'
# Expected: 400 Bad Request - table_name required

# ERR-02: Non-existent blob
curl -X POST "$FA_URL/api/jobs/submit/vector_docker_etl" \
  -H "Content-Type: application/json" \
  -d '{
    "source_url": "https://rmhazuregeobronze.blob.core.windows.net/bronze/DOES_NOT_EXIST.geojson",
    "table_name": "error_test",
    "collection_id": "test"
  }'
# Expected: Job fails with BlobNotFoundError
```

---

## B.11 Regression Tests

### B.11.1 Existing Functionality

| ID | Test | Job Type | Expected | Status |
|----|------|----------|----------|--------|
| REG-01 | Function App vector still works | process_vector | Completes (deprecated warning) | [ ] |
| REG-02 | Function App raster still works | process_raster_v2 | Completes (deprecated warning) | [ ] |
| REG-03 | STAC API queries work | GET /stac/collections | Returns collections | [ ] |
| REG-04 | OGC Features API works | GET /features/collections | Returns vector collections | [ ] |
| REG-05 | Health endpoint stable | GET /api/health | No regressions | [ ] |
| REG-06 | Job status tracking | GET /jobs/status/{id} | Correct status transitions | [ ] |

### B.11 Regression Test Commands

```bash
# REG-01: Legacy vector (should show deprecation warning)
curl -X POST "$FA_URL/api/jobs/submit/process_vector" \
  -H "Content-Type: application/json" \
  -d '{
    "blob_url": "https://rmhazuregeobronze.blob.core.windows.net/bronze/test-data/test_small.geojson",
    "table_name": "regression_vec",
    "collection_id": "regression-tests"
  }'
# Check logs for: "DEPRECATED: Use vector_docker_etl instead"

# REG-03: STAC API
curl -s "$FA_URL/api/stac/collections" | jq '.collections | length'

# REG-04: OGC Features
curl -s "$FA_URL/api/features/collections" | jq '.collections | length'
```

---

## B.6 Job Events Tests

Job Events provide granular tracking of job execution for debugging "last successful checkpoint" scenarios.

### B.6.1 API Endpoint Tests

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| EVT-01 | Get all events | GET /jobs/{id}/events | Returns chronological event list | [ ] |
| EVT-02 | Get latest event | GET /jobs/{id}/events/latest | Returns most recent event | [ ] |
| EVT-03 | Get event summary | GET /jobs/{id}/events/summary | Returns event counts by type | [ ] |
| EVT-04 | Get failure context | GET /jobs/{id}/events/failure | Returns last events before failure | [ ] |
| EVT-05 | Non-existent job | GET /jobs/invalid-id/events | Returns 404 or empty array | [ ] |

### B.6.2 Event Recording Verification

| ID | Test | Scenario | Expected Events | Status |
|----|------|----------|-----------------|--------|
| EVT-06 | Successful job events | Submit hello_world, wait for completion | JOB_STARTED, STAGE_STARTED, TASK_QUEUED, TASK_STARTED, TASK_COMPLETED, STAGE_COMPLETED, JOB_COMPLETED | [ ] |
| EVT-07 | Failed job events | Submit invalid job (bad URL) | Events include TASK_FAILED, JOB_FAILED | [ ] |
| EVT-08 | Event timestamps | Check event order | All events have valid timestamps, chronological order | [ ] |

### B.6.3 Docker UI Events Routes

| ID | Test | Route | Expected | Status |
|----|------|-------|----------|--------|
| EVT-09 | Events page | GET /interface/jobs/{id}/events | HTML page with events list | [ ] |
| EVT-10 | Events partial | GET /interface/jobs/{id}/events/partial | HTMX partial for live updates | [ ] |

### B.6 Job Events Test Commands

```bash
# EVT-01: Get all events for a job (use a completed job ID)
curl -s "$FA_URL/api/jobs/{JOB_ID}/events" | jq .

# EVT-02: Get latest event
curl -s "$FA_URL/api/jobs/{JOB_ID}/events/latest" | jq .

# EVT-03: Get event summary (counts by type)
curl -s "$FA_URL/api/jobs/{JOB_ID}/events/summary" | jq .

# EVT-04: Get failure context (for failed jobs)
curl -s "$FA_URL/api/jobs/{JOB_ID}/events/failure" | jq .

# EVT-05: Non-existent job
curl -s "$FA_URL/api/jobs/not-a-real-job-id/events" | jq .

# EVT-06: Submit hello_world and verify events
JOB_ID=$(curl -s -X POST "$FA_URL/api/jobs/submit/hello_world" \
  -H "Content-Type: application/json" \
  -d '{"message": "events test"}' | jq -r '.job_id')
echo "Job ID: $JOB_ID"

# Wait for completion then check events
sleep 10
curl -s "$FA_URL/api/jobs/$JOB_ID/events" | jq '.[] | {event_type, timestamp}'

# Expected event types (in order):
# - JOB_STARTED (or STAGE_STARTED)
# - TASK_QUEUED
# - TASK_STARTED
# - TASK_COMPLETED
# - STAGE_COMPLETED
# - JOB_COMPLETED

# EVT-07: Submit job with invalid URL to trigger failure
FAIL_JOB_ID=$(curl -s -X POST "$FA_URL/api/jobs/submit/vector_docker_etl" \
  -H "Content-Type: application/json" \
  -d '{
    "source_url": "https://rmhazuregeo.blob.core.windows.net/rmhazuregeobronze/DOES_NOT_EXIST.geojson",
    "table_name": "events_fail_test",
    "collection_id": "test"
  }' | jq -r '.job_id')
echo "Fail Job ID: $FAIL_JOB_ID"

# Wait then check failure events
sleep 30
curl -s "$FA_URL/api/jobs/$FAIL_JOB_ID/events/failure" | jq .

# EVT-09/10: Docker UI routes (browser or curl)
curl -s "$DW_URL/interface/jobs/{JOB_ID}/events" | head -50
curl -s "$DW_URL/interface/jobs/{JOB_ID}/events/partial" | head -30
```

---

## A.4 Platform Approval Admin Tests

Additional approval tests beyond the QA Critical Path (listing, filtering, revoke).

### A.4.1 Approval Listing Endpoints

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| APR-01 | List all approvals | GET /api/platform/approvals | Returns approval list with status_counts | [ ] Ready to test |
| APR-02 | List pending approvals | GET /api/platform/approvals?status=pending | Filtered list, only pending items | [ ] Ready to test |
| APR-03 | Get single approval | GET /api/platform/approvals/{approval_id} | Returns full approval details | [ ] Ready to test |
| APR-04 | Non-existent approval | GET /api/platform/approvals/invalid-id | Returns 404 or error response | [ ] Ready to test |
| APR-05 | Batch status lookup | GET /api/platform/approvals/status?stac_item_ids=a,b,c | Returns map of ID â†’ approval status | [ ] Ready to test |

### A.4.2 Revoke Endpoint Tests

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| APR-06 | Approve pending dataset | POST /api/platform/approve | Status changes to 'approved', STAC updated | [ ] Ready to test |
| APR-07 | Approve already approved | POST /api/platform/approve (same ID) | Idempotent success or appropriate message | [ ] Ready to test |
| APR-08 | Approve with invalid ID | POST /api/platform/approve (bad ID) | Returns error with helpful message | [ ] Ready to test |
| APR-09 | Revoke approved dataset | POST /api/platform/revoke | Status changes to 'revoked', audit logged | [ ] Ready to test |
| APR-10 | Revoke requires reason | POST /api/platform/revoke (no reason) | Returns 400 - reason required | [ ] Ready to test |
| APR-11 | Revoke non-approved | POST /api/platform/revoke (pending item) | Returns error - can only revoke approved | [ ] Ready to test |

### A.4.3 Integration Tests

| ID | Test | Scenario | Expected | Status |
|----|------|----------|----------|--------|
| APR-12 | Full approval workflow | Submit raster â†’ Create approval â†’ Approve â†’ Verify STAC | End-to-end approval flow works | [ ] Ready to test |

### A.4 Platform Approval Test Commands

```bash
# APR-01: List all approvals
curl -s "$FA_URL/api/platform/approvals" | jq .

# APR-02: List pending only
curl -s "$FA_URL/api/platform/approvals?status=pending" | jq .

# APR-03: Get single approval (replace APPROVAL_ID)
curl -s "$FA_URL/api/platform/approvals/{APPROVAL_ID}" | jq .

# APR-04: Non-existent approval
curl -s "$FA_URL/api/platform/approvals/not-a-real-approval-id" | jq .

# APR-05: Batch status lookup
curl -s "$FA_URL/api/platform/approvals/status?stac_item_ids=item1,item2,item3" | jq .

# APR-06: Approve a pending dataset
curl -X POST "$FA_URL/api/platform/approve" \
  -H "Content-Type: application/json" \
  -d '{
    "approval_id": "APPROVAL_ID_HERE",
    "reviewer": "test@example.com",
    "notes": "Approved during V0.8 testing"
  }' | jq .

# APR-09: Revoke an approved dataset
curl -X POST "$FA_URL/api/platform/revoke" \
  -H "Content-Type: application/json" \
  -d '{
    "approval_id": "APPROVAL_ID_HERE",
    "revoker": "test@example.com",
    "reason": "V0.8 testing - revocation test"
  }' | jq .

# APR-10: Revoke without reason (should fail)
curl -X POST "$FA_URL/api/platform/revoke" \
  -H "Content-Type: application/json" \
  -d '{
    "approval_id": "APPROVAL_ID_HERE",
    "revoker": "test@example.com"
  }' | jq .

# APR-12: Full workflow test
# Step 1: Submit a raster job
JOB_ID=$(curl -s -X POST "$FA_URL/api/platform/submit" \
  -H "Content-Type: application/json" \
  -d '{
    "dataset_id": "approval-test-dataset",
    "resource_id": "test-resource",
    "version_id": "v1",
    "container_name": "rmhazuregeobronze",
    "file_name": "roads.gpkg"
  }' | jq -r '.request_id')
echo "Request ID: $JOB_ID"

# Step 2: Wait for job completion, get approval_id from result
# Step 3: Approve the dataset
# Step 4: Verify STAC item reflects approval
```

---

## Test Execution Log

### Session 1: 26 JAN 2026

| Time | Test ID | Result | Notes |
|------|---------|--------|-------|
| 00:17 UTC | INF-01 | âœ… PASS | FA healthy, all components OK |
| 00:17 UTC | INF-02 | âœ… PASS | Docker v0.7.32.5, GDAL 3.10.1, 7.7GB RAM |
| 00:17 UTC | INF-03 | âœ… PASS | Ready, tokens valid |
| 00:17 UTC | INF-04 | âœ… PASS | PostgreSQL 17.7, PostGIS 3.5, 201ms connect |
| 00:18 UTC | INF-05 | âœ… PASS | container-tasks queue active |
| 00:18 UTC | INF-06 | âœ… PASS | functionapp-tasks queue active |
| 00:18 UTC | INF-07 | âœ… PASS | Docker listening to container-tasks |
| 00:18 UTC | INF-08 | âœ… PASS | FA listening to functionapp-tasks |

### Session 2: 27 JAN 2026 (CRS Reprojection Fix)

| Time | Test ID | Result | Notes |
|------|---------|--------|-------|
| 00:00 UTC | RAS-11 | âŒ FAIL | Job `7715b1f2...` output EPSG:32750 instead of 4326. BUG-003 opened. |
| 00:30 UTC | - | ðŸ”§ FIX | Identified root cause: `cog_translate` ignores `dst_crs` for file path inputs |
| 00:35 UTC | - | ðŸ”§ FIX | First fix attempt: Added `dst_crs` to `cog_config` dict |
| 00:42 UTC | RAS-11 | âŒ FAIL | Retest still showed EPSG:32750 - `dst_crs` in config doesn't work for file paths |
| 00:45 UTC | - | ðŸ”§ FIX | Researched rio-cogeo docs, found `WarpedVRT` is required for reprojection |
| 00:50 UTC | - | ðŸ”§ FIX | Implemented WarpedVRT wrapper in `_process_cog_disk_based()` (v0.7.33.4) |
| 00:52 UTC | - | ðŸš€ DEPLOY | Built/deployed Docker image v0.7.33.4 |
| 01:00 UTC | RAS-11 | âœ… PASS | 3 jobs tested: EPSG:32750â†’4326 âœ…, EPSG:32648â†’4326 âœ…, EPSG:4326â†’4326 âœ… |

**Jobs Tested**:
- `7715b1f2107644c9...` - Source: EPSG:32750 (UTM 50S) â†’ Output: EPSG:4326 âœ…
- `4950fb4031cd6041...` - Source: EPSG:32648 (UTM 48N) â†’ Output: EPSG:4326 âœ…
- `d33b49613a01fa44...` - Source: EPSG:4326 (no-op) â†’ Output: EPSG:4326 âœ…

### Session 3: 27 JAN 2026 (Raster Testing & Multi-Instance Validation)

| Time | Test ID | Result | Notes |
|------|---------|--------|-------|
| 02:00 UTC | RAS-01 | âœ… PASS | Job `7715b1f2...`, 360 MB â†’ 459 MB, 68s, single_cog |
| 02:00 UTC | RAS-04 | âœ… PASS | STAC item inserted to pgstac |
| 02:00 UTC | RAS-10 | âœ… PASS | 8 bands preserved |
| 02:00 UTC | RAS-13 | âœ… PASS | TiTiler viewer functional |
| 02:10 UTC | RAS-02 | âœ… PASS | Job `4950fb40...`, 986 MB DTM â†’ 973 MB, 243s, DEM auto-detected |
| 02:31 UTC | - | ðŸ§ª TEST | Submitted 10.8 GB (RAS-07) and 1.3 GB (RAS-03) jobs simultaneously |
| 02:35 UTC | - | ðŸŽ‰ **CRITICAL** | **Multi-instance parallelism CONFIRMED** via App Insights logs |
| 02:40 UTC | RAS-03 | âœ… PASS | Job `c76b664e...`, 1.3 GB â†’ 1698 MB, 473s, disk-based, 8 bands |

**ðŸŽ‰ Multi-Instance Parallelism Validation**:

Two Docker worker instances processed jobs **simultaneously**:
- Instance `e7c2c054ea58...` â†’ Job `a604a350...` (10.8 GB) - TILED output, writing tiles
- Instance `50bd00d9b926...` â†’ Job `c76b664e...` (1.3 GB) - Single COG processing

Evidence from Application Insights:
```
02:32:27 | 50bd00d9b926... | ðŸ”§ Processing task (job: c76b664e..., 1.3GB)
02:32:49 | e7c2c054ea58... | Writing blob: ...tile_0_0.tif (10.8GB tiled job)
02:33:07 | e7c2c054ea58... | âœ… Wrote tile_0_0.tif (454 MB)
02:34:14 | e7c2c054ea58... | âœ… Wrote tile_0_1.tif (454 MB)
```

This validates the V0.8 Docker Worker horizontal scaling architecture.

**Single COG Section Complete**: RAS-01 âœ…, RAS-02 âœ…, RAS-03 âœ…, RAS-04 âœ…

---

## Test Data Preparation

### Test Data Verification (25 JAN 2026) âœ… COMPLETE

All test data has been verified to exist in `rmhazuregeo` storage account, `rmhazuregeobronze` container.

#### Vector Test Files

| File | Size | Format | Verified |
|------|------|--------|----------|
| `roads.kml` | 0.35 MB | KML | âœ… |
| `roads.zip` | 0.05 MB | Shapefile | âœ… |
| `roads.gpkg` | 0.22 MB | GeoPackage | âœ… |
| `acled_test.csv` | 2.83 MB | CSV | âœ… |
| `World_Bank_Global_Administrative_Divisions.geojson` | 136.81 MB | GeoJSON | âœ… |
| `acled_export.csv` | 1,333.60 MB | CSV | âœ… |

#### Raster Test Files

| File | Size | Category | Verified |
|------|------|----------|----------|
| `25FEB02023857-S2AS-200007488011_01_P001.TIF` | 359.73 MB | Small | âœ… |
| `2021_Luang_Prabang_DTM.tif` | 985.99 MB | Medium | âœ… |
| `22FEB01105201-S2AS_R1C1-200007559860_01_P001.TIF` | 1,318.56 MB | Large (disk) | âœ… |
| `17apr2024wv2.tif` | 4,449.54 MB | XLarge (tiled) | âœ… |
| `2024APR17WV2.tif` | 8,044.86 MB | XLarge (tiled) | âœ… |
| `2022DEC21WV2.tif` | 10,792.99 MB | XXLarge (tiled) | âœ… |
| `antigua.tif` | 11,161.39 MB | XXLarge (tiled) | âœ… |

### Blob URL Pattern

```
https://rmhazuregeo.blob.core.windows.net/rmhazuregeobronze/{blob_name}
```

### Verify Test Data Command

```bash
# List all test data
az storage blob list --container-name rmhazuregeobronze \
  --account-name rmhazuregeo --auth-mode login \
  --query "[?contains(name, 'roads') || contains(name, 'acled') || contains(name, 'World_Bank') || contains(name, 'DTM') || contains(name, 'WV2')].{name:name, size_mb:properties.contentLength}" -o table
```

---

## B.4 Database Verification Tests

Direct database verification to ensure data integrity after ETL operations.

### B.4.1 Vector Table Verification

| ID | Test | Validation | Expected | Status |
|----|------|------------|----------|--------|
| DB-01 | Table exists | `\dt geo.{table_name}` | Table created in geo schema | [ ] |
| DB-02 | Row count matches | `SELECT COUNT(*) FROM geo.{table}` | Matches source file row count | [ ] |
| DB-03 | Geometry column | `SELECT GeometryType(geom) FROM geo.{table} LIMIT 1` | Valid geometry type | [ ] |
| DB-04 | SRID is 4326 | `SELECT ST_SRID(geom) FROM geo.{table} LIMIT 1` | Returns 4326 | [ ] |
| DB-05 | Spatial index exists | `\di geo.idx_{table}_geom` | Index created | [ ] |
| DB-06 | ETL batch_id populated | `SELECT DISTINCT etl_batch_id FROM geo.{table}` | Non-null batch IDs | [ ] |

### B.4.2 Table Catalog Verification

| ID | Test | Validation | Expected | Status |
|----|------|------------|----------|--------|
| DB-07 | Catalog entry exists | `SELECT * FROM geo.table_catalog WHERE table_name='{table}'` | Row exists | [ ] |
| DB-08 | Feature count populated | Check `feature_count` column | Matches actual row count | [ ] |
| DB-09 | Bbox populated | Check `bbox_minx/y/maxx/y` columns | Valid bounding box | [ ] |
| DB-10 | Geometry type recorded | Check `geometry_type` column | Matches actual geometry | [ ] |
| DB-11 | Vector tiles URL | Check `custom_properties->vector_tiles` | TiPG URLs populated | [ ] |

### B.4.3 STAC/pgSTAC Verification

| ID | Test | Validation | Expected | Status |
|----|------|------------|----------|--------|
| DB-12 | STAC collection exists | `SELECT * FROM pgstac.collections WHERE id='{collection}'` | Collection row exists | [ ] |
| DB-13 | STAC item exists | `SELECT * FROM pgstac.items WHERE id='{item_id}'` | Item row exists | [ ] |
| DB-14 | Item bbox valid | Check item `bbox` column | Valid GeoJSON bbox array | [ ] |
| DB-15 | Item assets populated | Check item `content->'assets'` | COG/data URLs present | [ ] |

### B.4.4 COG Metadata Verification

| ID | Test | Validation | Expected | Status |
|----|------|------------|----------|--------|
| DB-16 | COG metadata exists | `SELECT * FROM app.cog_metadata WHERE item_id='{item}'` | Row exists | [ ] |
| DB-17 | Dimensions recorded | Check `width`, `height` columns | Non-null positive integers | [ ] |
| DB-18 | Band count recorded | Check `band_count` column | Matches source raster | [ ] |
| DB-19 | CRS is 4326 | Check `crs` column | Contains "4326" | [ ] |

### B.4.5 Job/Task Tables Verification

| ID | Test | Validation | Expected | Status |
|----|------|------------|----------|--------|
| DB-20 | Job record exists | `SELECT * FROM app.jobs WHERE job_id='{id}'` | Row with correct status | [ ] |
| DB-21 | Task records exist | `SELECT * FROM app.tasks WHERE parent_job_id='{id}'` | Task rows created | [ ] |
| DB-22 | Job events logged | `SELECT * FROM app.job_events WHERE job_id='{id}'` | Event history exists | [ ] |
| DB-23 | Platform request linked | `SELECT * FROM app.api_requests WHERE job_id='{id}'` | Requestâ†’job mapping | [ ] |

### B.4 Database Verification Commands

```bash
# Connect to database (use credentials from environment)
PGPASSWORD='$PASSWORD' psql "host=rmhpostgres.postgres.database.azure.com dbname=geopgflex user=$USER sslmode=require"

# DB-01: Check table exists
\dt geo.{table_name}

# DB-02: Row count
SELECT COUNT(*) FROM geo.{table_name};

# DB-03/04: Geometry type and SRID
SELECT GeometryType(geom), ST_SRID(geom) FROM geo.{table_name} LIMIT 1;

# DB-05: Check spatial index
SELECT indexname FROM pg_indexes WHERE schemaname='geo' AND tablename='{table_name}' AND indexname LIKE '%geom%';

# DB-07/08/09/10: Table catalog
SELECT table_name, feature_count, bbox_minx, bbox_miny, bbox_maxx, bbox_maxy, geometry_type
FROM geo.table_catalog WHERE table_name='{table_name}';

# DB-12: STAC collection
SELECT id, title FROM pgstac.collections WHERE id='{collection_id}';

# DB-13/14/15: STAC item
SELECT id, collection, bbox, content->'assets' as assets
FROM pgstac.items WHERE id='{item_id}';

# DB-16/17/18/19: COG metadata
SELECT item_id, width, height, band_count, crs
FROM app.cog_metadata WHERE item_id='{item_id}';

# DB-20: Job record
SELECT job_id, job_type, status, stage FROM app.jobs WHERE job_id='{job_id}';

# DB-21: Task records
SELECT task_id, task_type, status, retry_count FROM app.tasks WHERE parent_job_id='{job_id}';

# DB-22: Job events
SELECT event_type, timestamp FROM app.job_events WHERE job_id='{job_id}' ORDER BY timestamp;
```

---

## B.5 Task-Level Tests

Task lifecycle and monitoring verification.

### B.5.1 Task Status Transitions

| ID | Test | Scenario | Expected | Status |
|----|------|----------|----------|--------|
| TSK-01 | Pending â†’ Processing | Submit job, check task immediately | Task in 'pending' then 'processing' | [ ] |
| TSK-02 | Processing â†’ Completed | Wait for job completion | Task status = 'completed' | [ ] |
| TSK-03 | Processing â†’ Failed | Submit invalid job | Task status = 'failed', error_details populated | [ ] |
| TSK-04 | Retry increment | Cause task failure, observe retry | retry_count increments | [ ] |

### B.5.2 Task Pulse Monitoring

| ID | Test | Validation | Expected | Status |
|----|------|------------|----------|--------|
| TSK-05 | Pulse updates | Check last_pulse during processing | Updates every ~30 seconds | [ ] |
| TSK-06 | Stale pulse detection | Kill Docker mid-task, wait | Janitor marks task failed after timeout | [ ] |
| TSK-07 | Progress metadata | Check metadata.progress during large job | percent and message updated | [ ] |

### B.5.3 Task API Endpoints

| ID | Test | Endpoint | Expected | Status |
|----|------|----------|----------|--------|
| TSK-08 | Get tasks for job | GET /api/dbadmin/tasks/{job_id} | Returns task list with metrics | [ ] |
| TSK-09 | Task detail | Check task result_data after completion | Contains processing results | [ ] |
| TSK-10 | Checkpoint data | Check checkpoint_phase/checkpoint_data | Populated for resumable tasks | [ ] |

### B.5 Task Test Commands

```bash
# TSK-01/02: Submit job and monitor task status
JOB_ID=$(curl -s -X POST "$FA_URL/api/jobs/submit/hello_world" \
  -H "Content-Type: application/json" \
  -d '{"message": "task test"}' | jq -r '.job_id')

# Check task status immediately
curl -s "$FA_URL/api/dbadmin/tasks/$JOB_ID" | jq '.tasks[0].status'

# Wait and check again
sleep 15
curl -s "$FA_URL/api/dbadmin/tasks/$JOB_ID" | jq '.tasks[0] | {status, retry_count, last_pulse}'

# TSK-05/07: Monitor pulse and progress during large job
curl -s "$FA_URL/api/dbadmin/tasks/{LARGE_JOB_ID}" | jq '.tasks[0] | {last_pulse, metadata}'

# TSK-08: Full task details
curl -s "$FA_URL/api/dbadmin/tasks/{JOB_ID}" | jq .
```

---

## Endpoint Summary by Category

### Non-Platform Endpoints (Internal APIs)

| Category | Endpoints | Test Coverage |
|----------|-----------|---------------|
| **Health** | `GET /api/health`, `GET /health`, `GET /readyz` | INF-01 to INF-04 |
| **Jobs API** | `POST /api/jobs/submit/{type}`, `GET /api/jobs/status/{id}` | VEC-*, RAS-*, RTE-* |
| **Job Events** | `GET /api/jobs/{id}/events/*` | EVT-01 to EVT-10 |
| **STAC** | `GET /api/stac/collections`, `GET /api/stac/collections/{id}/items` | VEC-11/12, RAS-04/08 |
| **OGC Features** | `GET /api/features/collections`, `GET /api/features/collections/{id}` | REG-03/04 |
| **DB Admin** | `GET /api/dbadmin/stats`, `GET /api/dbadmin/tasks/{id}`, `GET /api/dbadmin/diagnostics/all` | INF-04, TSK-08 |
| **Docker UI** | `GET /interface/jobs/{id}/events` | EVT-09/10 |

### Platform Endpoints (External DDH API)

| Category | Endpoints | Test Coverage |
|----------|-----------|---------------|
| **Submit** | `POST /api/platform/submit` | PLT-01 to PLT-06 |
| **Status** | `GET /api/platform/status/{id}`, `GET /api/platform/status` | PLT-07 to PLT-10 |
| **Diagnostics** | `GET /api/platform/health`, `GET /api/platform/failures`, `GET /api/platform/lineage/{id}`, `POST /api/platform/validate` | PLT-11 to PLT-14 |
| **Unpublish** | `POST /api/platform/unpublish` | PLT-15 to PLT-18 |
| **Catalog** | `GET /api/platform/catalog/*` | PLT-19 to PLT-22 |
| **Approvals** | `GET /api/platform/approvals`, `POST /api/platform/approve`, `POST /api/platform/revoke` | APR-01 to APR-12 |
| **Deprecated** | `POST /api/platform/raster`, `POST /api/platform/vector`, `POST /api/platform/raster-collection` | PLT-23 to PLT-25 |

---

## Approval Criteria

### Minimum Pass Requirements

- [ ] **100% of tests pass** - All tests must pass or be removed if inappropriate
- [ ] **No blocking errors** in error handling tests
- [ ] **No regressions** in existing functionality

**Policy**: If a test is deemed inappropriate or not applicable, it must be explicitly removed from this document with justification - not simply skipped.

### Sign-Off

| Role | Name | Date | Signature |
|------|------|------|-----------|
| Developer | Claude | | |
| Approver | Robert Harrison | | |

---

## Summary Tracking

### Part A: Platform API (DDH Integration)

| Category | Total | Passed | Failed | Blocked | Remaining |
|----------|-------|--------|--------|---------|-----------|
| A.1 QA Critical Path | 24 | 0 | 0 | 0 | 24 |
| A.2 Platform Diagnostics | 4 | 0 | 0 | 0 | 4 |
| A.3 Platform Catalog | 4 | 0 | 0 | 0 | 4 |
| A.4 Platform Approval Admin | 12 | 0 | 0 | 0 | 12 |
| **Part A Total** | **44** | **0** | **0** | **0** | **44** |

### Part B: Internal APIs

| Category | Total | Passed | Failed | Blocked | Remaining |
|----------|-------|--------|--------|---------|-----------|
| B.1 Infrastructure | 8 | **8** | 0 | 0 | 0 |
| B.2 Vector Docker ETL | 12 | **4** | 0 | 0 | 8 |
| B.3 Raster Docker ETL | 14 | **8** | 0 | 0 | 6 |
| B.4 Database Verification | 23 | 0 | 0 | 0 | 23 |
| B.5 Task-Level Tests | 10 | 0 | 0 | 0 | 10 |
| B.6 Job Events | 10 | 0 | 0 | 0 | 10 |
| B.7 Mount Behavior | 6 | 0 | 0 | 0 | 6 |
| B.8 Checkpoint/Resume | 6 | 0 | 0 | 0 | 6 |
| B.9 Routing Verification | 8 | 0 | 0 | 0 | 8 |
| B.10 Error Handling | 8 | 0 | 0 | 0 | 8 |
| B.11 Regression | 6 | 0 | 0 | 0 | 6 |
| **Part B Total** | **111** | **20** | **0** | **0** | **91** |

### Grand Total

| | Total | Passed | Failed | Blocked | Remaining |
|-|-------|--------|--------|---------|-----------|
| **ALL TESTS** | **155** | **20** | **0** | **0** | **135** |

### Bug Summary (28 JAN 2026)

| Status | Count | Bug IDs |
|--------|-------|---------|
| âœ… Fixed | 8 | BUG-001, BUG-003, BUG-004, BUG-005, BUG-007, BUG-008, BUG-010, BUG-011 |
| âœ… Closed (Not a Bug) | 2 | BUG-002, BUG-006 |
| âœ… Fixed & Deployed | 2 | BUG-009 (vector overwrite), BUG-012 (race condition) |

**Fixes Pending Deployment:**
- **BUG-009**: Vector `overwrite=true` now drops and recreates table (not append) âœ… DEPLOYED v0.7.35.4
- **BUG-012**: Overwrite race condition fixed - no async unpublish jobs, handler manages cleanup âœ… DEPLOYED v0.7.35.4
- **BUG-010/011**: STAC preview URLs now include `bidx=` for multi-band imagery

---

*Document created: 25 JAN 2026*
*Last updated: 29 JAN 2026 - BUG-009 & BUG-012 FIXED. Overwrite race condition eliminated for both vector and raster. Raster checksum comparison verified: unchanged data returns in ~4s (95% faster). Deployed v0.7.35.4.*
