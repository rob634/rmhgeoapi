<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Diagram Preview</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Open Sans", Arial, sans-serif;
            background: #f8f9fa;
            padding: 20px;
            color: #053657;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-bottom: 20px; }

        /* Architecture Diagram Styles */
        .architecture-diagram {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 3px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .architecture-diagram h3 {
            color: #053657;
            font-size: 16px;
            margin: 0 0 15px 0;
            font-weight: 600;
        }
        .diagram-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #626F86;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #ccc;
        }
        .legend-dot.healthy { background: #10B981; box-shadow: 0 0 0 1px #10B981; }
        .legend-dot.warning { background: #F59E0B; box-shadow: 0 0 0 1px #F59E0B; }
        .legend-dot.unhealthy { background: #DC2626; box-shadow: 0 0 0 1px #DC2626; }
        .legend-dot.unknown { background: #9CA3AF; box-shadow: 0 0 0 1px #9CA3AF; }

        .arch-svg {
            width: 100%;
            max-width: 1100px;
            height: auto;
            min-height: 400px;
            display: block;
            margin: 0 auto;
        }

        /* Component boxes */
        .comp-box {
            stroke-width: 2;
            transition: all 0.3s;
        }
        .comp-box.funcapp { fill: #FFF8E7; stroke: #FFC14D; }
        .comp-box.servicebus { fill: #E8F4FD; stroke: #0078D4; }
        .comp-box.postgres { fill: #E8F0F5; stroke: #336791; }
        .comp-box.storage { fill: #F0F7EE; stroke: #5BB381; }
        .comp-box.appservice { fill: #F3E8FF; stroke: #7C3AED; }

        /* Inactive/Not Implemented components - grey styling */
        .comp-box.inactive {
            fill: #F3F4F6;
            stroke: #9CA3AF;
            stroke-dasharray: 4,2;
        }
        .comp-icon.disabled { opacity: 0.5; }
        .comp-label.disabled { fill: #9CA3AF; }
        .flow-arrow.inactive { stroke: #9CA3AF; stroke-dasharray: 4,2; }
        .status-indicator[data-status="disabled"] { fill: #D1D5DB; stroke: #9CA3AF; }

        .component:hover .comp-box { filter: brightness(0.95); }
        .component { cursor: pointer; }

        /* Labels */
        .comp-icon { font-size: 16px; text-anchor: middle; dominant-baseline: middle; }
        .comp-label { font-size: 11px; font-weight: 600; fill: #053657; text-anchor: middle; }
        .comp-label-small { font-size: 9px; font-weight: 600; fill: #053657; text-anchor: middle; }
        .diagram-label-small { font-size: 11px; fill: #626F86; font-style: italic; }
        .diagram-header-label { font-size: 12px; font-weight: 600; fill: white; text-anchor: middle; }

        /* Flow arrows */
        .flow-arrow { fill: none; stroke: #0071BC; stroke-width: 2; }
        .flow-label { font-size: 9px; fill: #626F86; text-anchor: middle; }
        .flow-label-tiny { font-size: 8px; fill: #626F86; }

        /* Status indicators */
        .status-indicator { stroke: white; stroke-width: 2; transition: fill 0.3s; }
        .status-indicator[data-status="healthy"] { fill: #10B981; }
        .status-indicator[data-status="warning"] { fill: #F59E0B; }
        .status-indicator[data-status="unhealthy"] { fill: #DC2626; }
        .status-indicator[data-status="unknown"] { fill: #9CA3AF; }

        @keyframes pulse-unhealthy {
            0%, 100% { r: 8; opacity: 1; }
            50% { r: 10; opacity: 0.8; }
        }
        .status-indicator[data-status="unhealthy"] {
            animation: pulse-unhealthy 1.5s ease-in-out infinite;
        }

        /* Controls */
        .controls {
            background: white;
            padding: 15px 20px;
            border-radius: 3px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .controls button {
            padding: 8px 16px;
            border: 1px solid #0071BC;
            background: white;
            color: #0071BC;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .controls button:hover { background: #0071BC; color: white; }
        .controls button.active { background: #0071BC; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Architecture Diagram - Health Status Preview</h1>

        <div class="controls">
            <span>Test Status:</span>
            <button onclick="setAllStatus('healthy')">All Healthy</button>
            <button onclick="setAllStatus('warning')">All Warning</button>
            <button onclick="setAllStatus('unhealthy')">All Unhealthy</button>
            <button onclick="setAllStatus('unknown')">All Unknown</button>
            <button onclick="setMixedStatus()">Simulated Real</button>
            <button onclick="setWithOneUnhealthy()">Service Bus Failure</button>
        </div>

        <div class="architecture-diagram">
            <h3>System Architecture</h3>
            <div class="diagram-legend">
                <span class="legend-item"><span class="legend-dot healthy"></span> Healthy</span>
                <span class="legend-item"><span class="legend-dot warning"></span> Warning</span>
                <span class="legend-item"><span class="legend-dot unhealthy"></span> Unhealthy</span>
                <span class="legend-item"><span class="legend-dot unknown"></span> Unknown</span>
            </div>
            <svg viewBox="0 0 1100 580" class="arch-svg" id="arch-diagram">
                <defs>
                    <marker id="arrowhead" markerWidth="7" markerHeight="4.9" refX="6.3" refY="2.45" orient="auto">
                        <polygon points="0 0, 7 2.45, 0 4.9" fill="#0071BC"/>
                    </marker>
                    <!-- Grey arrowhead for inactive/not implemented components -->
                    <marker id="arrowhead-grey" markerWidth="7" markerHeight="4.9" refX="6.3" refY="2.45" orient="auto">
                        <polygon points="0 0, 7 2.45, 0 4.9" fill="#9CA3AF"/>
                    </marker>
                </defs>

                <!-- ETL Pipelines Box - encloses queues and workers -->
                <rect x="510" y="195" width="295" height="282" rx="8" fill="#FAFBFC" stroke="#E1E4E8" stroke-width="1"/>
                <!-- Header bar -->
                <rect x="510" y="195" width="295" height="28" rx="8" fill="#0071BC"/>
                <!-- Bottom corners of header need to be square where they meet the body -->
                <rect x="510" y="215" width="295" height="8" fill="#0071BC"/>
                <text x="657" y="214" class="diagram-header-label">ETL Pipelines</text>

                <!-- Platform API -->
                <g class="component" id="comp-platform-api">
                    <rect x="30" y="320" width="100" height="60" rx="6" class="comp-box funcapp"/>
                    <text x="80" y="345" class="comp-icon">‚ö°</text>
                    <text x="80" y="365" class="comp-label">Platform API</text>
                    <circle cx="120" cy="330" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <path d="M 130 350 L 175 350" class="flow-arrow" marker-end="url(#arrowhead)"/>
                <text x="145" y="340" class="flow-label">Queue Job</text>

                <!-- Job Queues -->
                <g class="component" id="comp-job-queues">
                    <rect x="180" y="320" width="100" height="60" rx="6" class="comp-box servicebus"/>
                    <text x="230" y="345" class="comp-icon">üì®</text>
                    <text x="230" y="365" class="comp-label">Job Queues</text>
                    <circle cx="270" cy="330" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <path d="M 280 350 L 325 350" class="flow-arrow" marker-end="url(#arrowhead)"/>
                <text x="295" y="340" class="flow-label">Trigger</text>

                <!-- Orchestrator -->
                <g class="component" id="comp-orchestrator">
                    <rect x="330" y="320" width="110" height="60" rx="6" class="comp-box funcapp"/>
                    <text x="385" y="345" class="comp-icon">‚ö°</text>
                    <text x="385" y="365" class="comp-label">Orchestrator</text>
                    <circle cx="430" cy="330" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <!-- Arrow: Orchestrator -> Job Tables (straight down) -->
                <path d="M 385 380 L 385 510" class="flow-arrow" marker-end="url(#arrowhead)"/>
                <text x="395" y="445" class="flow-label">Update State</text>

                <!-- Job Tables - vertically aligned with Orchestrator, horizontally with Task Tables -->
                <g class="component" id="comp-job-tables">
                    <rect x="335" y="510" width="100" height="60" rx="6" class="comp-box postgres"/>
                    <text x="385" y="535" class="comp-icon">üêò</text>
                    <text x="385" y="555" class="comp-label">Job Tables</text>
                    <circle cx="425" cy="520" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <!-- Fan-out arrows -->
                <path d="M 440 340 L 520 265" class="flow-arrow" marker-end="url(#arrowhead)"/>
                <text x="460" y="290" class="flow-label">Fan-out</text>
                <path d="M 440 350 L 520 350" class="flow-arrow" marker-end="url(#arrowhead)"/>
                <path d="M 440 360 L 520 435" class="flow-arrow inactive" marker-end="url(#arrowhead-grey)"/>

                <!-- Parallel Queue -->
                <g class="component" id="comp-parallel-queue">
                    <rect x="520" y="235" width="100" height="60" rx="6" class="comp-box servicebus"/>
                    <text x="570" y="260" class="comp-icon">üì®</text>
                    <text x="570" y="280" class="comp-label">Parallel Queue</text>
                    <circle cx="610" cy="245" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <path d="M 620 265 L 680 265" class="flow-arrow" marker-end="url(#arrowhead)"/>

                <!-- I/O Worker -->
                <g class="component" id="comp-io-worker">
                    <rect x="680" y="235" width="110" height="60" rx="6" class="comp-box funcapp"/>
                    <text x="735" y="260" class="comp-icon">‚ö°</text>
                    <text x="735" y="280" class="comp-label">I/O Optimized</text>
                    <circle cx="780" cy="245" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <!-- Compute Queue -->
                <g class="component" id="comp-compute-queue">
                    <rect x="520" y="320" width="100" height="60" rx="6" class="comp-box servicebus"/>
                    <text x="570" y="345" class="comp-icon">üì®</text>
                    <text x="570" y="365" class="comp-label">Compute Queue</text>
                    <circle cx="610" cy="330" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <path d="M 620 350 L 680 350" class="flow-arrow" marker-end="url(#arrowhead)"/>

                <!-- Compute Worker -->
                <g class="component" id="comp-compute-worker">
                    <rect x="680" y="320" width="110" height="60" rx="6" class="comp-box funcapp"/>
                    <text x="735" y="345" class="comp-icon">‚ö°</text>
                    <text x="735" y="365" class="comp-label">Compute Worker</text>
                    <circle cx="780" cy="330" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <!-- Long Queue - NOT IMPLEMENTED -->
                <g class="component disabled" id="comp-long-queue">
                    <rect x="520" y="405" width="100" height="60" rx="6" class="comp-box inactive"/>
                    <text x="570" y="430" class="comp-icon disabled">üì®</text>
                    <text x="570" y="450" class="comp-label disabled">Long Queue</text>
                    <circle cx="610" cy="415" r="8" class="status-indicator" data-status="disabled"/>
                </g>

                <path d="M 620 435 L 680 435" class="flow-arrow inactive" marker-end="url(#arrowhead-grey)"/>

                <!-- Long Worker - NOT IMPLEMENTED -->
                <g class="component disabled" id="comp-container">
                    <rect x="680" y="405" width="110" height="60" rx="6" class="comp-box inactive"/>
                    <text x="735" y="430" class="comp-icon disabled">üê≥</text>
                    <text x="735" y="450" class="comp-label disabled">Long Worker</text>
                    <circle cx="780" cy="415" r="8" class="status-indicator" data-status="disabled"/>
                </g>

                <!-- Task completion: single arrow from ETL box right edge at Compute Worker height (y=350), 90¬∞ turn down -->
                <path d="M 805 350 L 870 350 L 870 510" class="flow-arrow" marker-end="url(#arrowhead)"/>
                <text x="835" y="340" class="flow-label">Task Complete</text>

                <!-- Task Tables -->
                <g class="component" id="comp-task-tables">
                    <rect x="820" y="510" width="100" height="60" rx="6" class="comp-box postgres"/>
                    <text x="870" y="535" class="comp-icon">üêò</text>
                    <text x="870" y="555" class="comp-label">Task Tables</text>
                    <circle cx="910" cy="520" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <!-- State progression feedback: Task Tables -> Job Tables -->
                <path d="M 820 540 L 435 540" class="flow-arrow" marker-end="url(#arrowhead)" stroke-dasharray="5,3"/>
                <text x="610" y="555" class="flow-label">Last Task Triggers State Progression</text>

                <!-- TOP ROW: TiTiler-pgstac and OGC Features -->
                <!-- TiTiler-pgstac: above Output Data (x=735 center) -->
                <g class="component" id="comp-titiler">
                    <rect x="685" y="5" width="100" height="60" rx="6" class="comp-box appservice"/>
                    <text x="735" y="30" class="comp-icon">üê≥</text>
                    <text x="735" y="50" class="comp-label">TiTiler-pgstac</text>
                    <circle cx="775" cy="15" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <!-- OGC Features: above PostGIS (x=870 center) -->
                <g class="component" id="comp-ogc-features">
                    <rect x="820" y="5" width="100" height="60" rx="6" class="comp-box funcapp"/>
                    <text x="870" y="30" class="comp-icon">‚ö°</text>
                    <text x="870" y="50" class="comp-label">OGC Features</text>
                    <circle cx="910" cy="15" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <!-- STORAGE ROW: Input/Output/PostGIS -->
                <!-- Input Data: aligned with queues (x=570 center) -->
                <g class="component" id="comp-input-storage">
                    <rect x="520" y="95" width="100" height="60" rx="6" class="comp-box storage"/>
                    <text x="570" y="120" class="comp-icon">üì¶</text>
                    <text x="570" y="140" class="comp-label">Input Data</text>
                    <circle cx="610" cy="105" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <!-- Output Data: aligned with workers (x=735 center) -->
                <g class="component" id="comp-output-storage">
                    <rect x="685" y="95" width="100" height="60" rx="6" class="comp-box storage"/>
                    <text x="735" y="120" class="comp-icon">üì¶</text>
                    <text x="735" y="140" class="comp-label">Output Data</text>
                    <circle cx="775" cy="105" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <!-- PostGIS - horizontally aligned with storage -->
                <g class="component" id="comp-output-tables">
                    <rect x="820" y="95" width="100" height="60" rx="6" class="comp-box postgres"/>
                    <text x="870" y="120" class="comp-icon">üêò</text>
                    <text x="870" y="140" class="comp-label">PostGIS</text>
                    <circle cx="910" cy="105" r="8" class="status-indicator" data-status="unknown"/>
                </g>

                <!-- ========== NEW COLUMN: Zarr/xarray (NOT IMPLEMENTED - grey) ========== -->
                <!-- TiTiler-xarray: above Zarr Store (x=1005 center) - NOT IMPLEMENTED -->
                <g class="component disabled" id="comp-titiler-xarray">
                    <rect x="955" y="5" width="100" height="60" rx="6" class="comp-box inactive"/>
                    <text x="1005" y="30" class="comp-icon disabled">üê≥</text>
                    <text x="1005" y="50" class="comp-label disabled">TiTiler-xarray</text>
                    <circle cx="1045" cy="15" r="8" class="status-indicator" data-status="disabled"/>
                </g>

                <!-- Zarr Store: to the right of PostGIS (x=1005 center) - NOT IMPLEMENTED -->
                <g class="component disabled" id="comp-zarr-store">
                    <rect x="955" y="95" width="100" height="60" rx="6" class="comp-box inactive"/>
                    <text x="1005" y="120" class="comp-icon disabled">üì¶</text>
                    <text x="1005" y="140" class="comp-label disabled">Zarr Store</text>
                    <circle cx="1045" cy="105" r="8" class="status-indicator" data-status="disabled"/>
                </g>

                <!-- Arrow: Zarr Store -> TiTiler-xarray (up) - grey/dashed for not implemented -->
                <path d="M 1005 95 L 1005 65" class="flow-arrow inactive" marker-end="url(#arrowhead-grey)"/>

                <!-- Arrows: Output Data -> TiTiler-pgstac (up) -->
                <path d="M 735 95 L 735 65" class="flow-arrow" marker-end="url(#arrowhead)"/>

                <!-- Arrows: PostGIS -> OGC Features (up) -->
                <path d="M 870 95 L 870 65" class="flow-arrow" marker-end="url(#arrowhead)"/>

                <!-- Arrows: Input Data -> ETL Apps box (down) -->
                <path d="M 570 155 L 570 195" class="flow-arrow" marker-end="url(#arrowhead)"/>
                <text x="580" y="178" class="flow-label-tiny">Read</text>

                <!-- ETL Apps box -> Output Data (up) -->
                <path d="M 735 195 L 735 155" class="flow-arrow" marker-end="url(#arrowhead)"/>
                <text x="745" y="178" class="flow-label-tiny">Write</text>

                <!-- ETL Apps box (right edge) -> PostGIS - 90 degree: right then up -->
                <path d="M 805 225 L 870 225 L 870 155" class="flow-arrow" marker-end="url(#arrowhead)"/>
                <text x="875" y="190" class="flow-label-tiny">Write</text>
            </svg>
        </div>

        <p style="color: #626F86; font-size: 13px;">
            Click the buttons above to preview different status states. Click on components to see hover effect.
        </p>
    </div>

    <script>
        function setAllStatus(status) {
            document.querySelectorAll('.status-indicator').forEach(indicator => {
                indicator.setAttribute('data-status', status);
            });
        }

        // Component mapping matches actual health endpoint
        const COMPONENT_MAPPING = {
            'comp-platform-api': 'deployment_config',
            'comp-job-queues': 'service_bus',
            'comp-orchestrator': 'jobs',
            'comp-job-tables': 'database',
            'comp-parallel-queue': 'service_bus',
            'comp-compute-queue': 'service_bus',
            'comp-long-queue': 'service_bus',
            'comp-io-worker': 'imports',
            'comp-compute-worker': 'imports',
            'comp-container': 'duckdb',
            'comp-task-tables': 'database',
            'comp-input-storage': 'storage_containers',
            'comp-output-storage': 'storage_containers',
            'comp-output-tables': 'pgstac'
        };

        // Simulated health data (matches actual /api/health response)
        const SIMULATED_HEALTH = {
            'deployment_config': 'healthy',
            'service_bus': 'healthy',
            'jobs': 'healthy',
            'database': 'healthy',
            'imports': 'healthy',
            'duckdb': 'disabled',  // Shows as grey/unknown
            'storage_containers': 'healthy',
            'pgstac': 'healthy'
        };

        function setMixedStatus() {
            // Apply simulated health status using actual mapping
            Object.entries(COMPONENT_MAPPING).forEach(([svgId, healthKey]) => {
                const indicator = document.querySelector(`#${svgId} .status-indicator`);
                if (indicator) {
                    let status = SIMULATED_HEALTH[healthKey] || 'unknown';
                    if (status === 'disabled' || status === 'deprecated') status = 'unknown';
                    indicator.setAttribute('data-status', status);
                }
            });
        }

        function setWithOneUnhealthy() {
            // Simulate a service bus failure
            const health = {...SIMULATED_HEALTH, 'service_bus': 'unhealthy'};
            Object.entries(COMPONENT_MAPPING).forEach(([svgId, healthKey]) => {
                const indicator = document.querySelector(`#${svgId} .status-indicator`);
                if (indicator) {
                    let status = health[healthKey] || 'unknown';
                    if (status === 'disabled' || status === 'deprecated') status = 'unknown';
                    indicator.setAttribute('data-status', status);
                }
            });
        }

        // Start with simulated real status
        setMixedStatus();
    </script>
</body>
</html>
