openapi: 3.0.1
info:
  title: Geospatial Data Processing Platform API
  version: 1.0.0
  description: |
    **Platform-as-a-Service for Geospatial Data Processing**

    This API provides data processing services for DDH (Development Data Hub) and partners.
    Submit raw geospatial data, receive processed REST API endpoints.

    **Key Features:**
    - Raster processing (COG creation, tiling, STAC cataloging)
    - Vector processing (PostGIS ingestion, validation)
    - Multi-stage orchestration with status tracking
    - STAC-compliant metadata catalog

    **Base URLs:**
    - Production (via APIM): `https://api.platform.com/v1` (when APIM provisioned)
    - Development (direct): `https://rmhazuregeoapi-a3dma3ctfdgngwf6.eastus-01.azurewebsites.net`
  contact:
    name: Geospatial Platform Team
    email: platform-support@example.com
  license:
    name: Proprietary

servers:
  - url: https://rmhazuregeoapi-a3dma3ctfdgngwf6.eastus-01.azurewebsites.net
    description: Azure Functions backend (direct access - development)
  - url: https://api.platform.com/v1
    description: Azure API Management gateway (production - when provisioned)

tags:
  - name: Platform
    description: Processing request management and orchestration
  - name: Status
    description: Job status monitoring and tracking
  - name: OGC Features
    description: |
      OGC API - Features (Part 1: Core) compliant endpoints.
      Query vector data stored in PostGIS using standard GeoJSON responses.
  - name: STAC
    description: |
      STAC API v1.0.0 compliant endpoints.
      Search and browse raster/vector catalog metadata.
  - name: Raster
    description: |
      Raster query and extraction endpoints.
      Extract values, clip regions, and generate previews from COGs.

paths:
  /api/platform/submit:
    post:
      summary: Submit data processing request
      description: |
        Submit a geospatial data processing request. The Platform will:
        1. Validate request parameters
        2. Create CoreMachine jobs based on data type
        3. Return tracking ID and monitor URL
        4. Process data asynchronously

        **Processing Workflows by Data Type:**
        - `raster`: Validate → COG creation → STAC cataloging
        - `vector`: Validate → PostGIS ingestion → STAC cataloging
        - `collection`: Tile detection → Parallel COG creation → MosaicJSON

        **Request ID Generation:**
        - Deterministic SHA256 hash of (dataset_id + resource_id + version_id + timestamp)
        - Allows reprocessing same dataset multiple times
        - Returns existing request if duplicate submission detected

        **Response:**
        - `202 Accepted`: Request queued for processing
        - `400 Bad Request`: Invalid parameters
        - `500 Internal Server Error`: Platform error
      operationId: submitProcessingRequest
      tags:
        - Platform
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlatformRequest'
            examples:
              helloWorld:
                summary: Hello World test (with test_mode flag)
                description: Simple test request that creates hello_world job
                value:
                  dataset_id: "test-dataset"
                  resource_id: "test-resource"
                  version_id: "v1.0"
                  data_type: "raster"
                  source_location: "https://rmhazuregeo.blob.core.windows.net/rmhazuregeobronze/test.tif"
                  parameters:
                    test_mode: true
                  client_id: "ddh"

              rasterProcessing:
                summary: Raster processing (aerial imagery)
                description: Process aerial photo to analysis-tier COG
                value:
                  dataset_id: "aerial-imagery-2024"
                  resource_id: "site-alpha"
                  version_id: "v1.0"
                  data_type: "raster"
                  source_location: "https://rmhazuregeo.blob.core.windows.net/rmhazuregeobronze/aerial-alpha.tif"
                  parameters:
                    output_tier: "analysis"
                    target_crs: "EPSG:4326"
                  client_id: "ddh"

              vectorProcessing:
                summary: Vector processing (boundary data)
                description: Ingest GeoJSON boundaries to PostGIS
                value:
                  dataset_id: "boundary-data-2024"
                  resource_id: "district-boundaries"
                  version_id: "v1.0"
                  data_type: "vector"
                  source_location: "https://rmhazuregeo.blob.core.windows.net/rmhazuregeobronze/boundaries.geojson"
                  parameters:
                    target_crs: "EPSG:4326"
                    table_name: "district_boundaries"
                  client_id: "ddh"

              rasterCollection:
                summary: Raster collection (satellite tiles)
                description: Process multiple rasters as unified collection with MosaicJSON
                value:
                  dataset_id: "landsat-8-collection"
                  resource_id: "scene-123456"
                  version_id: "v1.0"
                  data_type: "raster"
                  source_location: "https://rmhazuregeo.blob.core.windows.net/rmhazuregeobronze/landsat/*.tif"
                  parameters:
                    output_tier: "visualization"
                    create_mosaicjson: true
                  client_id: "ddh"

      responses:
        '202':
          description: |
            **Request accepted for processing**

            The Platform has validated and queued your request. CoreMachine jobs
            have been created and will process asynchronously.

            Use the `monitor_url` to poll for status updates, or wait for webhook
            callback if configured.
          headers:
            X-Correlation-Id:
              description: Request correlation ID for tracing
              schema:
                type: string
                example: "a3f2c1b8"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessingResponse'
              examples:
                accepted:
                  summary: Typical acceptance response
                  value:
                    success: true
                    request_id: "a3f2c1b8e9d7f6a5c4b3a2e1d9c8b7a6"
                    status: "pending"
                    jobs_created:
                      - "validate_raster_job_abc123"
                      - "process_raster_job_def456"
                    message: "Platform request submitted. 2 jobs created."
                    monitor_url: "/api/platform/status/a3f2c1b8e9d7f6a5c4b3a2e1d9c8b7a6"

        '400':
          description: |
            **Invalid request parameters**

            Common issues:
            - Missing required fields (dataset_id, resource_id, version_id)
            - Invalid data_type enum value
            - Invalid source_location URL format
            - Invalid parameters for selected data_type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingField:
                  summary: Missing required field
                  value:
                    success: false
                    error: "Field 'dataset_id' is required"
                    error_type: "ValidationError"

                invalidDataType:
                  summary: Invalid enum value
                  value:
                    success: false
                    error: "data_type must be one of: raster, vector, pointcloud, mesh_3d, tabular"
                    error_type: "ValidationError"

                invalidUrl:
                  summary: Invalid source location
                  value:
                    success: false
                    error: "source_location must be Azure blob URL (https://) or absolute path (/)"
                    error_type: "ValidationError"

        '500':
          description: |
            **Internal server error**

            Platform encountered an error during request processing.
            Check Application Insights logs with correlation_id.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                internalError:
                  summary: Platform error
                  value:
                    success: false
                    error: "Failed to create CoreMachine jobs"
                    error_type: "PlatformError"


  /api/platform/status/{request_id}:
    get:
      summary: Get processing request status
      description: |
        Retrieve status of a Platform processing request including:
        - Overall request status (pending, processing, completed, failed)
        - Associated CoreMachine job statuses
        - Job statistics (total, completed, failed, processing)
        - API endpoints (when completed)
        - Data characteristics (when completed)

        **Status Values:**
        - `pending`: Request accepted, jobs not started yet
        - `processing`: One or more jobs actively processing
        - `completed`: All jobs completed successfully
        - `failed`: One or more jobs failed

        **Polling Recommendations:**
        - Poll every 5-10 seconds for small datasets
        - Poll every 30-60 seconds for large datasets
        - Use exponential backoff for long-running jobs
        - Consider webhook callbacks for better UX
      operationId: getPlatformStatus
      tags:
        - Status
      parameters:
        - name: request_id
          in: path
          required: true
          description: Platform request ID (32-character hash from submit response)
          schema:
            type: string
            minLength: 32
            maxLength: 32
            example: "a3f2c1b8e9d7f6a5c4b3a2e1d9c8b7a6"

      responses:
        '200':
          description: |
            **Request status retrieved successfully**

            Returns comprehensive status including all associated jobs.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
              examples:
                processing:
                  summary: Request in progress
                  value:
                    request_id: "a3f2c1b8e9d7f6a5c4b3a2e1d9c8b7a6"
                    dataset_id: "aerial-imagery-2024"
                    resource_id: "site-alpha"
                    version_id: "v1.0"
                    data_type: "raster"
                    status: "processing"
                    job_ids:
                      - "validate_raster_job_abc123"
                      - "process_raster_job_def456"
                    parameters:
                      output_tier: "analysis"
                    metadata:
                      client_id: "ddh"
                      source_location: "https://storage.blob.core.windows.net/bronze/aerial-alpha.tif"
                      submission_time: "2025-10-29T15:30:00Z"
                    created_at: "2025-10-29T15:30:00Z"
                    updated_at: "2025-10-29T15:32:15Z"
                    jobs:
                      - job_id: "validate_raster_job_abc123"
                        job_type: "validate_raster_job"
                        status: "completed"
                        stage: 1
                        created_at: "2025-10-29T15:30:00Z"
                        updated_at: "2025-10-29T15:30:45Z"
                      - job_id: "process_raster_job_def456"
                        job_type: "process_raster"
                        status: "processing"
                        stage: 2
                        created_at: "2025-10-29T15:30:45Z"
                        updated_at: "2025-10-29T15:32:15Z"
                    job_statistics:
                      total: 2
                      completed: 1
                      failed: 0
                      processing: 1
                      pending: 0
                    urls:
                      jobs:
                        - "/api/jobs/status/validate_raster_job_abc123"
                        - "/api/jobs/status/process_raster_job_def456"

                completed:
                  summary: Request completed successfully
                  value:
                    request_id: "a3f2c1b8e9d7f6a5c4b3a2e1d9c8b7a6"
                    dataset_id: "aerial-imagery-2024"
                    resource_id: "site-alpha"
                    version_id: "v1.0"
                    data_type: "raster"
                    status: "completed"
                    job_ids:
                      - "validate_raster_job_abc123"
                      - "process_raster_job_def456"
                    result_data:
                      api_endpoints:
                        tiles: "https://tiles.platform.com/{z}/{x}/{y}?dataset=aerial-imagery-2024&resource=site-alpha&version=v1.0"
                        stac_item: "https://stac.platform.com/collections/aerial-imagery-2024/items/site-alpha-v1.0"
                        download_cog: "https://rmhazuregeo.blob.core.windows.net/silver-cogs/aerial-alpha-analysis.tif"
                      data_characteristics:
                        bbox: [-120.5, 38.0, -119.5, 39.0]
                        crs: "EPSG:4326"
                        file_size_mb: 45.2
                        band_count: 3
                        data_type: "uint8"
                        processing_time_seconds: 180
                    job_statistics:
                      total: 2
                      completed: 2
                      failed: 0
                      processing: 0
                      pending: 0
                    created_at: "2025-10-29T15:30:00Z"
                    updated_at: "2025-10-29T15:33:00Z"

        '404':
          description: |
            **Request not found**

            The specified request_id does not exist in Platform database.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: Request ID not found
                  value:
                    success: false
                    error: "Platform request a3f2c1b8e9d7f6a5c4b3a2e1d9c8b7a6 not found"


  /api/platform/status:
    get:
      summary: List all processing requests
      description: |
        List Platform requests with optional filtering.

        **Use Cases:**
        - DDH dashboard showing all processing jobs
        - Failed request monitoring
        - Recent submissions audit

        **Filters:**
        - `status`: Filter by request status
        - `limit`: Limit number of results (default 100, max 1000)
      operationId: listPlatformRequests
      tags:
        - Status
      parameters:
        - name: status
          in: query
          required: false
          description: Filter by request status
          schema:
            type: string
            enum:
              - pending
              - processing
              - completed
              - failed
        - name: limit
          in: query
          required: false
          description: Maximum number of results
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000

      responses:
        '200':
          description: |
            **Request list retrieved successfully**
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestListResponse'
              examples:
                recentRequests:
                  summary: Recent submissions
                  value:
                    success: true
                    count: 3
                    requests:
                      - request_id: "a3f2c1b8e9d7f6a5c4b3a2e1d9c8b7a6"
                        dataset_id: "aerial-imagery-2024"
                        resource_id: "site-alpha"
                        version_id: "v1.0"
                        data_type: "raster"
                        status: "completed"
                        job_count: 2
                        created_at: "2025-10-29T15:30:00Z"
                        updated_at: "2025-10-29T15:33:00Z"
                      - request_id: "b4e3d2c1f0a9e8d7c6b5a4e3d2c1b0a9"
                        dataset_id: "boundary-data-2024"
                        resource_id: "district-boundaries"
                        version_id: "v1.0"
                        data_type: "vector"
                        status: "processing"
                        job_count: 1
                        created_at: "2025-10-29T15:35:00Z"
                        updated_at: "2025-10-29T15:36:15Z"
                      - request_id: "c5d4e3f2a1b0c9d8e7f6a5b4c3d2e1f0"
                        dataset_id: "test-dataset"
                        resource_id: "test-resource"
                        version_id: "v1.0"
                        data_type: "raster"
                        status: "pending"
                        job_count: 1
                        created_at: "2025-10-29T15:40:00Z"
                        updated_at: "2025-10-29T15:40:00Z"

  # =========================================================================
  # OGC FEATURES API - Vector Data Access
  # =========================================================================

  /api/features:
    get:
      summary: OGC Features landing page
      description: |
        Landing page for OGC API - Features (Part 1: Core).
        Returns API metadata, links to collections, and conformance.
      operationId: ogcFeaturesLanding
      tags:
        - OGC Features
      responses:
        '200':
          description: Landing page with API links
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OGCLandingPage'

  /api/features/conformance:
    get:
      summary: OGC Features conformance
      description: Lists conformance classes supported by this API.
      operationId: ogcFeaturesConformance
      tags:
        - OGC Features
      responses:
        '200':
          description: Conformance classes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OGCConformance'

  /api/features/collections:
    get:
      summary: List vector collections
      description: |
        Returns list of all available vector collections (PostGIS tables).
        Each collection corresponds to a table in the `geo` schema.
      operationId: ogcFeaturesCollections
      tags:
        - OGC Features
      responses:
        '200':
          description: List of collections
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OGCCollectionList'

  /api/features/collections/{collection_id}:
    get:
      summary: Get collection metadata
      description: Returns metadata for a specific vector collection including extent and schema.
      operationId: ogcFeaturesCollection
      tags:
        - OGC Features
      parameters:
        - name: collection_id
          in: path
          required: true
          description: Collection (table) name
          schema:
            type: string
            example: "admin0"
      responses:
        '200':
          description: Collection metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OGCCollection'
        '404':
          description: Collection not found

  /api/features/collections/{collection_id}/items:
    get:
      summary: Query features
      description: |
        Query features from a collection with optional spatial/attribute filters.

        **Query Parameters:**
        - `bbox`: Bounding box filter (minx,miny,maxx,maxy)
        - `limit`: Max features to return (default: 100, max: 10000)
        - `offset`: Pagination offset
        - `{property}`: Filter by any property value

        **Response Format:**
        GeoJSON FeatureCollection with `numberReturned` and `numberMatched`.
      operationId: ogcFeaturesItems
      tags:
        - OGC Features
      parameters:
        - name: collection_id
          in: path
          required: true
          schema:
            type: string
        - name: bbox
          in: query
          description: Bounding box (minx,miny,maxx,maxy in EPSG:4326)
          schema:
            type: string
            example: "-77.5,38.5,-76.5,39.5"
        - name: limit
          in: query
          description: Maximum number of features
          schema:
            type: integer
            default: 100
            maximum: 10000
        - name: offset
          in: query
          description: Pagination offset
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: GeoJSON FeatureCollection
          content:
            application/geo+json:
              schema:
                $ref: '#/components/schemas/GeoJSONFeatureCollection'

  /api/features/collections/{collection_id}/items/{feature_id}:
    get:
      summary: Get single feature
      description: Returns a single feature by ID.
      operationId: ogcFeaturesFeature
      tags:
        - OGC Features
      parameters:
        - name: collection_id
          in: path
          required: true
          schema:
            type: string
        - name: feature_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: GeoJSON Feature
          content:
            application/geo+json:
              schema:
                $ref: '#/components/schemas/GeoJSONFeature'
        '404':
          description: Feature not found

  # =========================================================================
  # STAC API - Catalog Access
  # =========================================================================

  /api/stac:
    get:
      summary: STAC API landing page
      description: |
        STAC API v1.0.0 landing page.
        Returns catalog metadata and links to collections and search.
      operationId: stacLanding
      tags:
        - STAC
      responses:
        '200':
          description: STAC Catalog root
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/STACCatalog'

  /api/stac/conformance:
    get:
      summary: STAC conformance
      description: Lists STAC API conformance classes.
      operationId: stacConformance
      tags:
        - STAC
      responses:
        '200':
          description: Conformance classes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/STACConformance'

  /api/stac/collections:
    get:
      summary: List STAC collections
      description: |
        Returns all STAC collections in the catalog.
        Collections group related items (e.g., all imagery for a dataset).
      operationId: stacCollections
      tags:
        - STAC
      responses:
        '200':
          description: List of STAC collections
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/STACCollectionList'

  /api/stac/collections/{collection_id}:
    get:
      summary: Get STAC collection
      description: Returns metadata for a specific STAC collection.
      operationId: stacCollection
      tags:
        - STAC
      parameters:
        - name: collection_id
          in: path
          required: true
          schema:
            type: string
            example: "aerial-imagery-2024"
      responses:
        '200':
          description: STAC Collection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/STACCollection'
        '404':
          description: Collection not found

  /api/stac/collections/{collection_id}/items:
    get:
      summary: List STAC items
      description: |
        Returns items in a STAC collection with optional filtering.

        **Query Parameters:**
        - `bbox`: Spatial filter
        - `datetime`: Temporal filter (ISO 8601)
        - `limit`: Max items (default: 10)
      operationId: stacItems
      tags:
        - STAC
      parameters:
        - name: collection_id
          in: path
          required: true
          schema:
            type: string
        - name: bbox
          in: query
          schema:
            type: string
        - name: datetime
          in: query
          description: ISO 8601 datetime or interval
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: STAC ItemCollection
          content:
            application/geo+json:
              schema:
                $ref: '#/components/schemas/STACItemCollection'

  /api/stac/collections/{collection_id}/items/{item_id}:
    get:
      summary: Get STAC item
      description: |
        Returns a single STAC item with all assets and metadata.

        **Asset Types:**
        - `data`: Primary data asset (COG or Zarr URL)
        - `thumbnail`: Preview image
        - `metadata`: Additional metadata files
      operationId: stacItem
      tags:
        - STAC
      parameters:
        - name: collection_id
          in: path
          required: true
          schema:
            type: string
        - name: item_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: STAC Item
          content:
            application/geo+json:
              schema:
                $ref: '#/components/schemas/STACItem'
        '404':
          description: Item not found

  # =========================================================================
  # RASTER API - COG Query and Extraction
  # =========================================================================

  /api/raster/point/{collection}/{item}:
    get:
      summary: Get raster value at point
      description: |
        Extract raster pixel value(s) at a specific location.

        **Location Options:**
        - Named location: `?location=washington_dc`
        - Coordinates: `?location=-77.0369,38.9072`
      operationId: rasterPoint
      tags:
        - Raster
      parameters:
        - name: collection
          in: path
          required: true
          description: STAC collection ID
          schema:
            type: string
        - name: item
          in: path
          required: true
          description: STAC item ID
          schema:
            type: string
        - name: location
          in: query
          required: true
          description: Named location or lon,lat coordinates
          schema:
            type: string
            example: "-77.0369,38.9072"
      responses:
        '200':
          description: Point value(s)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RasterPointResponse'
        '404':
          description: Item not found

  /api/raster/extract/{collection}/{item}:
    get:
      summary: Extract bbox as image
      description: |
        Extract a rectangular region from a raster as an image.

        **Bbox Format:** minx,miny,maxx,maxy (EPSG:4326)
      operationId: rasterExtract
      tags:
        - Raster
      parameters:
        - name: collection
          in: path
          required: true
          schema:
            type: string
        - name: item
          in: path
          required: true
          schema:
            type: string
        - name: bbox
          in: query
          required: true
          description: Bounding box (minx,miny,maxx,maxy)
          schema:
            type: string
            example: "-77.5,38.5,-76.5,39.5"
        - name: format
          in: query
          description: Output format
          schema:
            type: string
            enum: [png, jpeg, webp, tiff]
            default: png
        - name: width
          in: query
          description: Output width in pixels
          schema:
            type: integer
            default: 512
        - name: height
          in: query
          description: Output height in pixels
          schema:
            type: integer
            default: 512
      responses:
        '200':
          description: Image data
          content:
            image/png:
              schema:
                type: string
                format: binary
            image/jpeg:
              schema:
                type: string
                format: binary

  /api/raster/clip/{collection}/{item}:
    get:
      summary: Clip raster to boundary
      description: |
        Clip raster to a named boundary (state, country, etc.).

        **Boundary Types:**
        - `state`: US state boundaries
        - `country`: Country boundaries (admin0)
      operationId: rasterClip
      tags:
        - Raster
      parameters:
        - name: collection
          in: path
          required: true
          schema:
            type: string
        - name: item
          in: path
          required: true
          schema:
            type: string
        - name: boundary_type
          in: query
          required: true
          schema:
            type: string
            enum: [state, country]
        - name: boundary_id
          in: query
          required: true
          description: Boundary identifier (e.g., "VA", "USA")
          schema:
            type: string
      responses:
        '200':
          description: Clipped image
          content:
            image/png:
              schema:
                type: string
                format: binary

  /api/raster/preview/{collection}/{item}:
    get:
      summary: Get raster preview
      description: |
        Generate a quick preview image of the entire raster.
        Useful for thumbnails and data exploration.
      operationId: rasterPreview
      tags:
        - Raster
      parameters:
        - name: collection
          in: path
          required: true
          schema:
            type: string
        - name: item
          in: path
          required: true
          schema:
            type: string
        - name: format
          in: query
          schema:
            type: string
            enum: [png, jpeg, webp]
            default: png
        - name: max_size
          in: query
          description: Maximum dimension in pixels
          schema:
            type: integer
            default: 512
      responses:
        '200':
          description: Preview image
          content:
            image/png:
              schema:
                type: string
                format: binary

components:
  schemas:
    PlatformRequest:
      type: object
      required:
        - dataset_id
        - resource_id
        - version_id
        - data_type
        - source_location
        - client_id
      properties:
        dataset_id:
          type: string
          description: |
            **DDH Dataset Identifier** (Mandatory)

            Top-level organizational unit in DDH hierarchy.
            Example: "aerial-imagery-2024", "landsat-8-collection"
          minLength: 1
          maxLength: 255
          example: "aerial-imagery-2024"

        resource_id:
          type: string
          description: |
            **DDH Resource Identifier** (Mandatory)

            Second-level identifier within dataset.
            Example: "site-alpha", "LC08_L1TP_044034"
          minLength: 1
          maxLength: 255
          example: "site-alpha"

        version_id:
          type: string
          description: |
            **DDH Version Identifier** (Mandatory)

            Specific version of resource (allows reprocessing).
            Example: "v1.0", "v2.0", "2024-10-29"
          minLength: 1
          maxLength: 50
          example: "v1.0"

        data_type:
          type: string
          enum:
            - raster
            - vector
            - pointcloud
            - mesh_3d
            - tabular
          description: |
            **Data Type for Processing** (Mandatory)

            Determines which CoreMachine workflow to execute:
            - `raster`: Validate → COG → STAC (jobs: validate_raster_job, process_raster)
            - `vector`: Validate → PostGIS → STAC (jobs: ingest_vector)
            - `pointcloud`: Reserved for future (no job exists yet)
            - `mesh_3d`: Reserved for future (no job exists yet)
            - `tabular`: Reserved for future (no job exists yet)
          example: "raster"

        source_location:
          type: string
          format: uri
          description: |
            **Azure Blob Storage Location** (Mandatory)

            Must be Azure blob URL or absolute path:
            - HTTPS URL: `https://storage.blob.core.windows.net/container/file.tif`
            - WASBS URL: `wasbs://container@storage.blob.core.windows.net/file.tif`
            - Absolute path: `/mnt/data/file.tif` (if mounted)

            Platform must have read access via:
            - Managed Identity (preferred)
            - SAS token in URL
            - Storage account key (via environment)
          example: "https://rmhazuregeo.blob.core.windows.net/rmhazuregeobronze/aerial-alpha.tif"

        parameters:
          type: object
          additionalProperties: true
          description: |
            **Processing Parameters** (Optional)

            Job-specific configuration options:

            **Raster Processing:**
            - `output_tier`: "visualization" | "analysis" | "archive" (COG compression tier)
            - `target_crs`: "EPSG:4326" (reproject to CRS)
            - `create_mosaicjson`: true (for collections)

            **Vector Processing:**
            - `target_crs`: "EPSG:4326" (reproject to CRS)
            - `table_name`: "my_table" (PostGIS table name)
            - `schema`: "geo" (PostGIS schema, default: geo)

            **Testing:**
            - `test_mode`: true (creates hello_world job instead of real processing)
          example:
            output_tier: "analysis"
            target_crs: "EPSG:4326"

        client_id:
          type: string
          description: |
            **Client Application Identifier** (Mandatory)

            Identifies which application submitted the request.
            Used for tracking, quotas, and client-specific behavior.

            **Known Clients:**
            - "ddh" - Development Data Hub (primary client)
            - "analytics" - Analytics application (future)
            - "mobile" - Mobile app (future)
          example: "ddh"

    ProcessingResponse:
      type: object
      required:
        - success
        - request_id
        - status
        - jobs_created
        - message
        - monitor_url
      properties:
        success:
          type: boolean
          description: Whether request was accepted successfully
          example: true

        request_id:
          type: string
          description: |
            Platform tracking ID (32-character SHA256 hash prefix).

            Generated deterministically from:
            `SHA256(dataset_id + resource_id + version_id + timestamp)[:32]`

            Use this ID to poll status via `/api/platform/status/{request_id}`
          minLength: 32
          maxLength: 32
          example: "a3f2c1b8e9d7f6a5c4b3a2e1d9c8b7a6"

        status:
          type: string
          enum:
            - pending
            - processing
            - completed
            - failed
          description: |
            Current request status:
            - `pending`: Accepted, jobs queued but not started
            - `processing`: One or more jobs actively running
            - `completed`: All jobs completed successfully
            - `failed`: One or more jobs failed
          example: "pending"

        jobs_created:
          type: array
          items:
            type: string
          description: |
            List of CoreMachine job IDs created for this request.

            Each job can be monitored individually via:
            `/api/jobs/status/{job_id}`
          example:
            - "validate_raster_job_abc123"
            - "process_raster_job_def456"

        message:
          type: string
          description: Human-readable status message
          example: "Platform request submitted. 2 jobs created."

        monitor_url:
          type: string
          format: uri-reference
          description: |
            Relative URL to poll for status updates.

            Append to base URL:
            - Direct: `https://rmhgeoapibeta-...{monitor_url}`
            - APIM: `https://api.platform.com/v1{monitor_url}`
          example: "/api/platform/status/a3f2c1b8e9d7f6a5c4b3a2e1d9c8b7a6"

    StatusResponse:
      type: object
      required:
        - request_id
        - dataset_id
        - resource_id
        - version_id
        - data_type
        - status
        - job_ids
        - created_at
        - updated_at
      properties:
        request_id:
          type: string
          minLength: 32
          maxLength: 32
        dataset_id:
          type: string
        resource_id:
          type: string
        version_id:
          type: string
        data_type:
          type: string
        status:
          type: string
          enum:
            - pending
            - processing
            - completed
            - failed
        job_ids:
          type: array
          items:
            type: string
          description: List of CoreMachine job IDs
        parameters:
          type: object
          additionalProperties: true
          description: Original request parameters
        metadata:
          type: object
          additionalProperties: true
          description: Request metadata (client_id, submission_time, etc.)
        result_data:
          type: object
          nullable: true
          description: |
            Processing results (only present when status=completed).
            Contains API endpoints and data characteristics.
          properties:
            api_endpoints:
              type: object
              description: REST API endpoints for accessing processed data
              properties:
                tiles:
                  type: string
                  format: uri
                  description: Tile server URL (for rasters)
                stac_item:
                  type: string
                  format: uri
                  description: STAC item URL
                download_cog:
                  type: string
                  format: uri
                  description: Direct download URL for COG
            data_characteristics:
              type: object
              description: Metadata about processed data
              properties:
                bbox:
                  type: array
                  items:
                    type: number
                  minItems: 4
                  maxItems: 4
                  description: Bounding box [minx, miny, maxx, maxy]
                crs:
                  type: string
                  description: Coordinate reference system
                file_size_mb:
                  type: number
                  description: Output file size in megabytes
                processing_time_seconds:
                  type: integer
                  description: Total processing time
        jobs:
          type: array
          description: Detailed status of each CoreMachine job
          items:
            type: object
            properties:
              job_id:
                type: string
              job_type:
                type: string
              status:
                type: string
              stage:
                type: integer
              created_at:
                type: string
                format: date-time
              updated_at:
                type: string
                format: date-time
        job_statistics:
          type: object
          description: Summary statistics of jobs
          properties:
            total:
              type: integer
            completed:
              type: integer
            failed:
              type: integer
            processing:
              type: integer
            pending:
              type: integer
        urls:
          type: object
          description: Helpful URLs for job monitoring
          properties:
            jobs:
              type: array
              items:
                type: string
                format: uri-reference
        created_at:
          type: string
          format: date-time
          description: Request creation timestamp (UTC)
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp (UTC)

    RequestListResponse:
      type: object
      required:
        - success
        - count
        - requests
      properties:
        success:
          type: boolean
          example: true
        count:
          type: integer
          description: Number of requests returned
          example: 3
        requests:
          type: array
          items:
            type: object
            properties:
              request_id:
                type: string
              dataset_id:
                type: string
              resource_id:
                type: string
              version_id:
                type: string
              data_type:
                type: string
              status:
                type: string
              job_count:
                type: integer
                description: Number of CoreMachine jobs for this request
              created_at:
                type: string
                format: date-time
              updated_at:
                type: string
                format: date-time

    ErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Human-readable error message
          example: "Field 'dataset_id' is required"
        error_type:
          type: string
          description: Error classification
          example: "ValidationError"

    # =========================================================================
    # OGC Features Schemas
    # =========================================================================

    OGCLandingPage:
      type: object
      properties:
        title:
          type: string
          example: "OGC API - Features"
        description:
          type: string
        links:
          type: array
          items:
            $ref: '#/components/schemas/Link'

    OGCConformance:
      type: object
      properties:
        conformsTo:
          type: array
          items:
            type: string
          example:
            - "http://www.opengis.net/spec/ogcapi-features-1/1.0/conf/core"
            - "http://www.opengis.net/spec/ogcapi-features-1/1.0/conf/geojson"

    OGCCollectionList:
      type: object
      properties:
        collections:
          type: array
          items:
            $ref: '#/components/schemas/OGCCollection'
        links:
          type: array
          items:
            $ref: '#/components/schemas/Link'

    OGCCollection:
      type: object
      properties:
        id:
          type: string
          description: Collection identifier (table name)
        title:
          type: string
        description:
          type: string
        extent:
          type: object
          properties:
            spatial:
              type: object
              properties:
                bbox:
                  type: array
                  items:
                    type: array
                    items:
                      type: number
            temporal:
              type: object
              properties:
                interval:
                  type: array
                  items:
                    type: array
                    items:
                      type: string
        links:
          type: array
          items:
            $ref: '#/components/schemas/Link'

    GeoJSONFeatureCollection:
      type: object
      properties:
        type:
          type: string
          enum: [FeatureCollection]
        features:
          type: array
          items:
            $ref: '#/components/schemas/GeoJSONFeature'
        numberReturned:
          type: integer
          description: Number of features in this response
        numberMatched:
          type: integer
          description: Total features matching query
        links:
          type: array
          items:
            $ref: '#/components/schemas/Link'

    GeoJSONFeature:
      type: object
      properties:
        type:
          type: string
          enum: [Feature]
        id:
          oneOf:
            - type: string
            - type: integer
        geometry:
          type: object
          description: GeoJSON geometry object
        properties:
          type: object
          additionalProperties: true

    Link:
      type: object
      properties:
        href:
          type: string
          format: uri
        rel:
          type: string
        type:
          type: string
        title:
          type: string

    # =========================================================================
    # STAC Schemas
    # =========================================================================

    STACCatalog:
      type: object
      properties:
        type:
          type: string
          enum: [Catalog]
        stac_version:
          type: string
          example: "1.0.0"
        id:
          type: string
        title:
          type: string
        description:
          type: string
        links:
          type: array
          items:
            $ref: '#/components/schemas/Link'
        conformsTo:
          type: array
          items:
            type: string

    STACConformance:
      type: object
      properties:
        conformsTo:
          type: array
          items:
            type: string
          example:
            - "https://api.stacspec.org/v1.0.0/core"
            - "https://api.stacspec.org/v1.0.0/collections"
            - "https://api.stacspec.org/v1.0.0/ogcapi-features"

    STACCollectionList:
      type: object
      properties:
        collections:
          type: array
          items:
            $ref: '#/components/schemas/STACCollection'
        links:
          type: array
          items:
            $ref: '#/components/schemas/Link'

    STACCollection:
      type: object
      description: |
        STAC Collection representing a group of related items.
        For rasters, typically groups COGs from same dataset.
        For vectors, typically groups related PostGIS tables.
      properties:
        type:
          type: string
          enum: [Collection]
        stac_version:
          type: string
        id:
          type: string
          description: Collection identifier (maps to dataset_id)
        title:
          type: string
        description:
          type: string
        license:
          type: string
        extent:
          type: object
          properties:
            spatial:
              type: object
              properties:
                bbox:
                  type: array
                  items:
                    type: array
                    items:
                      type: number
            temporal:
              type: object
              properties:
                interval:
                  type: array
                  items:
                    type: array
                    items:
                      type: string
                      nullable: true
        links:
          type: array
          items:
            $ref: '#/components/schemas/Link'

    STACItemCollection:
      type: object
      properties:
        type:
          type: string
          enum: [FeatureCollection]
        features:
          type: array
          items:
            $ref: '#/components/schemas/STACItem'
        links:
          type: array
          items:
            $ref: '#/components/schemas/Link'
        numberReturned:
          type: integer
        numberMatched:
          type: integer

    STACItem:
      type: object
      description: |
        STAC Item representing a single spatiotemporal asset.

        **For Rasters:**
        - `assets.data.href`: COG URL in silver-cogs container
        - `assets.data.type`: "image/tiff; application=geotiff; profile=cloud-optimized"
        - Properties include band info, CRS, resolution

        **For Vectors:**
        - `assets.data.href`: OGC Features API URL
        - `assets.data.type`: "application/geo+json"
        - Properties include feature count, geometry type
      properties:
        type:
          type: string
          enum: [Feature]
        stac_version:
          type: string
        stac_extensions:
          type: array
          items:
            type: string
        id:
          type: string
          description: Item ID (format dataset_id-resource_id-version_id)
        geometry:
          type: object
          description: GeoJSON geometry (bounding polygon)
        bbox:
          type: array
          items:
            type: number
          minItems: 4
          maxItems: 4
          description: Bounding box [minx, miny, maxx, maxy]
        properties:
          type: object
          description: Item properties including datetime, created, updated
          properties:
            datetime:
              type: string
              format: date-time
              description: Acquisition or creation datetime
            created:
              type: string
              format: date-time
            updated:
              type: string
              format: date-time
            platform:
              type: string
              description: Data source platform
            gsd:
              type: number
              description: Ground sample distance (meters)
          additionalProperties: true
        links:
          type: array
          items:
            $ref: '#/components/schemas/Link'
        assets:
          type: object
          description: Asset dictionary keyed by asset role
          additionalProperties:
            $ref: '#/components/schemas/STACAsset'
        collection:
          type: string
          description: Parent collection ID

    STACAsset:
      type: object
      description: |
        STAC Asset representing a downloadable file.

        **Common Asset Keys:**
        - `data`: Primary data file (COG, Zarr, or GeoJSON URL)
        - `thumbnail`: Preview image
        - `metadata`: Sidecar metadata file
      properties:
        href:
          type: string
          format: uri
          description: Asset URL
        type:
          type: string
          description: Media type
          example: "image/tiff; application=geotiff; profile=cloud-optimized"
        title:
          type: string
        description:
          type: string
        roles:
          type: array
          items:
            type: string
          example: ["data", "visual"]

    # =========================================================================
    # Raster API Schemas
    # =========================================================================

    RasterPointResponse:
      type: object
      description: Response from raster point query
      properties:
        collection:
          type: string
        item:
          type: string
        location:
          type: object
          properties:
            lon:
              type: number
            lat:
              type: number
            name:
              type: string
              description: Named location if used
        values:
          type: array
          items:
            type: number
          description: Pixel values for each band
        band_names:
          type: array
          items:
            type: string
          description: Band names if available
        units:
          type: string
          description: Data units if known
