<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Health Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        /* Navigation */
        .nav {
            background: #333;
            padding: 12px 20px;
            margin: -20px -20px 20px -20px;
        }

        .nav a {
            color: white;
            text-decoration: none;
            margin-right: 20px;
            font-size: 14px;
        }

        .nav a:hover {
            text-decoration: underline;
        }

        .nav a.active {
            font-weight: bold;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            font-size: 24px;
            color: #333;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-refresh {
            background: #3388ff;
            color: white;
        }

        .btn-refresh:hover {
            background: #2266dd;
        }

        .btn-refresh:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .auto-refresh-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #666;
        }

        .last-updated {
            font-size: 12px;
            color: #888;
        }

        /* Overall Status Banner */
        .status-banner {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-banner.healthy {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .status-banner.unhealthy {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .status-banner.loading {
            background: #fff3cd;
            border: 1px solid #ffeeba;
        }

        .status-banner .status-icon {
            font-size: 28px;
        }

        .status-banner .status-text {
            font-size: 18px;
            font-weight: 600;
        }

        .status-banner.healthy .status-text { color: #155724; }
        .status-banner.unhealthy .status-text { color: #721c24; }
        .status-banner.loading .status-text { color: #856404; }

        .status-banner .error-summary {
            margin-left: auto;
            font-size: 13px;
            color: #721c24;
        }

        /* Components Grid */
        .components-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 16px;
        }

        .component-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .component-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .component-header:hover {
            background: #f9f9f9;
        }

        .component-status {
            font-size: 20px;
        }

        .component-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            flex: 1;
        }

        .component-summary {
            font-size: 12px;
            color: #666;
            max-width: 200px;
            text-align: right;
        }

        .component-toggle {
            color: #999;
            font-size: 12px;
            transition: transform 0.2s;
        }

        .component-card.expanded .component-toggle {
            transform: rotate(180deg);
        }

        .component-details {
            display: none;
            padding: 12px 16px;
            background: #fafafa;
            border-top: 1px solid #eee;
        }

        .component-card.expanded .component-details {
            display: block;
        }

        .component-details pre {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Errors Section */
        .errors-section {
            margin-top: 20px;
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 16px;
        }

        .errors-section h3 {
            color: #c53030;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .errors-section ul {
            list-style: none;
            padding: 0;
        }

        .errors-section li {
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 13px;
            color: #742a2a;
            border-left: 3px solid #fc8181;
        }

        /* Environment Info */
        .env-info {
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .env-info h3 {
            font-size: 14px;
            color: #333;
            margin-bottom: 12px;
        }

        .env-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .env-item {
            font-size: 12px;
        }

        .env-item .label {
            color: #888;
        }

        .env-item .value {
            color: #333;
            font-family: monospace;
        }

        /* Loading State */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3388ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* JSON Syntax Highlighting (simple) */
        .json-key { color: #f92672; }
        .json-string { color: #a6e22e; }
        .json-number { color: #ae81ff; }
        .json-boolean { color: #66d9ef; }
        .json-null { color: #66d9ef; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <a href="./">Home</a>
        <a href="health" class="active">Health</a>
        <a href="storage">Storage</a>
        <a href="map">Map</a>
    </nav>

    <!-- Header -->
    <div class="header">
        <h1>System Health Dashboard</h1>
        <div class="header-controls">
            <span class="last-updated" id="last-updated">Never</span>
            <label class="auto-refresh-toggle">
                <input type="checkbox" id="auto-refresh" checked>
                Auto-refresh (30s)
            </label>
            <button class="btn-refresh" id="refresh-btn" onclick="loadHealth()">
                Refresh
            </button>
        </div>
    </div>

    <!-- Overall Status Banner -->
    <div class="status-banner loading" id="status-banner">
        <span class="status-icon">‚è≥</span>
        <span class="status-text">Loading...</span>
    </div>

    <!-- Errors Section (hidden by default) -->
    <div class="errors-section" id="errors-section" style="display: none;">
        <h3>Errors</h3>
        <ul id="errors-list"></ul>
    </div>

    <!-- Components Grid -->
    <div class="components-grid" id="components-grid">
        <!-- Populated by JavaScript -->
    </div>

    <!-- Environment Info -->
    <div class="env-info" id="env-info" style="display: none;">
        <h3>Environment</h3>
        <div class="env-grid" id="env-grid"></div>
    </div>

    <script src="common.js"></script>
    <script>
        // Auto-refresh timer
        let autoRefreshInterval = null;

        // Component descriptions for summary text
        const COMPONENT_DESCRIPTIONS = {
            'deployment_config': 'Tenant configuration',
            'app_mode': 'Application mode',
            'imports': 'Python modules',
            'storage_containers': 'Blob containers',
            'service_bus': 'Message queues',
            'tables': 'Azure Tables',
            'vault': 'Key Vault',
            'database_config': 'DB configuration',
            'database': 'PostgreSQL/PostGIS',
            'duckdb': 'Analytical engine',
            'vsi': 'Cloud raster streaming',
            'jobs': 'Job registry',
            'pgstac': 'STAC catalog',
            'system_reference_tables': 'Reference data',
            'table_metadata_registry': 'Vector metadata',
            'schema_summary': 'Database schemas'
        };

        /**
         * Determine emoji status for a component.
         */
        function getStatusEmoji(component) {
            const status = component.status?.toLowerCase() || '';
            const details = component.details || {};

            // Check for explicit disabled/deprecated states
            if (status === 'disabled' || status === 'deprecated' || status === 'not_installed') {
                return '‚ö´';
            }

            // Check for errors
            if (status === 'unhealthy' || status === 'error' || status === 'missing') {
                return 'üî¥';
            }

            // Check for warnings in details
            if (details.warnings && details.warnings.length > 0) {
                return 'üü°';
            }

            // Check for partial success states
            if (details.containers_missing > 0 || details.missing_columns?.length > 0) {
                return 'üü°';
            }

            // Default to healthy
            if (status === 'healthy' || status === 'success' || status === 'accessible' || status === 'exists') {
                return 'üü¢';
            }

            // Unknown status
            return '‚ö™';
        }

        /**
         * Generate summary text for a component.
         */
        function getComponentSummary(name, component) {
            const details = component.details || {};
            const status = component.status?.toLowerCase() || '';

            // Handle specific component types
            switch (name) {
                case 'imports':
                    const stats = details.statistics || {};
                    return `${stats.modules_loaded || 0}/${stats.modules_checked || 0} modules`;

                case 'service_bus':
                    const summary = details._summary || {};
                    return `${summary.accessible || 0}/${summary.total_queues || 0} queues`;

                case 'storage_containers':
                    const summ = details.summary || {};
                    return `${summ.containers_exist || 0}/${summ.total_containers_checked || 0} containers`;

                case 'jobs':
                    return `${details.total_jobs || 0} job types`;

                case 'pgstac':
                    if (!details.installed) return 'Not installed';
                    const counts = details.table_counts || {};
                    return `${counts.collections || 0} collections, ${counts.items || 0} items`;

                case 'database':
                    if (details.postgresql_version) {
                        return `PostgreSQL ${details.postgresql_version.split(' ')[0]}`;
                    }
                    return status;

                case 'schema_summary':
                    return `${details.total_tables || 0} tables`;

                case 'table_metadata_registry':
                    return `${details.row_count || 0} tables registered`;

                case 'app_mode':
                    return details.mode || 'unknown';

                case 'deployment_config':
                    return details.config_status || status;

                default:
                    if (status === 'disabled' || status === 'deprecated') {
                        return status;
                    }
                    return COMPONENT_DESCRIPTIONS[name] || status;
            }
        }

        /**
         * Syntax highlight JSON for display.
         */
        function highlightJSON(obj, indent = 2) {
            const json = JSON.stringify(obj, null, indent);
            return json
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
                .replace(/: "([^"]*)"([,\n])/g, ': <span class="json-string">"$1"</span>$2')
                .replace(/: (\d+)([,\n])/g, ': <span class="json-number">$1</span>$2')
                .replace(/: (true|false)([,\n])/g, ': <span class="json-boolean">$1</span>$2')
                .replace(/: (null)([,\n])/g, ': <span class="json-null">$1</span>$2');
        }

        /**
         * Toggle component details expansion.
         */
        function toggleComponent(cardElement) {
            cardElement.classList.toggle('expanded');
        }

        /**
         * Render the health data to the page.
         */
        function renderHealth(data) {
            // Update overall status banner
            const banner = document.getElementById('status-banner');
            const overallStatus = data.status || 'unknown';

            banner.className = 'status-banner ' + overallStatus;

            if (overallStatus === 'healthy') {
                banner.innerHTML = `
                    <span class="status-icon">üü¢</span>
                    <span class="status-text">HEALTHY</span>
                `;
            } else if (overallStatus === 'unhealthy') {
                banner.innerHTML = `
                    <span class="status-icon">üî¥</span>
                    <span class="status-text">UNHEALTHY</span>
                    <span class="error-summary">${data.errors?.length || 0} error(s)</span>
                `;
            } else {
                banner.innerHTML = `
                    <span class="status-icon">‚ö™</span>
                    <span class="status-text">${overallStatus.toUpperCase()}</span>
                `;
            }

            // Render errors section
            const errorsSection = document.getElementById('errors-section');
            const errorsList = document.getElementById('errors-list');

            if (data.errors && data.errors.length > 0) {
                errorsSection.style.display = 'block';
                errorsList.innerHTML = data.errors
                    .map(err => `<li>${err}</li>`)
                    .join('');
            } else {
                errorsSection.style.display = 'none';
            }

            // Render components grid
            const grid = document.getElementById('components-grid');
            const components = data.components || {};

            // Sort components: errors first, then warnings, then healthy
            const sortedComponents = Object.entries(components).sort((a, b) => {
                const order = { 'üî¥': 0, 'üü°': 1, 'üü¢': 2, '‚ö´': 3, '‚ö™': 4 };
                const aEmoji = getStatusEmoji(a[1]);
                const bEmoji = getStatusEmoji(b[1]);
                return (order[aEmoji] || 5) - (order[bEmoji] || 5);
            });

            grid.innerHTML = sortedComponents.map(([name, component]) => {
                const emoji = getStatusEmoji(component);
                const summary = getComponentSummary(name, component);

                return `
                    <div class="component-card" onclick="toggleComponent(this)">
                        <div class="component-header">
                            <span class="component-status">${emoji}</span>
                            <span class="component-name">${name}</span>
                            <span class="component-summary">${summary}</span>
                            <span class="component-toggle">‚ñº</span>
                        </div>
                        <div class="component-details">
                            <pre>${highlightJSON(component)}</pre>
                        </div>
                    </div>
                `;
            }).join('');

            // Render environment info
            const envInfo = document.getElementById('env-info');
            const envGrid = document.getElementById('env-grid');

            if (data.environment) {
                envInfo.style.display = 'block';
                envGrid.innerHTML = Object.entries(data.environment)
                    .map(([key, value]) => `
                        <div class="env-item">
                            <span class="label">${key}:</span>
                            <span class="value">${value}</span>
                        </div>
                    `)
                    .join('');
            }
        }

        /**
         * Load health data from API.
         */
        async function loadHealth() {
            const refreshBtn = document.getElementById('refresh-btn');
            const banner = document.getElementById('status-banner');

            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span class="loading-spinner"></span>';

            try {
                const data = await fetchAPI('/api/health');

                renderHealth(data);

                document.getElementById('last-updated').textContent =
                    'Updated: ' + formatTime();

            } catch (error) {
                console.error('Failed to load health:', error);

                banner.className = 'status-banner unhealthy';
                banner.innerHTML = `
                    <span class="status-icon">‚ùå</span>
                    <span class="status-text">FETCH ERROR</span>
                    <span class="error-summary">${error.message}</span>
                `;
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh';
            }
        }

        /**
         * Toggle auto-refresh.
         */
        function setupAutoRefresh() {
            const checkbox = document.getElementById('auto-refresh');

            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    autoRefreshInterval = setInterval(loadHealth, 30000);
                } else {
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                        autoRefreshInterval = null;
                    }
                }
            });

            // Start auto-refresh by default
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(loadHealth, 30000);
            }
        }

        // Initialize
        window.addEventListener('load', function() {
            console.log('Health Dashboard initialized');
            console.log('API Base URL:', API_BASE_URL);
            loadHealth();
            setupAutoRefresh();
        });
    </script>
</body>
</html>
