{# ============================================================================
   EVENT ROW COMPONENT
   ============================================================================
   Single event row for timeline display.

   Usage:
       {% include "components/_event_row.html" %}

   Context variables:
       event: Event object with:
           - event_id
           - event_type / event_type_display
           - event_status
           - timestamp / timestamp_display
           - task_id / task_id_short
           - stage
           - summary
           - duration_ms
           - error_message
           - event_data
   ============================================================================ #}

<div class="event-row event-status-{{ event.event_status }}"
     data-event-type="{{ event.event_type }}"
     data-event-id="{{ event.event_id }}">

    {# Status indicator dot #}
    <div class="event-indicator">
        {% if event.event_status == 'success' %}
            <span class="indicator-dot success" title="Success"></span>
        {% elif event.event_status == 'failure' %}
            <span class="indicator-dot failure" title="Failure"></span>
        {% elif event.event_status == 'warning' %}
            <span class="indicator-dot warning" title="Warning"></span>
        {% elif event.event_status == 'pending' %}
            <span class="indicator-dot pending" title="Pending"></span>
        {% else %}
            <span class="indicator-dot info" title="Info"></span>
        {% endif %}
    </div>

    {# Timestamp #}
    <div class="event-time" title="{{ event.timestamp }}">
        {{ event.timestamp_display }}
    </div>

    {# Event type badge #}
    <div class="event-type">
        <span class="event-type-badge {{ event.event_type }}">
            {{ event.event_type_display or event.event_type|replace('_', ' ')|title }}
        </span>
    </div>

    {# Summary text #}
    <div class="event-summary">
        {{ event.summary }}
        {% if event.duration_ms %}
            <span class="event-duration">({{ event.duration_ms }}ms)</span>
        {% endif %}
    </div>

    {# Task link (if task-level event) #}
    {% if event.task_id %}
    <div class="event-task">
        <a href="/interface/tasks?task_id={{ event.task_id }}" title="{{ event.task_id }}">
            {{ event.task_id_short }}
        </a>
    </div>
    {% else %}
    <div class="event-task"></div>
    {% endif %}

    {# Stage indicator #}
    {% if event.stage %}
    <div class="event-stage">
        S{{ event.stage }}
    </div>
    {% else %}
    <div class="event-stage"></div>
    {% endif %}

    {# Expandable details #}
    {% if event.event_data or event.error_message %}
    <button class="event-expand-btn"
            onclick="toggleEventDetails('{{ event.event_id }}')"
            title="Show details">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
    </button>
    {% endif %}
</div>

{# Expandable details panel #}
{% if event.event_data or event.error_message %}
<div class="event-details" id="event-details-{{ event.event_id }}" style="display: none;">
    {% if event.error_message %}
    <div class="event-error">
        <strong>Error:</strong>
        <pre>{{ event.error_message }}</pre>
    </div>
    {% endif %}

    {% if event.event_data %}
    <div class="event-data">
        <strong>Data:</strong>
        <pre>{{ event.event_data|tojson(indent=2) }}</pre>
    </div>
    {% endif %}

    {% if event.checkpoint_name %}
    <div class="event-checkpoint">
        <strong>Checkpoint:</strong> {{ event.checkpoint_name }}
        <a href="#" class="app-insights-link" title="View in Application Insights">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
        </a>
    </div>
    {% endif %}
</div>
{% endif %}

<script>
function toggleEventDetails(eventId) {
    const details = document.getElementById('event-details-' + eventId);
    const btn = details.previousElementSibling.querySelector('.event-expand-btn');

    if (details.style.display === 'none') {
        details.style.display = 'block';
        btn.classList.add('expanded');
    } else {
        details.style.display = 'none';
        btn.classList.remove('expanded');
    }
}
</script>
