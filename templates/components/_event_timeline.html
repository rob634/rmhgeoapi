{# ============================================================================
   EVENT TIMELINE COMPONENT
   ============================================================================
   Displays job execution events in a scrollable timeline.
   Uses HTMX for auto-refresh capability.

   Usage:
       {% include "components/_event_timeline.html" %}

   Context variables:
       job_id: Job ID for HTMX polling
       events: Initial events list (optional, will load via HTMX if not provided)
       auto_refresh: Enable auto-refresh (default: true)
       refresh_interval: Seconds between refreshes (default: 5)
       max_height: Maximum height before scroll (default: 400px)
   ============================================================================ #}

<div class="event-timeline-container">
    <div class="event-timeline-header">
        <h4>Event Timeline</h4>
        <div class="event-timeline-controls">
            <label class="toggle-label">
                <input type="checkbox"
                       id="auto-refresh-events-{{ job_id[:8] }}"
                       checked
                       onchange="toggleEventRefresh('{{ job_id }}', this.checked)">
                <span class="toggle-text">Live</span>
            </label>
            <select id="event-filter-{{ job_id[:8] }}" onchange="filterEventTimeline('{{ job_id }}', this.value)">
                <option value="all">All Events</option>
                <option value="job">Job Events</option>
                <option value="stage">Stage Events</option>
                <option value="task">Task Events</option>
                <option value="failure">Failures Only</option>
            </select>
            <button class="btn-icon" onclick="refreshEventTimeline('{{ job_id }}')" title="Refresh now">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="event-timeline"
         id="event-timeline-{{ job_id[:8] }}"
         style="max-height: {{ max_height|default('400px') }}"
         hx-get="/interface/jobs/{{ job_id }}/events/partial"
         hx-trigger="{{ 'load, every ' ~ (refresh_interval|default(5)) ~ 's' if auto_refresh|default(true) else 'load' }}"
         hx-swap="innerHTML"
         hx-indicator="#event-loading-{{ job_id[:8] }}">

        {% if events %}
            {% for event in events %}
                {% include "components/_event_row.html" %}
            {% endfor %}
        {% else %}
            <div class="timeline-loading" id="event-loading-{{ job_id[:8] }}">
                <div class="spinner"></div>
                <span>Loading events...</span>
            </div>
        {% endif %}
    </div>

    <div class="event-timeline-footer">
        <span class="event-count" id="event-count-{{ job_id[:8] }}">
            {% if events %}{{ events|length }} events{% endif %}
        </span>
        <a href="/api/jobs/{{ job_id }}/events" target="_blank" class="api-link">View API</a>
    </div>
</div>

<script>
function toggleEventRefresh(jobId, enabled) {
    const timeline = document.getElementById('event-timeline-' + jobId.substring(0, 8));
    if (enabled) {
        timeline.setAttribute('hx-trigger', 'load, every 5s');
    } else {
        timeline.setAttribute('hx-trigger', 'none');
    }
    htmx.process(timeline);
}

function refreshEventTimeline(jobId) {
    const timeline = document.getElementById('event-timeline-' + jobId.substring(0, 8));
    htmx.trigger(timeline, 'load');
}

function filterEventTimeline(jobId, filterType) {
    const timeline = document.getElementById('event-timeline-' + jobId.substring(0, 8));
    let url = '/interface/jobs/' + jobId + '/events/partial';

    if (filterType !== 'all') {
        url += '?filter=' + filterType;
    }

    timeline.setAttribute('hx-get', url);
    htmx.process(timeline);
    htmx.trigger(timeline, 'load');
}
</script>
