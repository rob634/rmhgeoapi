{# ============================================================================
   FAILURE CONTEXT COMPONENT
   ============================================================================
   Shows failure event and preceding events for debugging.
   Provides "last successful checkpoint" visibility.

   Usage:
       {% include "components/_failure_context.html" %}

   Context variables:
       job_id: Job ID
       failure_event: The failure event object
       preceding_events: List of events before failure
       has_failure: Boolean indicating if job has a failure
   ============================================================================ #}

{% if has_failure and failure_event %}
<div class="failure-context-panel">
    <div class="failure-header">
        <span class="failure-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
        </span>
        <span class="failure-title">
            {{ failure_event.event_type|replace('_', ' ')|title }}
            {% if failure_event.timestamp %}
            at {{ failure_event.timestamp[:19]|replace('T', ' ') }}
            {% endif %}
        </span>
        {% if failure_event.task_id %}
        <span class="failure-task">
            Task: <a href="/interface/tasks?task_id={{ failure_event.task_id }}">{{ failure_event.task_id[:8] }}...</a>
        </span>
        {% endif %}
    </div>

    {% if failure_event.error_message %}
    <div class="failure-message">
        <pre>{{ failure_event.error_message }}</pre>
    </div>
    {% endif %}

    {% if preceding_events %}
    <div class="failure-timeline">
        <h4>Events Before Failure <span class="count">({{ preceding_events|length }})</span></h4>
        <div class="failure-events-list">
            {% for event in preceding_events %}
            <div class="failure-event-row event-status-{{ event.event_status }}">
                <span class="indicator-dot {{ event.event_status }}"></span>
                <span class="event-time">{{ event.timestamp[:19]|replace('T', ' ') if event.timestamp else '' }}</span>
                <span class="event-type-badge {{ event.event_type }}">
                    {{ event.event_type|replace('_', ' ')|title }}
                </span>
                {% if event.task_id %}
                <span class="event-task-id">{{ event.task_id[:8] }}</span>
                {% endif %}
                {% if event.duration_ms %}
                <span class="event-duration">({{ event.duration_ms }}ms)</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="failure-actions">
        <button class="btn btn-secondary" onclick="copyFailureDetails('{{ job_id }}')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
            </svg>
            Copy Error
        </button>

        <a href="/api/jobs/{{ job_id }}/events/failure" target="_blank" class="btn btn-secondary">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
            View API
        </a>

        <a href="/interface/jobs/{{ job_id }}/events" class="btn btn-secondary">
            View All Events
        </a>

        {% if failure_event.checkpoint_name %}
        <a href="https://portal.azure.com/#@/resource/subscriptions/.../applicationInsights"
           target="_blank"
           class="btn btn-secondary">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 6v6l4 2"></path>
            </svg>
            App Insights
        </a>
        {% endif %}
    </div>
</div>

<script>
function copyFailureDetails(jobId) {
    const panel = document.querySelector('.failure-context-panel');
    const errorMessage = panel.querySelector('.failure-message pre');
    const errorText = errorMessage ? errorMessage.textContent : 'No error message';

    const details = `Job ID: ${jobId}
Error: ${errorText}
Timestamp: {{ failure_event.timestamp or 'Unknown' }}
Task ID: {{ failure_event.task_id or 'N/A' }}
Stage: {{ failure_event.stage or 'N/A' }}`;

    navigator.clipboard.writeText(details).then(() => {
        // Show feedback
        const btn = panel.querySelector('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';
        setTimeout(() => {
            btn.innerHTML = originalText;
        }, 2000);
    });
}
</script>

{% else %}
<div class="no-failure-panel">
    <div class="no-failure-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 11-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
    </div>
    <span>No failures detected for this job</span>
</div>
{% endif %}
