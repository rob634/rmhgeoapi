{# ============================================================================
   JOB CARD COMPONENT
   ============================================================================
   Displays a single job in the job list with status, progress, and events.

   Usage:
       {% include "components/_job_card.html" %}

   Context variables:
       job: Job object with fields:
           - job_id: Full job ID
           - job_type: Type of job
           - status: Current status (queued, processing, completed, failed)
           - current_stage: Current stage number
           - total_stages: Total number of stages
           - created_at: Creation timestamp
           - completed_at: Completion timestamp (optional)
           - event_count: Number of events (enriched)
           - has_failure: Boolean if job has failure events (enriched)
           - latest_event: Latest event object (enriched)
   ============================================================================ #}

<div class="job-card job-status-{{ job.status|lower }}">
    <div class="job-card-header">
        {# Status Badge #}
        <span class="status-badge status-{{ job.status|lower }}">
            {% if job.status|lower == 'processing' %}
                <span class="status-dot pulse"></span>
            {% endif %}
            {{ job.status|title }}
        </span>

        {# Job Type #}
        <span class="job-type">{{ job.job_type|replace('_', ' ')|title }}</span>

        {# Stage Progress #}
        {% if job.total_stages and job.total_stages > 1 %}
        <span class="job-stage">
            Stage {{ job.current_stage or 1 }}/{{ job.total_stages }}
        </span>
        {% endif %}
    </div>

    <div class="job-card-body">
        {# Job ID #}
        <div class="job-id">
            <a href="/interface/jobs/{{ job.job_id }}" title="{{ job.job_id }}">
                {{ job.job_id[:16] }}...
            </a>
        </div>

        {# Timestamps #}
        <div class="job-timestamps">
            <span class="job-created" title="{{ job.created_at }}">
                {{ job.created_at|replace('T', ' ')|truncate(19, True, '') }}
            </span>
            {% if job.completed_at %}
            <span class="job-duration">
                {% set duration = (job.completed_at - job.created_at).total_seconds() if job.completed_at and job.created_at else 0 %}
                {% if duration > 3600 %}
                    {{ (duration / 3600)|round(1) }}h
                {% elif duration > 60 %}
                    {{ (duration / 60)|round(1) }}m
                {% else %}
                    {{ duration|round(0)|int }}s
                {% endif %}
            </span>
            {% endif %}
        </div>

        {# Latest Event Summary #}
        {% if job.latest_event %}
        <div class="job-latest-event">
            <span class="event-type-badge {{ job.latest_event.event_type }}">
                {{ job.latest_event.event_type|replace('_', ' ')|title }}
            </span>
            {% if job.latest_event.summary %}
            <span class="event-summary-text">{{ job.latest_event.summary|truncate(40) }}</span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="job-card-footer">
        {# Event Count Badge #}
        <span class="event-count-badge {{ 'has-failure' if job.has_failure else '' }}">
            {% if job.has_failure %}
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
            {% else %}
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
            {% endif %}
            {{ job.event_count or 0 }} events
        </span>

        {# Actions #}
        <div class="job-actions">
            <a href="/interface/jobs/{{ job.job_id }}" class="btn btn-sm btn-secondary">
                Details
            </a>
            <a href="/interface/jobs/{{ job.job_id }}/events" class="btn btn-sm btn-primary">
                Events
            </a>
        </div>
    </div>

    {# Progress bar for processing jobs #}
    {% if job.status|lower == 'processing' and job.total_stages %}
    <div class="job-progress">
        <div class="job-progress-bar" style="width: {{ ((job.current_stage or 1) / job.total_stages * 100)|round(0) }}%"></div>
    </div>
    {% endif %}
</div>
