{# ============================================================================
   JOB TIMELINE SWIMLANE COMPONENT
   ============================================================================
   Displays job execution as horizontal swimlane with stage rows and task chips.
   V0.8 UI Update (27 JAN 2026)

   Usage:
       {% include "components/_job_timeline_swimlane.html" %}

   Context variables:
       job: Job record (optional, for header info)
       job_id: Job ID
       swimlane: Swimlane data structure from _build_swimlane_data()
           - status: 'pending'|'processing'|'completed'|'failed'
           - stages: List of stage dicts
           - stats: Summary statistics
       auto_refresh: Enable HTMX auto-refresh (default: true for processing jobs)
   ============================================================================ #}

{% set is_active = swimlane.status == 'processing' or swimlane.status == 'pending' %}

<div class="swimlane-container"
     id="swimlane-{{ job_id[:8] }}"
     {% if is_active %}
     hx-get="/interface/jobs/{{ job_id }}/events/swimlane"
     hx-trigger="every 5s"
     hx-swap="outerHTML"
     {% endif %}>
    {# Header with status badge #}
    <div class="swimlane-header swimlane-header-{{ swimlane.status }}">
        <div class="swimlane-title">
            <h3>{% if job and job.job_type %}{{ job.job_type|replace('_', ' ')|title }}{% else %}Job Timeline{% endif %}</h3>
            <span class="swimlane-job-id">{{ job_id[:16] }}...</span>
        </div>
        <div class="swimlane-status-badge">
            <span class="swimlane-status-dot{% if swimlane.status == 'processing' %} pulse{% endif %}"></span>
            {{ swimlane.status|title }}
        </div>
    </div>

    {# Progress overview bar #}
    <div class="swimlane-progress">
        <div class="swimlane-stats">
            <div class="swimlane-stat">
                <span class="swimlane-stat-value{% if swimlane.status == 'completed' %} text-completed{% elif swimlane.status == 'failed' %} text-failed{% elif swimlane.status == 'processing' %} text-active{% endif %}">
                    {{ swimlane.stats.completed_stages }}/{{ swimlane.stats.total_stages }}
                </span>
                <span class="swimlane-stat-label">Stages</span>
            </div>
            <div class="swimlane-stat">
                <span class="swimlane-stat-value{% if swimlane.stats.failed_tasks > 0 %} text-failed{% elif swimlane.stats.completed_tasks == swimlane.stats.total_tasks and swimlane.stats.total_tasks > 0 %} text-completed{% elif swimlane.status == 'processing' %} text-active{% endif %}">
                    {{ swimlane.stats.completed_tasks }}/{{ swimlane.stats.total_tasks }}
                </span>
                <span class="swimlane-stat-label">Tasks</span>
            </div>
        </div>
        <div class="swimlane-stage-track">
            {% for stage in swimlane.stages %}
            <div class="swimlane-stage-dot stage-{{ stage.status }}" title="Stage {{ stage.number }}: {{ stage.name }}">
                {% if stage.status == 'completed' %}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                {% elif stage.status == 'failed' %}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                {% else %}
                {{ stage.number }}
                {% endif %}
            </div>
            {% if not loop.last %}
            <div class="swimlane-stage-line stage-line-{{ stage.status }}"></div>
            {% endif %}
            {% endfor %}
            {# Final completion indicator #}
            <div class="swimlane-stage-line stage-line-{% if swimlane.status == 'completed' %}completed{% elif swimlane.status == 'failed' %}failed{% else %}pending{% endif %}"></div>
            <div class="swimlane-stage-dot stage-{% if swimlane.status == 'completed' %}completed{% elif swimlane.status == 'failed' %}failed{% else %}pending{% endif %}" title="Job Complete">
                {% if swimlane.status == 'completed' %}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                {% elif swimlane.status == 'failed' %}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                {% else %}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                {% endif %}
            </div>
        </div>
    </div>

    {# Result banner for completed/failed jobs #}
    {% if swimlane.status == 'completed' %}
    <div class="swimlane-result-banner result-success">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <span>Job completed successfully</span>
        <span class="result-details">{{ swimlane.stats.completed_tasks }} tasks completed</span>
    </div>
    {% elif swimlane.status == 'failed' %}
    <div class="swimlane-result-banner result-failure">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
        <span>Job failed</span>
        <span class="result-details">{{ swimlane.stats.failed_tasks }} task(s) failed</span>
    </div>
    {% endif %}

    {# Swimlane rows - one per stage #}
    <div class="swimlane-body">
        {% for stage in swimlane.stages %}
        <div class="swimlane-row swimlane-row-{{ stage.status }}">
            {# Stage label column #}
            <div class="swimlane-row-label">
                <div class="swimlane-row-num stage-{{ stage.status }}">
                    {% if stage.status == 'completed' %}
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    {% elif stage.status == 'failed' %}
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    {% else %}
                    {{ stage.number }}
                    {% endif %}
                </div>
                <div class="swimlane-row-info">
                    <span class="swimlane-row-name">{{ stage.name|replace('_', ' ')|title }}</span>
                    <span class="swimlane-row-time">{% if stage.duration %}{{ stage.duration }}{% else %}--{% endif %}</span>
                </div>
            </div>

            {# Task flow column #}
            <div class="swimlane-task-flow">
                {% if stage.tasks %}
                    {% for task in stage.tasks %}
                    <div class="swimlane-task-chip task-{{ task.status }}"
                         title="{{ task.label }}{% if task.error_message %} - {{ task.error_message }}{% endif %}">
                        {# Status icon #}
                        {% if task.status == 'completed' or task.status == 'complete' %}
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        {% elif task.status == 'failed' or task.status == 'error' %}
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        {% elif task.has_started %}
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                        {% endif %}
                        <span class="task-label">{{ task.label }}</span>
                        {# Micro-dots showing event progression #}
                        <div class="task-micro-dots">
                            <span class="micro-dot{% if task.has_queued %} done{% endif %}" title="Queued"></span>
                            <span class="micro-dot{% if task.has_started %} done{% endif %}" title="Started"></span>
                            <span class="micro-dot{% if task.has_completed %} done{% elif task.has_failed %} failed{% endif %}" title="{% if task.has_failed %}Failed{% else %}Completed{% endif %}"></span>
                        </div>
                    </div>
                    {% if not loop.last %}
                    <span class="task-arrow">→</span>
                    {% endif %}
                    {% endfor %}

                    {# Stage done badge #}
                    {% if stage.status == 'completed' %}
                    <span class="task-arrow">→</span>
                    <div class="swimlane-done-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Done
                    </div>
                    {% endif %}
                {% else %}
                    <span class="swimlane-no-tasks">No tasks</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    {# Footer with legend #}
    <div class="swimlane-footer">
        <div class="swimlane-legend">
            <div class="legend-item"><span class="legend-dot pending"></span>Pending</div>
            <div class="legend-item"><span class="legend-dot active"></span>Active</div>
            <div class="legend-item"><span class="legend-dot completed"></span>Done</div>
            {% if swimlane.status == 'failed' %}
            <div class="legend-item"><span class="legend-dot failed"></span>Failed</div>
            {% endif %}
        </div>
        <div class="swimlane-micro-legend">
            <span class="micro-label">Event dots:</span>
            <span class="micro-dot-label">Q</span>ueued
            <span class="micro-dot-label">S</span>tarted
            <span class="micro-dot-label">C</span>ompleted
        </div>
    </div>
</div>
