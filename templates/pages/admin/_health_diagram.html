{# ============================================================================
   HEALTH DASHBOARD - ARCHITECTURE DIAGRAM (SVG)
   ============================================================================
   Interactive system architecture diagram with status indicators.

   Components show status dots that are updated by JavaScript when
   health data is loaded. Click on components to scroll to their
   detail cards.
   ============================================================================ #}

<div class="architecture-diagram" style="position: relative;">
    <h3>System Architecture</h3>
    <div id="diagram-tooltip" class="diagram-tooltip"></div>
    <div class="diagram-legend">
        <span class="legend-item"><span class="legend-dot healthy"></span> Healthy</span>
        <span class="legend-item"><span class="legend-dot warning"></span> Warning</span>
        <span class="legend-item"><span class="legend-dot unhealthy"></span> Unhealthy</span>
        <span class="legend-item"><span class="legend-dot unknown"></span> Unknown</span>
    </div>
    <svg viewBox="0 0 1100 580" class="arch-svg" id="arch-diagram">
        {# Definitions for icons and markers #}
        <defs>
            <marker id="arrowhead" markerWidth="7" markerHeight="4.9" refX="6.3" refY="2.45" orient="auto">
                <polygon points="0 0, 7 2.45, 0 4.9" fill="#0071BC"/>
            </marker>
            <marker id="arrowhead-grey" markerWidth="7" markerHeight="4.9" refX="6.3" refY="2.45" orient="auto">
                <polygon points="0 0, 7 2.45, 0 4.9" fill="#9CA3AF"/>
            </marker>
            <pattern id="funcapp-pattern" width="1" height="1">
                <rect width="100%" height="100%" fill="#FFC14D"/>
            </pattern>
        </defs>

        {# ETL Pipelines Box #}
        <rect x="510" y="195" width="295" height="282" rx="8" fill="#FAFBFC" stroke="#E1E4E8" stroke-width="1"/>
        <rect x="510" y="195" width="295" height="28" rx="8" fill="#0071BC"/>
        <rect x="510" y="215" width="295" height="8" fill="#0071BC"/>
        <text x="657" y="214" class="diagram-header-label">ETL Pipelines</text>

        {# ========== ROW 1: Platform API ========== #}
        <g class="component" id="comp-platform-api" data-component="platform_api" data-tooltip="">
            <rect x="30" y="320" width="100" height="60" rx="6" class="comp-box funcapp"/>
            <text x="80" y="345" class="comp-icon">&#x26A1;</text>
            <text x="80" y="365" class="comp-label">Platform API</text>
            <circle cx="120" cy="330" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        {# Arrow: Platform API -> Job Queues #}
        <path d="M 130 350 L 175 350" class="flow-arrow" marker-end="url(#arrowhead)"/>
        <text x="145" y="340" class="flow-label">Queue Job</text>

        {# ========== Job Queues (Service Bus) ========== #}
        <g class="component" id="comp-job-queues" data-component="service_bus" data-tooltip="">
            <rect x="180" y="320" width="100" height="60" rx="6" class="comp-box servicebus"/>
            <text x="230" y="345" class="comp-icon">&#x1F4E8;</text>
            <text x="230" y="365" class="comp-label">Job Queues</text>
            <circle cx="270" cy="330" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        {# Arrow: Job Queues -> Orchestrator #}
        <path d="M 280 350 L 325 350" class="flow-arrow" marker-end="url(#arrowhead)"/>
        <text x="295" y="340" class="flow-label">Trigger</text>

        {# ========== Orchestrator (Function App) ========== #}
        <g class="component" id="comp-orchestrator" data-component="orchestrator" data-tooltip="">
            <rect x="330" y="320" width="110" height="60" rx="6" class="comp-box funcapp"/>
            <text x="385" y="345" class="comp-icon">&#x26A1;</text>
            <text x="385" y="365" class="comp-label">Orchestrator</text>
            <circle cx="430" cy="330" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        {# Arrow: Orchestrator -> Job Tables #}
        <path d="M 385 380 L 385 510" class="flow-arrow" marker-end="url(#arrowhead)"/>
        <text x="395" y="445" class="flow-label">Update State</text>

        {# ========== Job Tables (PostgreSQL) ========== #}
        <g class="component" id="comp-job-tables" data-component="database" data-tooltip="">
            <rect x="335" y="510" width="100" height="60" rx="6" class="comp-box postgres"/>
            <text x="385" y="535" class="comp-icon">&#x1F418;</text>
            <text x="385" y="555" class="comp-label">Job Tables</text>
            <circle cx="425" cy="520" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        {# ========== Fan-out arrows from Orchestrator ========== #}
        <path d="M 440 340 L 520 265" class="flow-arrow" marker-end="url(#arrowhead)"/>
        <text x="460" y="290" class="flow-label">Fan-out</text>
        <path d="M 440 350 L 520 350" class="flow-arrow" marker-end="url(#arrowhead)"/>
        <path d="M 440 360 L 520 435" class="flow-arrow" marker-end="url(#arrowhead)"/>

        {# ========== PARALLEL TASK PATH ========== #}
        <g class="component" id="comp-parallel-queue" data-component="task_queue_parallel" data-tooltip="">
            <rect x="520" y="235" width="100" height="60" rx="6" class="comp-box servicebus"/>
            <text x="570" y="260" class="comp-icon">&#x1F4E8;</text>
            <text x="570" y="280" class="comp-label">Parallel Queue</text>
            <circle cx="610" cy="245" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        <path d="M 620 265 L 680 265" class="flow-arrow" marker-end="url(#arrowhead)"/>

        <g class="component" id="comp-io-worker" data-component="worker_io" data-tooltip="">
            <rect x="680" y="235" width="110" height="60" rx="6" class="comp-box funcapp"/>
            <text x="735" y="260" class="comp-icon">&#x26A1;</text>
            <text x="735" y="280" class="comp-label">I/O Optimized</text>
            <circle cx="780" cy="245" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        {# ========== COMPUTE TASK PATH ========== #}
        <g class="component" id="comp-compute-queue" data-component="task_queue_compute" data-tooltip="">
            <rect x="520" y="320" width="100" height="60" rx="6" class="comp-box servicebus"/>
            <text x="570" y="345" class="comp-icon">&#x1F4E8;</text>
            <text x="570" y="365" class="comp-label">Compute Queue</text>
            <circle cx="610" cy="330" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        <path d="M 620 350 L 680 350" class="flow-arrow" marker-end="url(#arrowhead)"/>

        <g class="component" id="comp-compute-worker" data-component="worker_compute" data-tooltip="">
            <rect x="680" y="320" width="110" height="60" rx="6" class="comp-box funcapp"/>
            <text x="735" y="345" class="comp-icon">&#x26A1;</text>
            <text x="735" y="365" class="comp-label">Compute Worker</text>
            <circle cx="780" cy="330" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        {# ========== LONG-RUNNING TASK PATH (Docker) ========== #}
        <g class="component" id="comp-long-queue" data-component="task_queue_long" data-tooltip="">
            <rect x="520" y="405" width="100" height="60" rx="6" class="comp-box servicebus"/>
            <text x="570" y="430" class="comp-icon">&#x1F4E8;</text>
            <text x="570" y="450" class="comp-label">Long Queue</text>
            <circle cx="610" cy="415" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        <path d="M 620 435 L 680 435" class="flow-arrow" marker-end="url(#arrowhead)"/>

        <g class="component" id="comp-container" data-component="worker_container" data-tooltip="">
            <rect x="680" y="405" width="110" height="60" rx="6" class="comp-box appservice"/>
            <text x="735" y="430" class="comp-icon">&#x1F433;</text>
            <text x="735" y="450" class="comp-label">Long Worker</text>
            <circle cx="780" cy="415" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        {# ========== TASK COMPLETION -> Task Tables ========== #}
        <path d="M 805 350 L 870 350 L 870 510" class="flow-arrow" marker-end="url(#arrowhead)"/>
        <text x="835" y="340" class="flow-label">Task Complete</text>

        <g class="component" id="comp-task-tables" data-component="database" data-tooltip="">
            <rect x="820" y="510" width="100" height="60" rx="6" class="comp-box postgres"/>
            <text x="870" y="535" class="comp-icon">&#x1F418;</text>
            <text x="870" y="555" class="comp-label">Task Tables</text>
            <circle cx="910" cy="520" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        {# ========== STATE PROGRESSION FEEDBACK ========== #}
        <path d="M 820 540 L 435 540" class="flow-arrow" marker-end="url(#arrowhead)" stroke-dasharray="5,3"/>
        <text x="610" y="555" class="flow-label">Last Task Triggers State Progression</text>

        {# ========== TOP ROW: TiTiler and OGC Features ========== #}
        <g class="component" id="comp-titiler" data-tooltip="">
            <rect x="685" y="5" width="100" height="60" rx="6" class="comp-box appservice"/>
            <text x="735" y="30" class="comp-icon">&#x1F433;</text>
            <text x="735" y="50" class="comp-label">TiTiler-pgstac</text>
            <circle cx="775" cy="15" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        <g class="component" id="comp-ogc-features" data-tooltip="">
            <rect x="820" y="5" width="100" height="60" rx="6" class="comp-box funcapp"/>
            <text x="870" y="30" class="comp-icon">&#x26A1;</text>
            <text x="870" y="50" class="comp-label">OGC Features</text>
            <circle cx="910" cy="15" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        {# ========== STORAGE ROW ========== #}
        <g class="component" id="comp-input-storage" data-component="storage_bronze" data-tooltip="">
            <rect x="520" y="95" width="100" height="60" rx="6" class="comp-box storage"/>
            <text x="570" y="120" class="comp-icon">&#x1F4E6;</text>
            <text x="570" y="140" class="comp-label">Input Data</text>
            <circle cx="610" cy="105" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        <g class="component" id="comp-output-storage" data-component="storage_silver" data-tooltip="">
            <rect x="685" y="95" width="100" height="60" rx="6" class="comp-box storage"/>
            <text x="735" y="120" class="comp-icon">&#x1F4E6;</text>
            <text x="735" y="140" class="comp-label">Output Data</text>
            <circle cx="775" cy="105" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        <g class="component" id="comp-output-tables" data-component="postgis" data-tooltip="">
            <rect x="820" y="95" width="100" height="60" rx="6" class="comp-box postgres"/>
            <text x="870" y="120" class="comp-icon">&#x1F418;</text>
            <text x="870" y="140" class="comp-label">PostGIS</text>
            <circle cx="910" cy="105" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        {# ========== ZARR/XARRAY COLUMN ========== #}
        <g class="component" id="comp-titiler-xarray" data-tooltip="">
            <rect x="955" y="5" width="100" height="60" rx="6" class="comp-box appservice"/>
            <text x="1005" y="30" class="comp-icon">&#x1F433;</text>
            <text x="1005" y="50" class="comp-label">TiTiler-xarray</text>
            <circle cx="1045" cy="15" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        <g class="component" id="comp-zarr-store" data-tooltip="">
            <rect x="955" y="95" width="100" height="60" rx="6" class="comp-box storage"/>
            <text x="1005" y="120" class="comp-icon">&#x1F4E6;</text>
            <text x="1005" y="140" class="comp-label">Zarr Store</text>
            <circle cx="1045" cy="105" r="8" class="status-indicator" data-status="unknown"/>
        </g>

        {# ========== CONNECTING ARROWS ========== #}
        <path d="M 1005 95 L 1005 65" class="flow-arrow" marker-end="url(#arrowhead)"/>
        <path d="M 735 95 L 735 65" class="flow-arrow" marker-end="url(#arrowhead)"/>
        <path d="M 870 95 L 870 65" class="flow-arrow" marker-end="url(#arrowhead)"/>
        <path d="M 570 155 L 570 195" class="flow-arrow" marker-end="url(#arrowhead)"/>
        <text x="580" y="178" class="flow-label-tiny">Read</text>
        <path d="M 735 195 L 735 155" class="flow-arrow" marker-end="url(#arrowhead)"/>
        <text x="745" y="178" class="flow-label-tiny">Write</text>
        <path d="M 805 225 L 870 225 L 870 155" class="flow-arrow" marker-end="url(#arrowhead)"/>
        <text x="875" y="190" class="flow-label-tiny">Write</text>
        <path d="M 870 225 L 1005 225 L 1005 155" class="flow-arrow" marker-end="url(#arrowhead)"/>
    </svg>
</div>
