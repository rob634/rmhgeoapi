{% extends "base.html" %}
{% from "components/macros.html" import status_badge, spinner, empty_state, card %}

{% block title %}Collections{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='css/collections.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    {# Header #}
    <header class="page-header">
        <div class="header-content">
            <div>
                <h1>Collections Browser</h1>
                <p class="subtitle">Browse STAC raster and OGC vector collections</p>
            </div>
            <div class="header-actions">
                <button onclick="loadCollections()" class="btn btn-primary" id="refresh-btn">
                    Refresh
                </button>
            </div>
        </div>
    </header>

    {# Filters #}
    <div class="filters-bar">
        <div class="search-box">
            <input type="text"
                   id="search-input"
                   placeholder="Search collections..."
                   oninput="filterCollections()">
            <span class="search-icon">&#x1F50D;</span>
        </div>

        <div class="filter-group">
            <label class="filter-label">Type:</label>
            <div class="filter-pills" id="type-filter">
                <button class="filter-pill active" data-type="all" onclick="setTypeFilter('all')">
                    All <span class="pill-count" id="count-all">0</span>
                </button>
                <button class="filter-pill" data-type="raster" onclick="setTypeFilter('raster')">
                    <span class="type-icon raster">&#x1F5BC;</span> Raster <span class="pill-count" id="count-raster">0</span>
                </button>
                <button class="filter-pill" data-type="vector" onclick="setTypeFilter('vector')">
                    <span class="type-icon vector">&#x1F4CD;</span> Vector <span class="pill-count" id="count-vector">0</span>
                </button>
            </div>
        </div>

        <div class="filter-group">
            <label class="filter-label">Source:</label>
            <div class="filter-pills" id="source-filter">
                <button class="filter-pill active" data-source="all" onclick="setSourceFilter('all')">
                    All
                </button>
                <button class="filter-pill" data-source="stac" onclick="setSourceFilter('stac')">
                    STAC
                </button>
                <button class="filter-pill" data-source="ogc" onclick="setSourceFilter('ogc')">
                    OGC
                </button>
            </div>
        </div>

        <div class="sort-control">
            <label class="filter-label">Sort:</label>
            <select id="sort-select" onchange="sortCollections()">
                <option value="title-asc">Title (A-Z)</option>
                <option value="title-desc">Title (Z-A)</option>
                <option value="items-desc">Item Count (High-Low)</option>
                <option value="items-asc">Item Count (Low-High)</option>
                <option value="type">Type</option>
            </select>
        </div>
    </div>

    {# Stats Banner #}
    <div class="stats-banner" id="stats-banner">
        <div class="stat-item">
            <div class="stat-value" id="stat-total">--</div>
            <div class="stat-label">Total Collections</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-raster">--</div>
            <div class="stat-label">Raster (STAC)</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-vector">--</div>
            <div class="stat-label">Vector (OGC)</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-items">--</div>
            <div class="stat-label">Total Items</div>
        </div>
    </div>

    {# Loading State #}
    <div id="loading-state" class="loading-state">
        <div class="spinner"></div>
        <p>Loading collections...</p>
    </div>

    {# Error State #}
    <div id="error-state" class="error-state hidden">
        <div class="error-icon">&#x26A0;</div>
        <h3>Failed to load collections</h3>
        <p id="error-message"></p>
        <button onclick="loadCollections()" class="btn btn-primary">Try Again</button>
    </div>

    {# Empty State #}
    <div id="empty-state" class="empty-state hidden">
        <div class="empty-icon">&#x1F4C2;</div>
        <h3>No Collections Found</h3>
        <p id="empty-message">No collections match your current filters.</p>
    </div>

    {# Collections Grid #}
    <div id="collections-grid" class="collections-grid hidden">
        {# Cards will be rendered by JavaScript #}
    </div>

    {# Collection Detail Modal #}
    <div id="collection-modal" class="modal-overlay hidden" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modal-title">Collection Details</h2>
                <button class="modal-close" onclick="closeCollectionModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                {# Detail content rendered by JavaScript #}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Configuration from server
    const STAC_API_URL = '{{ stac_api_url | default("/api/stac", true) }}';
    const OGC_API_URL = '{{ ogc_api_url | default("/api/features", true) }}';
    const TIPG_URL = '{{ tipg_url | default("", true) }}';
    const TITILER_URL = '{{ titiler_url | default("", true) }}';
</script>
<script src="{{ url_for('static', path='js/collections.js') }}"></script>
{% endblock %}
