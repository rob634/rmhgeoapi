{% extends "base.html" %}

{% block title %}Job Details - {{ job.job_id[:16] }}...{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/jobs.css">
<link rel="stylesheet" href="/static/css/events.css">
{% endblock %}

{% block content %}
<div class="container">
    {# Back Navigation #}
    <div class="back-nav">
        <a href="/interface/jobs" class="back-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Back to Job List
        </a>
    </div>

    {# Page Header #}
    <div class="dashboard-header">
        <div class="header-with-count">
            <div>
                <div class="header-title-row">
                    <h1>{{ job.job_type|replace('_', ' ')|title }}</h1>
                    <span class="status-badge status-{{ job.status|lower }} large">
                        {% if job.status|lower == 'processing' %}
                            <span class="status-dot pulse"></span>
                        {% endif %}
                        {{ job.status|title }}
                    </span>
                </div>
                <p class="subtitle">
                    <code>{{ job.job_id }}</code>
                </p>
            </div>
            <div class="page-actions">
                {% if job.status|lower in ['failed', 'completed_with_errors'] %}
                <button class="btn btn-primary" onclick="resubmitJob('{{ job.job_id }}')">
                    Resubmit
                </button>
                {% endif %}
                <a href="/interface/jobs/{{ job.job_id }}/events" class="btn btn-secondary">
                    Full Events
                </a>
                <a href="/api/jobs/status/{{ job.job_id }}" target="_blank" class="btn btn-secondary">
                    View API
                </a>
            </div>
        </div>
    </div>

    {# Stats Banner #}
    <div class="stats-banner">
        <div class="stat-item">
            <span class="stat-label">Created</span>
            <span class="stat-value">{{ job.created_at|replace('T', ' ')|truncate(19, True, '') if job.created_at else 'N/A' }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Duration</span>
            <span class="stat-value">
                {% if job.completed_at and job.created_at %}
                    {% set duration = (job.completed_at - job.created_at).total_seconds() %}
                    {% if duration > 3600 %}
                        {{ (duration / 3600)|round(1) }}h
                    {% elif duration > 60 %}
                        {{ (duration / 60)|round(1) }}m
                    {% else %}
                        {{ duration|round(0)|int }}s
                    {% endif %}
                {% elif job.status|lower == 'processing' %}
                    <span class="processing-indicator">In Progress...</span>
                {% else %}
                    N/A
                {% endif %}
            </span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Stage</span>
            <span class="stat-value highlight">{{ job.current_stage or 1 }}/{{ job.total_stages or '?' }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Events</span>
            <span class="stat-value">{{ summary.total_events if summary else 0 }}</span>
        </div>
    </div>

    {# Main Content Grid #}
    <div class="job-detail-grid">
        {# Left Column - Main Content #}
        <div class="job-detail-main">
            {# Job Parameters #}
            {% if job.parameters %}
            <div class="section-card collapsible">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3 class="section-title">Job Parameters</h3>
                    <svg class="collapse-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
                <div class="section-content">
                    <pre class="json-display">{{ job.parameters|tojson(indent=2) }}</pre>
                </div>
            </div>
            {% endif %}

            {# Stage Progress #}
            {% if stages %}
            <div class="section-card">
                <h3 class="section-title">Stage Progress</h3>
                <div class="stage-list">
                    {% for stage_num, stage_data in stages.items()|sort %}
                    <div class="stage-item {{ 'current' if stage_num == job.current_stage else '' }} {{ 'completed' if stage_data.completed == stage_data.total else '' }}">
                        <div class="stage-indicator">
                            {% if stage_data.completed == stage_data.total %}
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="8 12 11 15 16 9"></polyline>
                                </svg>
                            {% elif stage_num == job.current_stage %}
                                <span class="stage-dot pulse"></span>
                            {% else %}
                                <span class="stage-dot"></span>
                            {% endif %}
                        </div>
                        <div class="stage-info">
                            <span class="stage-name">Stage {{ stage_num }}</span>
                            <span class="stage-progress">
                                {{ stage_data.completed }}/{{ stage_data.total }} tasks
                                {% if stage_data.failed > 0 %}
                                    <span class="stage-failed">({{ stage_data.failed }} failed)</span>
                                {% endif %}
                            </span>
                        </div>
                        <div class="stage-bar">
                            <div class="stage-bar-fill {{ 'has-failed' if stage_data.failed > 0 else '' }}"
                                 style="width: {{ (stage_data.completed / stage_data.total * 100)|round(0) if stage_data.total > 0 else 0 }}%">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# Event Timeline #}
            <div class="section-card timeline-section">
                <h3 class="section-title">Event Timeline</h3>
                {% set auto_refresh = (job.status|lower == 'processing') %}
                {% set refresh_interval = 5 %}
                {% set max_height = "500px" %}
                {% include "components/_event_timeline.html" %}
            </div>
        </div>

        {# Right Column - Sidebar #}
        <div class="job-detail-sidebar">
            {# Failure Analysis #}
            {% if failure_context and failure_context.has_failure %}
            <div class="section-card">
                <h3 class="section-title">Failure Analysis</h3>
                {% with has_failure=failure_context.has_failure, failure_event=failure_context.failure_event, preceding_events=failure_context.preceding_events %}
                    {% include "components/_failure_context.html" %}
                {% endwith %}
            </div>
            {% elif job.status|lower == 'completed' %}
            <div class="success-panel">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="8 12 11 15 16 9"></polyline>
                </svg>
                <span>Job completed successfully</span>
            </div>
            {% endif %}

            {# Event Summary #}
            {% if summary and summary.by_type %}
            <div class="section-card">
                <h3 class="section-title">Event Summary</h3>
                <div class="type-list">
                    {% for event_type, count in summary.by_type.items() %}
                    <div class="type-item">
                        <span class="event-type-badge {{ event_type }}">{{ event_type|replace('_', ' ')|title }}</span>
                        <span class="type-count">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# Quick Links #}
            <div class="section-card">
                <h3 class="section-title">API Endpoints</h3>
                <div class="quick-links-list">
                    <a href="/api/jobs/status/{{ job.job_id }}" target="_blank" class="link-badge">
                        Job Status
                    </a>
                    <a href="/api/jobs/{{ job.job_id }}/events" target="_blank" class="link-badge">
                        All Events
                    </a>
                    <a href="/api/jobs/{{ job.job_id }}/events/summary" target="_blank" class="link-badge">
                        Event Summary
                    </a>
                    <a href="/api/dbadmin/tasks/{{ job.job_id }}" target="_blank" class="link-badge">
                        Task Details
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleSection(header) {
    const card = header.closest('.collapsible');
    card.classList.toggle('collapsed');
}

async function resubmitJob(jobId) {
    if (!confirm('Are you sure you want to resubmit this job?')) {
        return;
    }

    try {
        const response = await fetch('/api/jobs/resubmit/' + jobId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            alert('Job resubmitted successfully!\nNew Job ID: ' + data.job_id);
            window.location.href = '/interface/jobs/' + data.job_id;
        } else {
            const error = await response.json();
            alert('Failed to resubmit job: ' + (error.message || error.error || 'Unknown error'));
        }
    } catch (e) {
        alert('Failed to resubmit job: ' + e.message);
    }
}
</script>
{% endblock %}
