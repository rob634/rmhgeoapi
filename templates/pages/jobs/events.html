{% extends "base.html" %}

{% block title %}Job Events - {{ job_id[:16] }}...{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/events.css">
<link rel="stylesheet" href="/static/css/swimlane.css">
{% endblock %}

{% block content %}
<div class="container">
    {# Page Header - Using design system dashboard-header pattern #}
    <div class="dashboard-header">
        <div class="header-with-count">
            <div>
                <h1>Job Event Timeline</h1>
                <p class="subtitle">Job ID: <code>{{ job_id[:16] }}...</code></p>
            </div>
            <div class="page-actions">
                <a href="/interface/jobs/{{ job_id }}" class="btn btn-secondary">Job Details</a>
                <a href="/interface/home" class="btn btn-secondary">Dashboard</a>
            </div>
        </div>
    </div>

    {# Horizontal Swimlane Timeline (V0.8 UI - 27 JAN 2026) #}
    {% if swimlane and swimlane.stages %}
    {% include "components/_job_timeline_swimlane.html" %}
    {% endif %}

    {# Main Content Grid #}
    <div class="events-grid">
        {# Left Column - Traditional Event List (collapsible) #}
        <div class="events-timeline-column">
            <details class="events-details" open>
                <summary class="events-summary">
                    <h4>Event Log</h4>
                    <span class="event-count-badge">{{ summary.total_events if summary else 0 }} events</span>
                </summary>
                {% set auto_refresh = true %}
                {% set refresh_interval = 5 %}
                {% set max_height = "400px" %}
                {% include "components/_event_timeline.html" %}
            </details>
        </div>

        {# Right Column - Failure Context and Stats #}
        <div class="events-context-column">
            {# Failure Analysis (shown first if there's a failure) #}
            {% if failure_context and failure_context.has_failure %}
            <div class="section-card section-card-failure">
                <h3 class="section-title">Failure Analysis</h3>
                {% with has_failure=failure_context.has_failure, failure_event=failure_context.failure_event, preceding_events=failure_context.preceding_events %}
                    {% include "components/_failure_context.html" %}
                {% endwith %}
            </div>
            {% endif %}

            {# Event Stats Summary #}
            {% if summary %}
            <div class="section-card">
                <h4 class="section-title">Event Summary</h4>
                <div class="event-stats-grid">
                    <div class="event-stat">
                        <span class="event-stat-value">{{ summary.total_events }}</span>
                        <span class="event-stat-label">Total Events</span>
                    </div>
                    <div class="event-stat">
                        <span class="event-stat-value text-success">{{ summary.by_status.get('success', 0) }}</span>
                        <span class="event-stat-label">Successful</span>
                    </div>
                    <div class="event-stat">
                        <span class="event-stat-value text-danger">{{ summary.by_status.get('failure', 0) }}</span>
                        <span class="event-stat-label">Failures</span>
                    </div>
                    <div class="event-stat">
                        <span class="event-stat-value">{{ (summary.total_duration_ms / 1000)|round(1) }}s</span>
                        <span class="event-stat-label">Total Duration</span>
                    </div>
                </div>
            </div>
            {% endif %}

            {# Event Type Breakdown #}
            {% if summary and summary.by_type %}
            <div class="section-card">
                <h4 class="section-title">Event Types</h4>
                <div class="type-list">
                    {% for event_type, count in summary.by_type.items() %}
                    <div class="type-item">
                        <span class="event-type-badge {{ event_type }}">{{ event_type|replace('_', ' ')|title }}</span>
                        <span class="type-count">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# Quick Links - API endpoints on Orchestrator (Function App) #}
            <div class="section-card">
                <h4 class="section-title">API Endpoints</h4>
                <div class="quick-links-list">
                    <a href="{{ orchestrator_url }}/api/jobs/{{ job_id }}/events" target="_blank" class="link-badge">
                        All Events
                    </a>
                    <a href="{{ orchestrator_url }}/api/jobs/{{ job_id }}/events/summary" target="_blank" class="link-badge">
                        Event Summary
                    </a>
                    <a href="{{ orchestrator_url }}/api/jobs/{{ job_id }}/events/failure" target="_blank" class="link-badge">
                        Failure Context
                    </a>
                    <a href="{{ orchestrator_url }}/api/jobs/status/{{ job_id }}" target="_blank" class="link-badge">
                        Job Status
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Page-specific styles - Using design system variables */

.page-actions {
    display: flex;
    gap: 8px;
}

/* Events Grid Layout */
.events-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-top: 20px;
}

.events-timeline-column {
    min-width: 0;
}

.events-context-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Collapsible Event Log */
.events-details {
    background: white;
    border: 1px solid var(--ds-gray-light, #e0e0e0);
    border-radius: 8px;
    overflow: hidden;
}

.events-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--ds-bg, #f5f7fa);
    cursor: pointer;
    user-select: none;
}

.events-summary::-webkit-details-marker {
    display: none;
}

.events-summary::before {
    content: 'â–¶';
    margin-right: 8px;
    font-size: 10px;
    transition: transform 0.2s;
}

.events-details[open] .events-summary::before {
    transform: rotate(90deg);
}

.events-summary h4 {
    margin: 0;
    font-size: 14px;
}

.event-count-badge {
    background: var(--ds-navy, #053657);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
}

/* Section Card - Consistent sidebar cards */
.section-card {
    background: white;
    border: 1px solid var(--ds-gray-light, #e0e0e0);
    border-left: 4px solid var(--ds-blue-primary, #245AAD);
    border-radius: 3px;
    padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.section-card-failure {
    border-left-color: var(--ds-status-failed-fg, #f44336);
}

.section-card .section-title {
    margin: 0 0 12px 0;
    padding-bottom: 8px;
    font-size: 14px;
}

/* Event Stats Grid */
.event-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.event-stat {
    text-align: center;
    padding: 8px;
    background: var(--ds-bg, #f5f7fa);
    border-radius: 4px;
}

.event-stat-value {
    display: block;
    font-size: 18px;
    font-weight: 700;
    color: var(--ds-navy, #053657);
}

.event-stat-value.text-success {
    color: var(--ds-status-completed-fg, #4CAF50);
}

.event-stat-value.text-danger {
    color: var(--ds-status-failed-fg, #f44336);
}

.event-stat-label {
    font-size: 10px;
    color: var(--ds-text-muted, #666);
    text-transform: uppercase;
}

/* Event Type Breakdown */
.type-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.type-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
}

.type-count {
    font-weight: 700;
    color: var(--ds-navy, #053657);
    font-size: 14px;
}

/* Quick Links - Using link-badge pattern */
.quick-links-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.quick-links-list .link-badge {
    flex: 1 1 calc(50% - 4px);
    min-width: 120px;
    justify-content: center;
}

/* Responsive */
@media (max-width: 1024px) {
    .events-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 600px) {
    .header-with-count {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }

    .page-actions {
        width: 100%;
    }

    .page-actions .btn {
        flex: 1;
        justify-content: center;
    }

    .quick-links-list .link-badge {
        flex: 1 1 100%;
    }

    .event-stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}
