{% extends "base.html" %}

{% block title %}Job Events - {{ job_id[:16] }}...{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/events.css">
{% endblock %}

{% block content %}
<div class="container">
    {# Page Header - Using design system dashboard-header pattern #}
    <div class="dashboard-header">
        <div class="header-with-count">
            <div>
                <h1>Job Event Timeline</h1>
                <p class="subtitle">Job ID: <code>{{ job_id[:16] }}...</code></p>
            </div>
            <div class="page-actions">
                <a href="/interface/home" class="btn btn-secondary">Dashboard</a>
                <a href="{{ orchestrator_url }}/api/jobs/{{ job_id }}/events" target="_blank" class="btn btn-secondary">
                    View API
                </a>
            </div>
        </div>
    </div>

    {# Summary Stats - Using design system stats-banner pattern #}
    {% if summary %}
    <div class="stats-banner">
        <div class="stat-item">
            <span class="stat-label">Total Events</span>
            <span class="stat-value highlight">{{ summary.total_events }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Successful</span>
            <span class="stat-value" style="color: var(--ds-status-completed-fg);">{{ summary.by_status.get('success', 0) }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Failures</span>
            <span class="stat-value" style="color: var(--ds-status-failed-fg);">{{ summary.by_status.get('failure', 0) }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Total Duration</span>
            <span class="stat-value">{{ (summary.total_duration_ms / 1000)|round(1) }}s</span>
        </div>
    </div>
    {% endif %}

    {# Main Content Grid #}
    <div class="events-grid">
        {# Left Column - Event Timeline #}
        <div class="events-timeline-column">
            {% set auto_refresh = true %}
            {% set refresh_interval = 5 %}
            {% set max_height = "600px" %}
            {% include "components/_event_timeline.html" %}
        </div>

        {# Right Column - Failure Context (if any) #}
        <div class="events-context-column">
            <div class="section-card">
                <h3 class="section-title">Failure Analysis</h3>
                {% with has_failure=failure_context.has_failure, failure_event=failure_context.failure_event, preceding_events=failure_context.preceding_events %}
                    {% include "components/_failure_context.html" %}
                {% endwith %}
            </div>

            {# Event Type Breakdown #}
            {% if summary and summary.by_type %}
            <div class="section-card">
                <h4 class="section-title">Event Types</h4>
                <div class="type-list">
                    {% for event_type, count in summary.by_type.items() %}
                    <div class="type-item">
                        <span class="event-type-badge {{ event_type }}">{{ event_type|replace('_', ' ')|title }}</span>
                        <span class="type-count">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# Quick Links - API endpoints on Orchestrator (Function App) #}
            <div class="section-card">
                <h4 class="section-title">API Endpoints</h4>
                <div class="quick-links-list">
                    <a href="{{ orchestrator_url }}/api/jobs/{{ job_id }}/events" target="_blank" class="link-badge">
                        All Events
                    </a>
                    <a href="{{ orchestrator_url }}/api/jobs/{{ job_id }}/events/summary" target="_blank" class="link-badge">
                        Event Summary
                    </a>
                    <a href="{{ orchestrator_url }}/api/jobs/{{ job_id }}/events/failure" target="_blank" class="link-badge">
                        Failure Context
                    </a>
                    <a href="{{ orchestrator_url }}/api/jobs/status/{{ job_id }}" target="_blank" class="link-badge">
                        Job Status
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Page-specific styles - Using design system variables */

.page-actions {
    display: flex;
    gap: 8px;
}

/* Events Grid Layout */
.events-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-top: 20px;
}

.events-timeline-column {
    min-width: 0;
}

.events-context-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Section Card - Consistent sidebar cards */
.section-card {
    background: white;
    border: 1px solid var(--ds-gray-light);
    border-left: 4px solid var(--ds-blue-primary);
    border-radius: 3px;
    padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.section-card .section-title {
    margin: 0 0 12px 0;
    padding-bottom: 8px;
}

/* Event Type Breakdown */
.type-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.type-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
}

.type-count {
    font-weight: 700;
    color: var(--ds-navy);
    font-size: 14px;
}

/* Quick Links - Using link-badge pattern */
.quick-links-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.quick-links-list .link-badge {
    flex: 1 1 calc(50% - 4px);
    min-width: 120px;
    justify-content: center;
}

/* Responsive */
@media (max-width: 1024px) {
    .events-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 600px) {
    .header-with-count {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }

    .page-actions {
        width: 100%;
    }

    .page-actions .btn {
        flex: 1;
        justify-content: center;
    }

    .quick-links-list .link-badge {
        flex: 1 1 100%;
    }
}
</style>
{% endblock %}
