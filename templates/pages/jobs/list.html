{% extends "base.html" %}

{% block title %}Job Monitor{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/jobs.css">
{% endblock %}

{% block content %}
<div class="container">
    {# Page Header #}
    <div class="dashboard-header">
        <div class="header-with-count">
            <div>
                <h1>Job Monitor</h1>
                <p class="subtitle">Track job execution and events</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-secondary" onclick="refreshJobList()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>
    </div>

    {# Filter Bar #}
    <div class="filter-bar">
        <div class="filter-group">
            <label class="filter-label">Status</label>
            <div class="filter-pills">
                <button class="filter-pill {{ 'active' if not filters.status else '' }}"
                        onclick="filterByStatus(null)">All</button>
                <button class="filter-pill {{ 'active' if filters.status == 'processing' else '' }}"
                        onclick="filterByStatus('processing')">Processing</button>
                <button class="filter-pill {{ 'active' if filters.status == 'completed' else '' }}"
                        onclick="filterByStatus('completed')">Completed</button>
                <button class="filter-pill {{ 'active' if filters.status == 'failed' else '' }}"
                        onclick="filterByStatus('failed')">Failed</button>
            </div>
        </div>

        <div class="filter-group">
            <label class="filter-label">Time Range</label>
            <select id="hours-filter" onchange="filterByHours(this.value)">
                <option value="24" {{ 'selected' if filters.hours == 24 else '' }}>Last 24 hours</option>
                <option value="168" {{ 'selected' if filters.hours == 168 else '' }}>Last 7 days</option>
                <option value="720" {{ 'selected' if filters.hours == 720 else '' }}>Last 30 days</option>
            </select>
        </div>

        <div class="filter-group filter-search">
            <label class="filter-label">Search</label>
            <input type="text" id="job-search" placeholder="Job ID..." oninput="debounceSearch(this.value)">
        </div>
    </div>

    {# Stats Summary #}
    {% if stats %}
    <div class="stats-banner">
        <div class="stat-item">
            <span class="stat-label">Total Jobs</span>
            <span class="stat-value highlight">{{ stats.total }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Processing</span>
            <span class="stat-value" style="color: var(--ds-status-processing-fg);">{{ stats.processing }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Completed</span>
            <span class="stat-value" style="color: var(--ds-status-completed-fg);">{{ stats.completed }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Failed</span>
            <span class="stat-value" style="color: var(--ds-status-failed-fg);">{{ stats.failed }}</span>
        </div>
    </div>
    {% endif %}

    {# Job List with HTMX auto-refresh #}
    <div class="job-list-container"
         id="job-list"
         hx-get="/interface/jobs/partial?status={{ filters.status or '' }}&hours={{ filters.hours or 24 }}"
         hx-trigger="load, every 10s"
         hx-swap="innerHTML"
         hx-indicator="#job-loading">

        {% if jobs %}
            {% for job in jobs %}
                {% include "components/_job_card.html" %}
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                    </svg>
                </div>
                <h3>No Jobs Found</h3>
                <p>No jobs match your current filters.</p>
            </div>
        {% endif %}
    </div>

    {# Loading indicator #}
    <div id="job-loading" class="htmx-indicator loading-overlay">
        <div class="spinner"></div>
        <span>Loading jobs...</span>
    </div>
</div>

<script>
// Filter functions
function filterByStatus(status) {
    const hours = document.getElementById('hours-filter').value;
    let url = '/interface/jobs?hours=' + hours;
    if (status) {
        url += '&status=' + status;
    }
    window.location.href = url;
}

function filterByHours(hours) {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('hours', hours);
    window.location.href = currentUrl.toString();
}

let searchTimeout;
function debounceSearch(value) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        if (value.length >= 8) {
            window.location.href = '/interface/jobs/' + value;
        }
    }, 500);
}

function refreshJobList() {
    const jobList = document.getElementById('job-list');
    htmx.trigger(jobList, 'load');
}

// Auto-pause refresh when tab is hidden
document.addEventListener('visibilitychange', function() {
    const jobList = document.getElementById('job-list');
    if (document.hidden) {
        jobList.setAttribute('hx-trigger', 'none');
    } else {
        jobList.setAttribute('hx-trigger', 'load, every 10s');
    }
    htmx.process(jobList);
});
</script>
{% endblock %}
