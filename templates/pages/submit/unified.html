{% extends "base.html" %}
{% from "components/macros.html" import status_badge, spinner, empty_state %}
{% from "components/form_macros.html" import text_input, textarea, select, checkbox, form_section, file_source_selector, curl_preview, submit_button, drop_zone, selected_file_display %}

{% block title %}Submit Data{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/submit.css">
{% endblock %}

{% block content %}
<div class="container">
    {# Header #}
    <header class="page-header">
        <div class="header-content">
            <div>
                <h1>Submit Geospatial Data</h1>
                <p class="subtitle">Upload raster or vector data to the Platform API</p>
            </div>
        </div>
    </header>

    <div class="submit-layout">
        {# Left Column: File Selection #}
        <div class="file-section">
            <div class="section-card">
                <div class="section-header">
                    <h2>1. Select Source File</h2>
                    <p class="section-subtitle">Choose a file from storage or upload a new one</p>
                </div>

                {# File Source Toggle #}
                {{ file_source_selector(selected="browse") }}

                {# Dynamic content area - HTMX will swap this #}
                <div id="file-source-content">
                    {% include "pages/submit/_file_browser.html" %}
                </div>

                {# Selected File Display (shows after selection) #}
                <div id="selected-file-section" class="selected-file-section hidden">
                    <div class="section-divider"></div>
                    <h3>Selected File</h3>
                    <div id="selected-file-display" class="selected-file-card">
                        <div class="file-icon" id="file-icon">
                            <svg viewBox="0 0 24 24" width="40" height="40"><path fill="currentColor" d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>
                        </div>
                        <div class="file-details">
                            <span class="file-name" id="display-file-name">--</span>
                            <span class="file-meta">
                                <span class="file-size" id="display-file-size">--</span>
                                <span class="file-separator">|</span>
                                <span class="file-type-text" id="display-file-type">--</span>
                            </span>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline" onclick="clearSelection()">Change</button>
                    </div>

                    {# Type-specific messages #}
                    <div id="file-type-messages">
                        {# ZIP file notice #}
                        <div id="zip-notice" class="type-notice type-notice-info hidden">
                            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                            <span>ZIP files must contain valid shapefiles (.shp, .shx, .dbf) only.</span>
                        </div>

                        {# Large file warning #}
                        <div id="size-warning" class="type-notice type-notice-warning hidden">
                            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
                            <span>Large file detected (>1GB). Consider using Docker processing mode.</span>
                        </div>
                    </div>

                    {# Detected Type Display #}
                    <div id="detected-type" class="detected-type">
                        <span class="detected-label">Detected Type:</span>
                        <span class="detected-value" id="detected-type-value">--</span>
                        <span class="detected-description" id="detected-type-description">--</span>
                    </div>
                </div>
            </div>
        </div>

        {# Right Column: Configuration Form #}
        <div class="form-section">
            <div class="section-card">
                <div class="section-header">
                    <h2>2. Configure Submission</h2>
                    <p class="section-subtitle">Set identifiers and processing options</p>
                </div>

                <form id="submit-form"
                      hx-post="/interface/submit/process"
                      hx-target="#submit-result"
                      hx-indicator="#submit-spinner">

                    {# Hidden fields for file reference #}
                    <input type="hidden" id="blob_name" name="blob_name" value="">
                    <input type="hidden" id="container_name" name="container_name" value="">
                    <input type="hidden" id="storage_zone" name="storage_zone" value="bronze">
                    <input type="hidden" id="file_extension" name="file_extension" value="">
                    <input type="hidden" id="file_size_mb" name="file_size_mb" value="">
                    <input type="hidden" id="data_type" name="data_type" value="">

                    {# DDH Identifiers Section #}
                    {% call form_section("DDH Identifiers", required=True) %}
                    {{ text_input("dataset_id", "Dataset ID", required=True,
                                  placeholder="e.g., flood-data-2024",
                                  pattern="[a-z0-9][a-z0-9-]*[a-z0-9]",
                                  title="Lowercase letters, numbers, hyphens. No leading/trailing hyphens.",
                                  hint="DDH dataset identifier (lowercase, hyphens allowed)") }}

                    <div class="form-row">
                        {{ text_input("resource_id", "Resource ID", required=True,
                                      placeholder="e.g., region-east",
                                      pattern="[a-z0-9][a-z0-9-]*[a-z0-9]",
                                      title="Lowercase letters, numbers, hyphens.",
                                      hint="DDH resource identifier") }}
                        {{ text_input("version_id", "Version ID", value="v1.0",
                                      placeholder="e.g., v1.0",
                                      hint="Version identifier (defaults to v1.0)") }}
                    </div>
                    {% endcall %}

                    {# Metadata Section #}
                    {% call form_section("Metadata") %}
                    {{ text_input("title", "Title",
                                  placeholder="Human-readable dataset title",
                                  hint="Optional - auto-generated from DDH IDs if not provided") }}

                    {{ textarea("description", "Description",
                                placeholder="Full dataset description",
                                rows=2) }}

                    <div class="form-row">
                        {{ select("access_level", "Access Level", options=[
                            ("", "Not specified"),
                            ("OUO", "OUO (Official Use Only)"),
                            ("PUBLIC", "PUBLIC"),
                            ("restricted", "Restricted")
                        ]) }}
                        {{ text_input("tags", "Tags",
                                      placeholder="e.g., flood, hazard, 2024",
                                      hint="Comma-separated tags") }}
                    </div>
                    {% endcall %}

                    {# CSV-specific fields (conditionally shown) #}
                    <div id="csv-fields" class="conditional-section hidden">
                        {% call form_section("CSV Geometry Configuration") %}
                        <p class="section-note">Specify how to extract geometry from CSV data</p>

                        <div class="form-row">
                            {{ text_input("lat_column", "Latitude Column",
                                          placeholder="e.g., lat, latitude, y",
                                          hint="Column containing latitude values") }}
                            {{ text_input("lon_column", "Longitude Column",
                                          placeholder="e.g., lon, longitude, x",
                                          hint="Column containing longitude values") }}
                        </div>

                        <div class="form-divider">
                            <span>OR</span>
                        </div>

                        {{ text_input("wkt_column", "WKT Column",
                                      placeholder="e.g., geometry, geom, wkt",
                                      hint="Column containing WKT geometry strings") }}
                        {% endcall %}
                    </div>

                    {# Raster-specific fields (conditionally shown) #}
                    <div id="raster-fields" class="conditional-section hidden">
                        {% call form_section("Raster Configuration") %}
                        <div class="form-row">
                            {{ select("raster_type", "Raster Type", options=[
                                ("auto", "Auto-detect"),
                                ("dem", "DEM (elevation)"),
                                ("rgb", "RGB imagery"),
                                ("rgba", "RGBA imagery"),
                                ("multispectral", "Multispectral"),
                                ("categorical", "Categorical (landcover)"),
                                ("nir", "Near-infrared")
                            ], hint="Auto-detect works for most files") }}

                            {{ select("output_tier", "Output Tier", options=[
                                ("analysis", "Analysis (LZW)"),
                                ("visualization", "Visualization (JPEG)"),
                                ("archive", "Archive (DEFLATE)")
                            ], hint="Analysis tier recommended") }}
                        </div>

                        {{ text_input("input_crs", "Input CRS (optional)",
                                      placeholder="e.g., EPSG:32618",
                                      hint="Override if source CRS is missing or wrong") }}

                        {{ text_input("collection_id", "STAC Collection ID", required=True,
                                      id="raster_collection_id",
                                      placeholder="e.g., aerial-imagery",
                                      pattern="[a-z0-9][a-z0-9-]*[a-z0-9]",
                                      hint="STAC collection to add the item to") }}
                        {% endcall %}
                    </div>

                    {# Processing Options #}
                    {% call form_section("Processing Options") %}
                    {{ checkbox("overwrite", "Allow overwrite if data exists",
                                hint="If enabled, existing data will be replaced",
                                onchange="updateCurlPreview()") }}

                    {# Docker toggle (shown for raster or large files) #}
                    <div id="docker-option" class="hidden">
                        <div class="form-group processing-mode-group">
                            <label>Processing Mode</label>
                            <div class="toggle-container">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="use_docker" name="use_docker" onchange="updateCurlPreview()">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="processing-mode-label" class="toggle-label">Function App (default)</span>
                            </div>
                            <span class="form-hint">Enable Docker for large files or complex projections</span>
                        </div>
                    </div>
                    {% endcall %}

                    {# cURL Preview #}
                    {{ curl_preview("curl-command") }}

                    <div class="submit-divider">
                        <span>OR submit directly</span>
                    </div>

                    {# Submit Button #}
                    {{ submit_button("Submit via Platform API", id="submit-btn", disabled=True) }}
                </form>

                {# Result Display #}
                <div id="submit-result" class="submit-result hidden"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Configuration from server
    const API_BASE_URL = '{{ api_base_url | default("/api", true) }}';
    const PLATFORM_API_URL = '{{ platform_api_url | default("/api/platform", true) }}';

    // File type definitions
    const FILE_TYPES = {
        // Raster types
        'tif': { category: 'raster', name: 'GeoTIFF', description: 'GeoTIFF raster image' },
        'tiff': { category: 'raster', name: 'GeoTIFF', description: 'GeoTIFF raster image' },
        'geotiff': { category: 'raster', name: 'GeoTIFF', description: 'GeoTIFF raster image' },
        'img': { category: 'raster', name: 'ERDAS IMG', description: 'ERDAS Imagine raster format' },
        'jp2': { category: 'raster', name: 'JPEG 2000', description: 'JPEG 2000 raster image' },
        'ecw': { category: 'raster', name: 'ECW', description: 'Enhanced Compression Wavelet' },
        'vrt': { category: 'raster', name: 'VRT', description: 'GDAL Virtual Format' },
        'nc': { category: 'raster', name: 'NetCDF', description: 'Network Common Data Form' },
        'hdf': { category: 'raster', name: 'HDF', description: 'Hierarchical Data Format' },
        'hdf5': { category: 'raster', name: 'HDF5', description: 'Hierarchical Data Format 5' },

        // Vector types
        'csv': { category: 'vector', name: 'CSV', description: 'Comma-separated values with geometry' },
        'geojson': { category: 'vector', name: 'GeoJSON', description: 'GeoJSON vector format' },
        'json': { category: 'vector', name: 'JSON', description: 'JSON file (may contain GeoJSON)' },
        'gpkg': { category: 'vector', name: 'GeoPackage', description: 'OGC GeoPackage vector format' },
        'kml': { category: 'vector', name: 'KML', description: 'Keyhole Markup Language' },
        'kmz': { category: 'vector', name: 'KMZ', description: 'Compressed KML archive' },
        'shp': { category: 'vector', name: 'Shapefile', description: 'ESRI Shapefile (requires .dbf, .shx)' },
        'zip': { category: 'vector', name: 'ZIP Archive', description: 'Zipped shapefile (must contain .shp, .shx, .dbf)' }
    };
</script>
<script src="/static/js/submit.js"></script>
{% endblock %}
