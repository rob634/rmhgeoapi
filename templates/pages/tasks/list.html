{% extends "base.html" %}
{% from "components/macros.html" import status_badge, spinner, empty_state %}

{% block title %}Task Monitor{% if job_id %} - {{ job_id[:16] }}...{% endif %}{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/tasks.css">
{% endblock %}

{% block content %}
<div class="container">
    {# Page Header #}
    <div class="dashboard-header">
        <div class="header-with-count">
            <div>
                <h1>Task Monitor</h1>
                <p class="subtitle">
                    {% if job_id %}
                        Job: <code>{{ job_id[:24] }}...</code>
                    {% else %}
                        Enter a Job ID to view its tasks
                    {% endif %}
                </p>
            </div>
            <div class="page-actions">
                {% if job_id %}
                <a href="/interface/jobs/{{ job_id }}" class="btn btn-secondary">View Job</a>
                <a href="/interface/jobs/{{ job_id }}/events" class="btn btn-secondary">Events</a>
                <a href="/api/dbadmin/tasks/{{ job_id }}" target="_blank" class="btn btn-secondary">API</a>
                {% endif %}
            </div>
        </div>
    </div>

    {# Job ID Input (shown if no job_id) #}
    {% if not job_id %}
    <div class="job-selector-card">
        <h3>Enter Job ID</h3>
        <form method="GET" action="/interface/tasks" class="job-selector-form">
            <input type="text"
                   name="job_id"
                   placeholder="Enter full job ID (64 characters)"
                   class="form-input job-id-input"
                   pattern="[a-f0-9]{64}"
                   title="Job ID must be a 64-character hex string"
                   required>
            <button type="submit" class="btn btn-primary">Load Tasks</button>
        </form>
        <p class="hint">Or select a job from the <a href="/interface/jobs">Job List</a></p>
    </div>
    {% else %}

    {# Job Info Banner #}
    {% if job %}
    <div class="stats-banner">
        <div class="stat-item">
            <span class="stat-label">Job Type</span>
            <span class="stat-value" style="font-size: 16px;">{{ job.job_type|replace('_', ' ')|title }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Status</span>
            <span class="stat-value">
                <span class="status-badge status-{{ job.status|lower }}">{{ job.status|title }}</span>
            </span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Current Stage</span>
            <span class="stat-value highlight">{{ job.stage or 1 }}/{{ job.total_stages or '?' }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Total Tasks</span>
            <span class="stat-value highlight">{{ tasks|length }}</span>
        </div>
    </div>
    {% endif %}

    {# Task Stats by Status #}
    {% if task_stats %}
    <div class="task-stats-bar">
        <div class="task-stat pending">
            <span class="task-stat-count">{{ task_stats.pending }}</span>
            <span class="task-stat-label">Pending</span>
        </div>
        <div class="task-stat queued">
            <span class="task-stat-count">{{ task_stats.queued }}</span>
            <span class="task-stat-label">Queued</span>
        </div>
        <div class="task-stat processing">
            <span class="task-stat-count">{{ task_stats.processing }}</span>
            <span class="task-stat-label">Processing</span>
        </div>
        <div class="task-stat completed">
            <span class="task-stat-count">{{ task_stats.completed }}</span>
            <span class="task-stat-label">Completed</span>
        </div>
        <div class="task-stat failed">
            <span class="task-stat-count">{{ task_stats.failed }}</span>
            <span class="task-stat-label">Failed</span>
        </div>
    </div>
    {% endif %}

    {# Tasks by Stage #}
    {% if tasks_by_stage %}
    <div class="stages-container"
         id="stages-container"
         hx-get="/interface/tasks/partial?job_id={{ job_id }}"
         hx-trigger="every 10s"
         hx-swap="innerHTML">
        {% for stage_num, stage_tasks in tasks_by_stage|dictsort %}
        <div class="stage-section">
            <div class="stage-header" onclick="toggleStage({{ stage_num }})">
                <div class="stage-title">
                    <span class="stage-icon">
                        {% set completed_count = stage_tasks|selectattr('status', 'equalto', 'completed')|list|length %}
                        {% set total_count = stage_tasks|length %}
                        {% if completed_count == total_count %}
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--ds-status-completed-fg)" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="8 12 11 15 16 9"></polyline>
                        </svg>
                        {% elif stage_tasks|selectattr('status', 'equalto', 'processing')|list|length > 0 %}
                        <span class="stage-dot pulse"></span>
                        {% else %}
                        <span class="stage-dot"></span>
                        {% endif %}
                    </span>
                    <span>Stage {{ stage_num }}</span>
                    <span class="stage-task-count">{{ stage_tasks|length }} tasks</span>
                </div>
                <div class="stage-progress">
                    {% set stage_completed = stage_tasks|selectattr('status', 'equalto', 'completed')|list|length %}
                    {% set stage_failed = stage_tasks|selectattr('status', 'equalto', 'failed')|list|length %}
                    <span class="progress-text">{{ stage_completed }}/{{ stage_tasks|length }}</span>
                    {% if stage_failed > 0 %}
                    <span class="failed-count">({{ stage_failed }} failed)</span>
                    {% endif %}
                    <svg class="collapse-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
            </div>

            <div class="stage-content" id="stage-{{ stage_num }}-content">
                <table class="tasks-table">
                    <thead>
                        <tr>
                            <th class="col-status">Status</th>
                            <th class="col-task-id">Task ID</th>
                            <th class="col-type">Type</th>
                            <th class="col-time">Created</th>
                            <th class="col-duration">Duration</th>
                            <th class="col-actions">Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in stage_tasks %}
                        <tr class="task-row task-status-{{ task.status|lower }}" data-task-id="{{ task.task_id }}">
                            <td class="col-status">
                                <span class="status-badge status-{{ task.status|lower }}">
                                    {% if task.status|lower == 'processing' %}
                                    <span class="status-dot pulse"></span>
                                    {% endif %}
                                    {{ task.status[:1]|upper }}
                                </span>
                            </td>
                            <td class="col-task-id">
                                <code title="{{ task.task_id }}">{{ task.task_id[:16] }}...</code>
                            </td>
                            <td class="col-type">{{ task.task_type|replace('_', ' ')|title }}</td>
                            <td class="col-time">{{ (task.created_at|string|replace('T', ' '))[:19] if task.created_at else 'N/A' }}</td>
                            <td class="col-duration">
                                {% if task.duration_ms %}
                                    {% if task.duration_ms > 60000 %}
                                        {{ (task.duration_ms / 60000)|round(1) }}m
                                    {% elif task.duration_ms > 1000 %}
                                        {{ (task.duration_ms / 1000)|round(1) }}s
                                    {% else %}
                                        {{ task.duration_ms }}ms
                                    {% endif %}
                                {% elif task.status|lower == 'processing' %}
                                    <span class="processing-indicator">Running...</span>
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                            <td class="col-actions">
                                <button class="btn btn-sm btn-secondary" onclick="toggleTaskDetails('{{ task.task_id }}')">
                                    View
                                </button>
                            </td>
                        </tr>
                        <tr class="task-details-row hidden" id="task-details-{{ task.task_id }}">
                            <td colspan="6">
                                <div class="task-details">
                                    <div class="detail-section">
                                        <h4>Task Information</h4>
                                        <div class="detail-grid">
                                            <div class="detail-item">
                                                <span class="detail-label">Full Task ID</span>
                                                <code class="detail-value">{{ task.task_id }}</code>
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">Handler</span>
                                                <span class="detail-value">{{ task.task_type }}</span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">Worker</span>
                                                <span class="detail-value">{{ task.worker_id[:16] if task.worker_id else 'Not assigned' }}...</span>
                                            </div>
                                        </div>
                                    </div>

                                    {% if task.parameters %}
                                    <div class="detail-section">
                                        <h4>Parameters</h4>
                                        <pre class="json-display">{{ task.parameters|tojson(indent=2) }}</pre>
                                    </div>
                                    {% endif %}

                                    {% if task.result %}
                                    <div class="detail-section">
                                        <h4>Result</h4>
                                        <pre class="json-display">{{ task.result|tojson(indent=2) }}</pre>
                                    </div>
                                    {% endif %}

                                    {% if task.error_message %}
                                    <div class="detail-section error-section">
                                        <h4>Error</h4>
                                        <pre class="error-display">{{ task.error_message }}</pre>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>

    {% elif tasks is defined and tasks|length == 0 %}
    <div class="empty-state">
        <div class="empty-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="9" x2="15" y2="15"></line>
                <line x1="15" y1="9" x2="9" y2="15"></line>
            </svg>
        </div>
        <h3>No Tasks Found</h3>
        <p>This job has no tasks yet. The job may still be initializing.</p>
    </div>
    {% endif %}

    {% endif %}
</div>

<script>
function toggleStage(stageNum) {
    const content = document.getElementById('stage-' + stageNum + '-content');
    const header = content.previousElementSibling;

    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        header.classList.remove('collapsed');
    } else {
        content.classList.add('collapsed');
        header.classList.add('collapsed');
    }
}

function toggleTaskDetails(taskId) {
    const detailsRow = document.getElementById('task-details-' + taskId);
    if (detailsRow) {
        detailsRow.classList.toggle('hidden');
    }
}

// Auto-pause refresh when tab is hidden
document.addEventListener('visibilitychange', function() {
    const container = document.getElementById('stages-container');
    if (container) {
        if (document.hidden) {
            container.setAttribute('hx-trigger', 'none');
        } else {
            container.setAttribute('hx-trigger', 'every 10s');
        }
        htmx.process(container);
    }
});
</script>
{% endblock %}
