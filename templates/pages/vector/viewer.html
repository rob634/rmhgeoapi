{% extends "base.html" %}

{% block title %}Vector Viewer - {{ collection_id or 'Select Collection' }}{% endblock %}

{% block head %}
<script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" rel="stylesheet" />
<link rel="stylesheet" href="/static/css/vector-viewer.css">
{% endblock %}

{% block content %}
<div class="viewer-container">
    {# Sidebar - 20% width #}
    <aside class="viewer-sidebar" id="sidebar">
        {# Header #}
        <div class="sidebar-header">
            <h1>Vector Curator</h1>
            <p class="subtitle">Data Quality Review</p>
        </div>

        {# Collection Selector (if no collection selected) #}
        {% if not collection_id %}
        <div class="sidebar-section">
            <div class="section-title">Select Collection</div>
            <div class="section-content">
                <select id="collection-select" class="form-select" onchange="loadCollection(this.value)">
                    <option value="">-- Choose a collection --</option>
                </select>
                <div id="collection-loading" class="loading-text">Loading collections...</div>
            </div>
        </div>
        {% else %}

        {# Collection Info #}
        <div class="sidebar-section">
            <div class="section-title">Collection</div>
            <div class="section-content">
                <div class="collection-name">{{ collection_id }}</div>
                <div class="collection-stats">
                    <span id="feature-count">--</span> features
                </div>
                <a href="/interface/vector/viewer" class="btn btn-sm btn-ghost">Change Collection</a>
            </div>
        </div>

        {# Layer Mode Toggle #}
        <div class="sidebar-section">
            <div class="section-title">Layer Mode</div>
            <div class="section-content">
                <div class="layer-mode-toggle">
                    <button class="mode-btn active" data-mode="mvt" onclick="setLayerMode('mvt')">
                        Vector Tiles
                        <span class="mode-hint">Fast rendering</span>
                    </button>
                    <button class="mode-btn" data-mode="geojson" onclick="setLayerMode('geojson')">
                        GeoJSON
                        <span class="mode-hint">Full attributes</span>
                    </button>
                </div>
                <div class="geojson-options hidden" id="geojson-options">
                    <label>Feature Limit</label>
                    <select id="geojson-limit" class="form-select" onchange="reloadGeoJSON()">
                        <option value="100">100 features</option>
                        <option value="500">500 features</option>
                        <option value="1000" selected>1,000 features</option>
                        <option value="5000">5,000 features</option>
                    </select>
                </div>
            </div>
        </div>

        {# Metadata Panel #}
        <div class="sidebar-section" id="metadata-section">
            <div class="section-title">Collection Metadata</div>
            <div class="section-content">
                <div class="metadata-grid" id="metadata-grid">
                    <div class="loading-text">Loading metadata...</div>
                </div>
            </div>
        </div>

        {# Style Controls #}
        <div class="sidebar-section" id="style-section">
            <div class="section-title">Styling</div>
            <div class="section-content">
                {# Fill Color #}
                <div class="control-group">
                    <label>Fill Color</label>
                    <div class="color-row">
                        <input type="color" id="fill-color" class="color-input" value="#0071BC" onchange="applyStyle()">
                        <input type="text" id="fill-color-hex" class="color-hex" value="#0071BC" onchange="syncColor('fill')">
                    </div>
                </div>

                {# Fill Opacity #}
                <div class="control-group">
                    <label>Fill Opacity: <span id="fill-opacity-value">0.4</span></label>
                    <input type="range" id="fill-opacity" class="slider-input" min="0" max="1" step="0.05" value="0.4" oninput="updateOpacity('fill')">
                </div>

                {# Stroke Color #}
                <div class="control-group">
                    <label>Stroke Color</label>
                    <div class="color-row">
                        <input type="color" id="stroke-color" class="color-input" value="#053657" onchange="applyStyle()">
                        <input type="text" id="stroke-color-hex" class="color-hex" value="#053657" onchange="syncColor('stroke')">
                    </div>
                </div>

                {# Stroke Width #}
                <div class="control-group">
                    <label>Stroke Width: <span id="stroke-width-value">1</span>px</label>
                    <input type="range" id="stroke-width" class="slider-input" min="0.5" max="5" step="0.5" value="1" oninput="updateStrokeWidth()">
                </div>

                {# Point Radius #}
                <div class="control-group">
                    <label>Point Radius: <span id="point-radius-value">6</span>px</label>
                    <input type="range" id="point-radius" class="slider-input" min="2" max="20" step="1" value="6" oninput="updatePointRadius()">
                </div>
            </div>
        </div>

        {# Feature Properties #}
        <div class="sidebar-section" id="properties-section">
            <div class="section-title">
                Feature Properties
                <span class="property-hint">(click feature on map)</span>
            </div>
            <div class="section-content">
                <div id="feature-properties" class="feature-properties">
                    <div class="empty-state">Click a feature to view properties</div>
                </div>
            </div>
        </div>

        {# Schema/Attributes #}
        <div class="sidebar-section" id="schema-section">
            <div class="section-title">
                Attributes
                <button class="btn-icon" onclick="toggleSchema()" title="Toggle attribute list">&#9776;</button>
            </div>
            <div class="section-content schema-content hidden" id="schema-content">
                <div id="attribute-list" class="attribute-list">
                    <div class="loading-text">Loading schema...</div>
                </div>
            </div>
        </div>

        {# QA Review #}
        <div class="sidebar-section" id="qa-section">
            <div class="section-title">QA Review</div>
            <div class="section-content">
                <div class="qa-status">
                    <span class="qa-label">Status:</span>
                    <span id="qa-status-badge" class="qa-badge pending">pending</span>
                </div>
                <div class="qa-actions">
                    <button class="btn btn-success" id="btn-approve" onclick="approveCollection()">
                        Approve
                    </button>
                    <button class="btn btn-danger" id="btn-reject" onclick="showRejectModal()">
                        Reject
                    </button>
                </div>
            </div>
        </div>

        {# API Links #}
        <div class="sidebar-section">
            <div class="section-title">API Links</div>
            <div class="section-content">
                <div class="api-links">
                    <a id="link-tilejson" href="#" target="_blank" class="api-link">TileJSON</a>
                    <a id="link-collection" href="#" target="_blank" class="api-link">Collection</a>
                    <a id="link-items" href="#" target="_blank" class="api-link">Items (GeoJSON)</a>
                    <a id="link-tipg-map" href="#" target="_blank" class="api-link">TiPG Map</a>
                </div>
            </div>
        </div>

        {% endif %}
    </aside>

    {# Map Container - 80% width #}
    <main class="viewer-map">
        <div id="map"></div>

        {# Map Status Overlay #}
        <div class="map-overlay map-status">
            <span id="map-zoom">Zoom: --</span>
            <span id="map-coords">--</span>
        </div>

        {# Loading Overlay #}
        <div class="map-overlay loading-overlay hidden" id="map-loading">
            <div class="spinner"></div>
            <span>Loading data...</span>
        </div>

        {# Layer Info #}
        <div class="map-overlay layer-info" id="layer-info">
            <div class="layer-name" id="layer-name">--</div>
            <div class="layer-details">
                <span>Mode: <strong id="layer-mode">MVT</strong></span>
                <span>Features: <strong id="visible-features">--</strong></span>
            </div>
        </div>
    </main>
</div>

{# Reject Modal #}
<div class="modal hidden" id="reject-modal">
    <div class="modal-backdrop" onclick="closeRejectModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Reject Collection</h3>
            <button class="modal-close" onclick="closeRejectModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Please provide a reason for rejection:</p>
            <textarea id="reject-reason" rows="4" placeholder="Enter rejection reason..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeRejectModal()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmReject()">Reject</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Configuration from server
    const CONFIG = {
        collectionId: {{ collection_id | tojson | safe if collection_id else 'null' }},
        tipgBase: {{ tipg_base_url | tojson | safe if tipg_base_url else '""' }},
        ogcFeaturesBase: '/api/features',
        initialBbox: {{ initial_bbox | tojson | safe if initial_bbox else 'null' }}
    };
</script>
<script src="/static/js/vector-viewer.js"></script>
{% endblock %}
